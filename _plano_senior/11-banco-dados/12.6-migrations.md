# üîÑ M√≥dulo 12.6: Database Migrations

> **Objetivo:** Dominar versionamento de schema com Flyway e Liquibase, garantindo zero-downtime deployments e rollbacks seguros.

---

## üìë √çndice

1. [Flyway vs Liquibase](#1-flyway-vs-liquibase)
2. [Flyway Setup](#2-flyway-setup)
3. [Liquibase Setup](#3-liquibase-setup)
4. [Best Practices](#4-best-practices)
5. [Zero-Downtime Migrations](#5-zero-downtime-migrations)
6. [Rollback Strategies](#6-rollback-strategies)
7. [Testing Migrations](#7-testing-migrations)

---

## 1. Flyway vs Liquibase

### 1.1 Compara√ß√£o

| Aspecto               | Flyway                           | Liquibase                           |
| --------------------- | -------------------------------- | ----------------------------------- |
| **Formato**           | SQL puro                         | SQL, XML, YAML, JSON                |
| **Curva Aprendizado** | Baixa (SQL familiar)             | M√©dia (DSL pr√≥prio)                 |
| **Abstra√ß√£o BD**      | N√£o (SQL espec√≠fico)             | Sim (database-agnostic)             |
| **Rollback**          | Manual (criar migration reversa) | Autom√°tico (changesets revers√≠veis) |
| **Precondi√ß√µes**      | N√£o                              | Sim (checksum, DB version, etc.)    |
| **Contextos**         | N√£o                              | Sim (dev, test, prod)               |
| **Community**         | Grande                           | Grande                              |
| **Licen√ßa**           | Open Source + Enterprise         | Open Source + Pro                   |

---

### 1.2 Quando Usar Cada Um

```java
/**
 * ‚úÖ USE FLYWAY quando:
 *
 * - Time prefere SQL puro (DBAs confort√°veis)
 * - Migrations simples e diretas
 * - Single database (PostgreSQL, MySQL, etc.)
 * - N√£o precisa rollback autom√°tico
 * - Prioriza simplicidade
 *
 * ‚úÖ USE LIQUIBASE quando:
 *
 * - Suporte multi-database (dev SQLite, prod PostgreSQL)
 * - Precondi√ß√µes complexas (condicional migrations)
 * - Rollback autom√°tico essencial
 * - Contextos diferentes (dev, staging, prod)
 * - Time prefere DSL declarativo (XML/YAML)
 */
```

---

## 2. Flyway Setup

### 2.1 Configura√ß√£o

```xml
<!-- pom.xml -->
<dependency>
    <groupId>org.flywaydb</groupId>
    <artifactId>flyway-core</artifactId>
</dependency>
<dependency>
    <groupId>org.flywaydb</groupId>
    <artifactId>flyway-database-postgresql</artifactId>
</dependency>
```

```yaml
# application.yml
spring:
  flyway:
    enabled: true
    locations: classpath:db/migration
    baseline-on-migrate: true # Habilita migration em BD existente
    baseline-version: 0
    validate-on-migrate: true # Valida checksums
    out-of-order: false # N√£o permite migrations fora de ordem
    clean-disabled: true # CR√çTICO: Desabilita clean em prod (deleta tudo!)
```

---

### 2.2 Estrutura de Arquivos

```
src/main/resources/
‚îî‚îÄ‚îÄ db/
    ‚îî‚îÄ‚îÄ migration/
        ‚îú‚îÄ‚îÄ V1__create_users_table.sql
        ‚îú‚îÄ‚îÄ V2__add_email_to_users.sql
        ‚îú‚îÄ‚îÄ V3__create_orders_table.sql
        ‚îî‚îÄ‚îÄ R__refresh_user_stats_view.sql
```

**Conven√ß√£o de Nomes:**

- `V{vers√£o}__{descri√ß√£o}.sql` - Versioned migration (roda 1x)
- `R__{descri√ß√£o}.sql` - Repeatable migration (roda sempre que mudar)
- Vers√£o: Num√©rica (`V1`, `V2`) ou datada (`V2025_01_15_10_30`)

---

### 2.3 Migrations B√°sicas

```sql
-- V1__create_users_table.sql

/**
 * Migration inicial: Criar tabela users
 *
 * ‚ö†Ô∏è SEMPRE incluir:
 * - IF NOT EXISTS (idempot√™ncia em dev)
 * - Coment√°rios explicando raz√£o da mudan√ßa
 * - NOT NULL constraints
 * - Indexes essenciais
 */
CREATE TABLE IF NOT EXISTS users (
    id BIGSERIAL PRIMARY KEY,
    email VARCHAR(255) NOT NULL UNIQUE,
    name VARCHAR(100) NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- √çndice para queries frequentes
CREATE INDEX idx_users_email ON users(email);

-- Coment√°rio na tabela (documenta√ß√£o)
COMMENT ON TABLE users IS 'User accounts with authentication';
COMMENT ON COLUMN users.email IS 'Unique email address for login';
```

```sql
-- V2__add_role_to_users.sql

/**
 * Adicionar coluna role com valor padr√£o
 *
 * ‚úÖ SAFE: Adicionar coluna nullable ou com default
 */
ALTER TABLE users
ADD COLUMN role VARCHAR(20) DEFAULT 'USER' NOT NULL;

-- √çndice se role for usado em queries
CREATE INDEX idx_users_role ON users(role);
```

```sql
-- V3__create_orders_table.sql

CREATE TABLE orders (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    total_amount DECIMAL(19, 2) NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'PENDING',
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),

    -- Foreign key com ON DELETE
    CONSTRAINT fk_orders_user FOREIGN KEY (user_id)
        REFERENCES users(id)
        ON DELETE CASCADE
);

CREATE INDEX idx_orders_user_id ON orders(user_id);
CREATE INDEX idx_orders_status ON orders(status);
```

---

### 2.4 Repeatable Migrations

```sql
-- R__refresh_user_stats_view.sql

/**
 * Repeatable migration: View que recalcula estat√≠sticas
 *
 * Roda sempre que arquivo mudar (checksum diferente)
 *
 * üí° USO: Views, functions, stored procedures
 */
DROP VIEW IF EXISTS user_stats;

CREATE OR REPLACE VIEW user_stats AS
SELECT
    u.id,
    u.name,
    u.email,
    COUNT(o.id) AS order_count,
    COALESCE(SUM(o.total_amount), 0) AS total_spent
FROM users u
LEFT JOIN orders o ON u.id = o.user_id
GROUP BY u.id, u.name, u.email;
```

---

## 3. Liquibase Setup

### 3.1 Configura√ß√£o

```xml
<!-- pom.xml -->
<dependency>
    <groupId>org.liquibase</groupId>
    <artifactId>liquibase-core</artifactId>
</dependency>
```

```yaml
# application.yml
spring:
  liquibase:
    enabled: true
    change-log: classpath:db/changelog/db.changelog-master.yaml
    contexts: dev,prod # Contextos ativos
    default-schema: public
```

---

### 3.2 Estrutura de Arquivos

```
src/main/resources/
‚îî‚îÄ‚îÄ db/
    ‚îî‚îÄ‚îÄ changelog/
        ‚îú‚îÄ‚îÄ db.changelog-master.yaml
        ‚îú‚îÄ‚îÄ changes/
        ‚îÇ   ‚îú‚îÄ‚îÄ v1_create_users.yaml
        ‚îÇ   ‚îú‚îÄ‚îÄ v2_add_role.yaml
        ‚îÇ   ‚îî‚îÄ‚îÄ v3_create_orders.yaml
        ‚îî‚îÄ‚îÄ data/
            ‚îî‚îÄ‚îÄ initial_data.yaml
```

---

### 3.3 Master Changelog

```yaml
# db.changelog-master.yaml

databaseChangeLog:
  - includeAll:
      path: db/changelog/changes
      relativeToChangelogFile: false
```

---

### 3.4 Changesets (YAML)

```yaml
# v1_create_users.yaml

databaseChangeLog:
  - changeSet:
      id: 1-create-users-table
      author: joao.silva
      comment: Create users table with authentication fields
      changes:
        - createTable:
            tableName: users
            columns:
              - column:
                  name: id
                  type: BIGINT
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: email
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: name
                  type: VARCHAR(100)
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP
                  defaultValueComputed: NOW()
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP
                  defaultValueComputed: NOW()
                  constraints:
                    nullable: false
        - createIndex:
            indexName: idx_users_email
            tableName: users
            columns:
              - column:
                  name: email
      rollback:
        - dropTable:
            tableName: users
```

```yaml
# v2_add_role.yaml

databaseChangeLog:
  - changeSet:
      id: 2-add-role-column
      author: joao.silva
      changes:
        - addColumn:
            tableName: users
            columns:
              - column:
                  name: role
                  type: VARCHAR(20)
                  defaultValue: USER
                  constraints:
                    nullable: false
        - createIndex:
            indexName: idx_users_role
            tableName: users
            columns:
              - column:
                  name: role
      rollback:
        - dropColumn:
            tableName: users
            columnName: role
```

---

### 3.5 Preconditions

```yaml
# Changeset com precondi√ß√µes

databaseChangeLog:
  - changeSet:
      id: 3-create-orders-table
      author: joao.silva
      preConditions:
        - onFail: MARK_RAN # Se falhar, marca como executado
        - tableExists:
            tableName: users
        - dbms:
            type: postgresql
      changes:
        - createTable:
            tableName: orders
            columns:
              - column:
                  name: id
                  type: BIGINT
                  autoIncrement: true
                  constraints:
                    primaryKey: true
              - column:
                  name: user_id
                  type: BIGINT
                  constraints:
                    nullable: false
                    foreignKeyName: fk_orders_user
                    references: users(id)
                    deleteCascade: true
              - column:
                  name: total_amount
                  type: DECIMAL(19, 2)
                  constraints:
                    nullable: false
```

---

### 3.6 Contexts

```yaml
# Dados apenas para dev

databaseChangeLog:
  - changeSet:
      id: seed-dev-data
      author: joao.silva
      context: dev # Roda apenas se context=dev ativo
      changes:
        - insert:
            tableName: users
            columns:
              - column:
                  name: email
                  value: admin@example.com
              - column:
                  name: name
                  value: Admin User
              - column:
                  name: role
                  value: ADMIN
```

---

## 4. Best Practices

### 4.1 Idempot√™ncia

```sql
-- ‚ùå N√ÉO idempotente (falha na segunda execu√ß√£o)
ALTER TABLE users ADD COLUMN phone VARCHAR(20);

-- ‚úÖ Idempotente (seguro re-executar)
ALTER TABLE users ADD COLUMN IF NOT EXISTS phone VARCHAR(20);

-- ‚úÖ Idempotente (Liquibase)
-- Liquibase rastreia execu√ß√µes automaticamente (n√£o precisa IF NOT EXISTS)
```

---

### 4.2 Backward Compatibility

```sql
-- ‚ùå PERIGOSO: Remover coluna (quebra app antiga)
ALTER TABLE users DROP COLUMN legacy_field;

-- ‚úÖ SAFE: Manter coluna nullable (deprecar gradualmente)
-- Migration 1: Adicionar nova coluna
ALTER TABLE users ADD COLUMN new_field VARCHAR(100);

-- Migration 2 (depois de deploy app): Popular nova coluna
UPDATE users SET new_field = legacy_field WHERE new_field IS NULL;

-- Migration 3 (depois de garantir app n√£o usa legacy): Remover
ALTER TABLE users DROP COLUMN legacy_field;
```

---

### 4.3 Performance em Produ√ß√£o

```sql
-- ‚ùå BLOQUEANTE: ALTER TABLE lock exclusivo
ALTER TABLE users ADD COLUMN phone VARCHAR(20) NOT NULL;

-- ‚úÖ OTIMIZADO: Adicionar nullable, popular depois
-- Step 1: Adicionar nullable
ALTER TABLE users ADD COLUMN phone VARCHAR(20);

-- Step 2: Popular em background (fora da migration)
-- Batch job ou script separado

-- Step 3: (Ap√≥s popular) Tornar NOT NULL
ALTER TABLE users ALTER COLUMN phone SET NOT NULL;
```

---

## 5. Zero-Downtime Migrations

### 5.1 Expand-Contract Pattern

```sql
/**
 * EXPAND-CONTRACT: Adicionar antes, remover depois
 *
 * Cen√°rio: Renomear coluna users.name ‚Üí users.full_name
 */

-- FASE 1 (Migration V10): EXPAND - Adicionar nova coluna
ALTER TABLE users ADD COLUMN full_name VARCHAR(100);

-- Popular nova coluna com dados existentes
UPDATE users SET full_name = name WHERE full_name IS NULL;

-- App vers√£o 2.0: Usa AMBAS colunas (l√™ de full_name, escreve em ambas)

-- FASE 2 (Migration V11 - ap√≥s deploy 100%): CONTRACT - Remover antiga
ALTER TABLE users DROP COLUMN name;

-- App vers√£o 2.1: Usa apenas full_name
```

---

### 5.2 Blue-Green Deployment

```sql
/**
 * BLUE-GREEN: Manter compatibilidade com 2 vers√µes do app
 *
 * Cen√°rio: Mudar tipo de coluna
 */

-- V20: Adicionar nova coluna com tipo correto
ALTER TABLE orders ADD COLUMN status_v2 VARCHAR(20);

-- Trigger tempor√°rio: Sincronizar mudan√ßas
CREATE OR REPLACE FUNCTION sync_order_status()
RETURNS TRIGGER AS $$
BEGIN
    NEW.status_v2 = NEW.status;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER sync_order_status_trigger
BEFORE INSERT OR UPDATE ON orders
FOR EACH ROW EXECUTE FUNCTION sync_order_status();

-- V21 (ap√≥s deploy): Remover coluna antiga e trigger
DROP TRIGGER sync_order_status_trigger ON orders;
DROP FUNCTION sync_order_status();
ALTER TABLE orders DROP COLUMN status;
ALTER TABLE orders RENAME COLUMN status_v2 TO status;
```

---

## 6. Rollback Strategies

### 6.1 Flyway Rollback (Manual)

```sql
-- V10__add_phone_to_users.sql (forward)
ALTER TABLE users ADD COLUMN phone VARCHAR(20);

-- U10__add_phone_to_users.sql (undo - conven√ß√£o pr√≥pria)
ALTER TABLE users DROP COLUMN phone;
```

```java
/**
 * Script para executar undo migration
 */
@Service
public class FlywayRollbackService {

    @Autowired
    private DataSource dataSource;

    /**
     * Executar undo migration manualmente
     *
     * ‚ö†Ô∏è N√ÉO √© nativo do Flyway (implementa√ß√£o customizada)
     */
    public void rollbackToVersion(String version) throws Exception {
        var undoScript = "U" + version + "*.sql";

        try (var conn = dataSource.getConnection();
             var stmt = conn.createStatement()) {

            var scriptContent = readUndoScript(undoScript);
            stmt.execute(scriptContent);

            // Deletar entrada no flyway_schema_history
            stmt.execute("DELETE FROM flyway_schema_history WHERE version = '" + version + "'");
        }
    }

    private String readUndoScript(String filename) {
        // Ler arquivo undo do classpath
        return "";
    }
}
```

---

### 6.2 Liquibase Rollback (Autom√°tico)

```bash
# Rollback para tag espec√≠fica
liquibase rollback version_1.0

# Rollback N changesets
liquibase rollbackCount 3

# Rollback para data espec√≠fica
liquibase rollbackToDate 2025-01-01

# Gerar SQL de rollback (sem executar)
liquibase rollbackSQL version_1.0
```

```yaml
# Changeset com rollback customizado

databaseChangeLog:
  - changeSet:
      id: 10-add-phone
      author: joao.silva
      changes:
        - addColumn:
            tableName: users
            columns:
              - column:
                  name: phone
                  type: VARCHAR(20)
      rollback:
        - dropColumn:
            tableName: users
            columnName: phone
```

---

## 7. Testing Migrations

### 7.1 Flyway Callback (Valida√ß√£o)

```java
/**
 * Callback para validar migrations
 */
@Component
public class FlywayValidationCallback implements Callback {

    @Override
    public boolean supports(Event event, Context context) {
        return event == Event.AFTER_MIGRATE;
    }

    @Override
    public boolean canHandleInTransaction(Event event, Context context) {
        return true;
    }

    @Override
    public void handle(Event event, Context context) {
        System.out.println("Validating migration success...");

        // Valida√ß√µes customizadas
        try (var conn = context.getConnection();
             var stmt = conn.createStatement()) {

            // Verificar se tabela foi criada
            var rs = stmt.executeQuery("SELECT COUNT(*) FROM users");
            if (rs.next()) {
                System.out.println("‚úÖ users table validated");
            }

        } catch (Exception e) {
            throw new RuntimeException("Migration validation failed", e);
        }
    }
}
```

---

### 7.2 Test com TestContainers

```java
/**
 * Teste de migrations com banco real
 */
@SpringBootTest
@Testcontainers
class MigrationTest {

    @Container
    static PostgreSQLContainer<?> postgres = new PostgreSQLContainer<>("postgres:15-alpine");

    @DynamicPropertySource
    static void datasourceProperties(DynamicPropertyRegistry registry) {
        registry.add("spring.datasource.url", postgres::getJdbcUrl);
        registry.add("spring.datasource.username", postgres::getUsername);
        registry.add("spring.datasource.password", postgres::getPassword);
    }

    @Autowired
    private JdbcTemplate jdbcTemplate;

    @Test
    void migrationsAppliedSuccessfully() {
        // Verificar se migrations rodaram
        var tables = jdbcTemplate.queryForList("""
            SELECT table_name
            FROM information_schema.tables
            WHERE table_schema = 'public'
            """, String.class);

        assertThat(tables).contains("users", "orders", "flyway_schema_history");
    }

    @Test
    void usersTableHasExpectedSchema() {
        var columns = jdbcTemplate.queryForList("""
            SELECT column_name, data_type
            FROM information_schema.columns
            WHERE table_name = 'users'
            """, Map.class);

        var columnNames = columns.stream()
            .map(col -> col.get("column_name"))
            .toList();

        assertThat(columnNames).contains("id", "email", "name", "role");
    }

    @Test
    void indexesCreatedCorrectly() {
        var indexes = jdbcTemplate.queryForList("""
            SELECT indexname
            FROM pg_indexes
            WHERE tablename = 'users'
            """, String.class);

        assertThat(indexes).contains("idx_users_email", "idx_users_role");
    }
}
```

---

### 7.3 Teste de Rollback

```java
/**
 * Teste rollback com Liquibase
 */
@SpringBootTest
class LiquibaseRollbackTest {

    @Autowired
    private SpringLiquibase liquibase;

    @Autowired
    private JdbcTemplate jdbcTemplate;

    @Test
    void rollbackWorks() throws Exception {
        // Aplicar migrations
        liquibase.afterPropertiesSet();

        // Verificar tabela existe
        var tableExists = jdbcTemplate.queryForObject("""
            SELECT COUNT(*) FROM information_schema.tables
            WHERE table_name = 'orders'
            """, Integer.class);

        assertThat(tableExists).isEqualTo(1);

        // Rollback
        var liquibaseConnection = liquibase.getDatabase().getConnection();
        liquibase.getDatabase().rollback(1, null);

        // Verificar tabela removida
        tableExists = jdbcTemplate.queryForObject("""
            SELECT COUNT(*) FROM information_schema.tables
            WHERE table_name = 'orders'
            """, Integer.class);

        assertThat(tableExists).isEqualTo(0);
    }
}
```

---

## üìä Checklist de Qualidade

- [ ] Migrations idempotentes (safe re-run)
- [ ] Nunca alterar migration j√° aplicada em prod
- [ ] Sempre incluir rollback (Liquibase) ou undo script (Flyway)
- [ ] Testar migrations em ambiente staging antes de prod
- [ ] Usar Expand-Contract para mudan√ßas breaking
- [ ] Adicionar √≠ndices em colunas de query frequente
- [ ] Evitar ALTER TABLE bloqueante (usar tricks de zero-downtime)
- [ ] Validar checksums em produ√ß√£o
- [ ] Desabilitar `flyway.clean` em produ√ß√£o
- [ ] Versionar migrations no Git

---

## üéØ Exerc√≠cios Pr√°ticos

1. **B√°sico**: Criar migrations para schema completo (users, orders, products)
2. **Intermedi√°rio**: Implementar Expand-Contract para renomear coluna
3. **Avan√ßado**: Zero-downtime migration para alterar tipo de coluna

---

## üìö Refer√™ncias

- [Flyway Documentation](https://flywaydb.org/documentation/)
- [Liquibase Documentation](https://docs.liquibase.com/)
- [Zero-Downtime Migrations](https://www.brunton-spall.co.uk/post/2014/05/06/database-migrations-done-right/)

---

**Anterior:** [12.5 - Redis](12.5-redis.md)  
**Pr√≥ximo:** [12.7 - Triggers & Procedures](12.7-triggers-procedures.md)
