# 02.3 Integra√ß√£o com Mockito [INTERMEDI√ÅRIO] üé≠

## üéØ Objetivo

Dominar **Mockito** para criar **mocks**, **stubs** e **spies**, validar **intera√ß√µes**, capturar **argumentos** e testar **camadas de servi√ßo** com **depend√™ncias isoladas** no Spring Boot.

---

## üìö O Que √© Mockito?

**Mockito** √© um framework para criar **objetos simulados (mocks)** que substituem depend√™ncias reais durante testes, permitindo **isolar unidades de c√≥digo** e **validar comportamentos**.

### Por Que Usar Mockito?

```java
// ‚ùå SEM Mockito - Precisa de banco real
@Test
void testaSalvar() {
    ClienteRepository repo = new ClienteRepository();  // Conecta ao banco!
    ClienteService service = new ClienteService(repo);

    Cliente cliente = new Cliente("Jo√£o", "joao@mail.com");
    service.salvar(cliente);  // INSERT real no banco
}

// ‚úÖ COM Mockito - Mock do reposit√≥rio
@Test
void testaSalvar() {
    ClienteRepository repoMock = mock(ClienteRepository.class);  // Mock!
    ClienteService service = new ClienteService(repoMock);

    when(repoMock.save(any())).thenReturn(new Cliente(1L, "Jo√£o", "joao@mail.com"));

    Cliente cliente = new Cliente("Jo√£o", "joao@mail.com");
    Cliente salvo = service.salvar(cliente);  // N√£o toca no banco!

    assertNotNull(salvo.getId());
}
```

---

## üèóÔ∏è Configura√ß√£o no Spring Boot

### pom.xml

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-test</artifactId>
    <scope>test</scope>
    <exclusions>
        <exclusion>
            <groupId>org.junit.vintage</groupId>
            <artifactId>junit-vintage-engine</artifactId>
        </exclusion>
    </exclusions>
</dependency>
```

**Spring Boot Starter Test j√° inclui:**

- JUnit 5
- Mockito
- AssertJ
- Hamcrest
- JSONassert
- JsonPath

---

## üîß Anota√ß√µes Principais

### @Mock - Cria Mock

```java
@ExtendWith(MockitoExtension.class)  // JUnit 5
class ClienteServiceTest {

    @Mock
    private ClienteRepository clienteRepository;

    @InjectMocks  // Injeta os @Mock automaticamente
    private ClienteService clienteService;

    @Test
    void deveSalvarCliente() {
        // Arrange
        Cliente cliente = new Cliente("Jo√£o", "joao@mail.com");
        Cliente clienteSalvo = new Cliente(1L, "Jo√£o", "joao@mail.com");

        when(clienteRepository.save(any(Cliente.class))).thenReturn(clienteSalvo);

        // Act
        Cliente resultado = clienteService.salvar(cliente);

        // Assert
        assertNotNull(resultado.getId());
        assertEquals("Jo√£o", resultado.getNome());
    }
}
```

### @InjectMocks - Injeta Depend√™ncias

```java
@ExtendWith(MockitoExtension.class)
class PedidoServiceTest {

    @Mock
    private PedidoRepository pedidoRepository;

    @Mock
    private ClienteService clienteService;

    @Mock
    private ProdutoService produtoService;

    @Mock
    private EmailService emailService;

    @InjectMocks  // Injeta todos os @Mock acima
    private PedidoService pedidoService;
}
```

### @Spy - Mock Parcial (M√©todos Reais + Stubs)

```java
@ExtendWith(MockitoExtension.class)
class CalculadoraTest {

    @Spy
    private Calculadora calculadora = new Calculadora();

    @Test
    void deveUsarMetodoRealEStubbedJuntos() {
        // somar() usa implementa√ß√£o real
        assertEquals(5, calculadora.somar(2, 3));

        // multiplicar() usa stub
        when(calculadora.multiplicar(2, 3)).thenReturn(100);
        assertEquals(100, calculadora.multiplicar(2, 3));
    }
}
```

---

## üéØ Stubbing (when...thenReturn)

### Retornar Valores

```java
@Test
void deveEncontrarClientePorId() {
    // Arrange
    Cliente cliente = new Cliente(1L, "Jo√£o", "joao@mail.com");
    when(clienteRepository.findById(1L)).thenReturn(Optional.of(cliente));

    // Act
    Optional<Cliente> resultado = clienteService.buscarPorId(1L);

    // Assert
    assertTrue(resultado.isPresent());
    assertEquals("Jo√£o", resultado.get().getNome());
}
```

### Retornar Listas

```java
@Test
void deveListarTodosClientes() {
    // Arrange
    List<Cliente> clientes = List.of(
        new Cliente(1L, "Jo√£o", "joao@mail.com"),
        new Cliente(2L, "Maria", "maria@mail.com")
    );
    when(clienteRepository.findAll()).thenReturn(clientes);

    // Act
    List<Cliente> resultado = clienteService.listarTodos();

    // Assert
    assertEquals(2, resultado.size());
}
```

### Lan√ßar Exce√ß√µes

```java
@Test
void deveLancarExcecaoQuandoClienteNaoEncontrado() {
    // Arrange
    when(clienteRepository.findById(999L))
        .thenThrow(new ClienteNaoEncontradoException("Cliente 999 n√£o encontrado"));

    // Act & Assert
    assertThrows(ClienteNaoEncontradoException.class, () -> {
        clienteService.buscarPorId(999L);
    });
}
```

### Retornar Diferentes Valores

```java
@Test
void deveRetornarDiferentesValores() {
    // Primeira chamada retorna Jo√£o, segunda retorna Maria
    when(clienteRepository.findById(1L))
        .thenReturn(Optional.of(new Cliente(1L, "Jo√£o", "joao@mail.com")))
        .thenReturn(Optional.of(new Cliente(1L, "Maria", "maria@mail.com")));

    Optional<Cliente> primeiro = clienteService.buscarPorId(1L);
    Optional<Cliente> segundo = clienteService.buscarPorId(1L);

    assertEquals("Jo√£o", primeiro.get().getNome());
    assertEquals("Maria", segundo.get().getNome());
}
```

---

## üîç Argument Matchers

### any(), anyString(), anyLong()

```java
@Test
void deveAceitarQualquerCliente() {
    when(clienteRepository.save(any(Cliente.class)))
        .thenReturn(new Cliente(1L, "Qualquer", "qualquer@mail.com"));

    Cliente cliente = clienteService.salvar(new Cliente("Teste", "teste@mail.com"));
    assertNotNull(cliente.getId());
}

@Test
void deveAceitarQualquerEmail() {
    when(clienteRepository.findByEmail(anyString()))
        .thenReturn(Optional.of(new Cliente(1L, "Jo√£o", "joao@mail.com")));

    Optional<Cliente> cliente = clienteService.buscarPorEmail("qualquer@email.com");
    assertTrue(cliente.isPresent());
}
```

### eq() - Combinando Matchers com Valores Exatos

```java
@Test
void deveCombinarMatchersComValoresExatos() {
    // Quando salvar cliente com ID 1, retornar sucesso
    when(clienteRepository.saveAndFlush(eq(1L), any(Cliente.class)))
        .thenReturn(new Cliente(1L, "Jo√£o", "joao@mail.com"));
}
```

### Matchers Espec√≠ficos

```java
@Test
void deveUsarMatchersEspecificos() {
    // Aceita apenas strings n√£o-vazias
    when(clienteRepository.findByNome(argThat(nome -> !nome.isBlank())))
        .thenReturn(Optional.of(new Cliente(1L, "Jo√£o", "joao@mail.com")));

    // Aceita apenas valores > 100
    when(pedidoRepository.findByValorMinimo(doubleThat(valor -> valor > 100.0)))
        .thenReturn(List.of(new Pedido(1L, new BigDecimal("150.00"))));
}
```

---

## üß™ Verifica√ß√£o de Intera√ß√µes

### verify() - Validar Que M√©todo Foi Chamado

```java
@Test
void deveVerificarChamadaDoMetodo() {
    // Arrange
    Cliente cliente = new Cliente("Jo√£o", "joao@mail.com");
    when(clienteRepository.save(any(Cliente.class)))
        .thenReturn(new Cliente(1L, "Jo√£o", "joao@mail.com"));

    // Act
    clienteService.salvar(cliente);

    // Assert - Verifica que save() foi chamado
    verify(clienteRepository).save(any(Cliente.class));
}
```

### verify() com times()

```java
@Test
void deveVerificarQuantidadeDeChamadas() {
    clienteService.salvar(new Cliente("Jo√£o", "joao@mail.com"));
    clienteService.salvar(new Cliente("Maria", "maria@mail.com"));

    verify(clienteRepository, times(2)).save(any(Cliente.class));
}

@Test
void deveVerificarNenhumaChamada() {
    verify(clienteRepository, never()).delete(any(Cliente.class));
}

@Test
void deveVerificarPeloMenosUmaChamada() {
    clienteService.salvar(new Cliente("Jo√£o", "joao@mail.com"));
    clienteService.salvar(new Cliente("Maria", "maria@mail.com"));

    verify(clienteRepository, atLeastOnce()).save(any(Cliente.class));
}

@Test
void deveVerificarNoMaximoDuasChamadas() {
    clienteService.salvar(new Cliente("Jo√£o", "joao@mail.com"));

    verify(clienteRepository, atMost(2)).save(any(Cliente.class));
}
```

### verifyNoInteractions() - Nenhuma Intera√ß√£o

```java
@Test
void naoDeveInteragirComRepositorioQuandoValidacaoFalhar() {
    // Arrange - Cliente inv√°lido
    Cliente cliente = new Cliente("", "");  // Nome e email vazios

    // Act & Assert
    assertThrows(ValidationException.class, () -> {
        clienteService.salvar(cliente);
    });

    // Verifica que reposit√≥rio N√ÉO foi chamado
    verifyNoInteractions(clienteRepository);
}
```

### InOrder - Verificar Ordem de Chamadas

```java
@Test
void deveVerificarOrdemDasChamadas() {
    // Act
    clienteService.processar(new Cliente("Jo√£o", "joao@mail.com"));

    // Assert - Ordem importa
    InOrder inOrder = inOrder(clienteRepository, emailService);
    inOrder.verify(clienteRepository).save(any(Cliente.class));
    inOrder.verify(emailService).enviarBoasVindas(any(Cliente.class));
}
```

---

## üì¶ ArgumentCaptor - Capturar Argumentos

### Capturando Objeto Passado

```java
@Test
void deveCapturarClienteSalvo() {
    // Arrange
    ArgumentCaptor<Cliente> captor = ArgumentCaptor.forClass(Cliente.class);

    when(clienteRepository.save(any(Cliente.class)))
        .thenReturn(new Cliente(1L, "Jo√£o", "joao@mail.com"));

    // Act
    clienteService.salvar(new Cliente("Jo√£o", "joao@mail.com"));

    // Assert - Captura o objeto passado para save()
    verify(clienteRepository).save(captor.capture());

    Cliente clienteCapturado = captor.getValue();
    assertEquals("Jo√£o", clienteCapturado.getNome());
    assertEquals("joao@mail.com", clienteCapturado.getEmail());
}
```

### Capturando M√∫ltiplos Argumentos

```java
@Test
void deveCapturarMultiplosClientes() {
    // Arrange
    ArgumentCaptor<Cliente> captor = ArgumentCaptor.forClass(Cliente.class);

    // Act
    clienteService.salvar(new Cliente("Jo√£o", "joao@mail.com"));
    clienteService.salvar(new Cliente("Maria", "maria@mail.com"));

    // Assert
    verify(clienteRepository, times(2)).save(captor.capture());

    List<Cliente> clientes = captor.getAllValues();
    assertEquals(2, clientes.size());
    assertEquals("Jo√£o", clientes.get(0).getNome());
    assertEquals("Maria", clientes.get(1).getNome());
}
```

### Validando Transforma√ß√µes

```java
@Test
void deveValidarTransformacaoAntesDeSalvar() {
    // Arrange
    ArgumentCaptor<Cliente> captor = ArgumentCaptor.forClass(Cliente.class);

    // Act - Passa email em mai√∫sculas
    clienteService.salvar(new Cliente("Jo√£o", "JOAO@MAIL.COM"));

    // Assert - Verifica que foi convertido para min√∫sculas
    verify(clienteRepository).save(captor.capture());

    Cliente clienteCapturado = captor.getValue();
    assertEquals("joao@mail.com", clienteCapturado.getEmail());  // Min√∫sculas
}
```

---

## üéØ BDD Style (Behavior Driven Development)

### BDDMockito (given/when/then)

```java
import static org.mockito.BDDMockito.*;

@Test
void deveSalvarClienteUsandoBDD() {
    // Given (Arrange)
    Cliente cliente = new Cliente("Jo√£o", "joao@mail.com");
    Cliente clienteSalvo = new Cliente(1L, "Jo√£o", "joao@mail.com");

    given(clienteRepository.save(any(Cliente.class))).willReturn(clienteSalvo);

    // When (Act)
    Cliente resultado = clienteService.salvar(cliente);

    // Then (Assert)
    then(clienteRepository).should().save(any(Cliente.class));
    assertNotNull(resultado.getId());
}
```

### willThrow() - BDD para Exce√ß√µes

```java
@Test
void deveLancarExcecaoUsandoBDD() {
    // Given
    given(clienteRepository.findById(999L))
        .willThrow(new ClienteNaoEncontradoException("Cliente n√£o encontrado"));

    // When & Then
    assertThrows(ClienteNaoEncontradoException.class, () -> {
        clienteService.buscarPorId(999L);
    });

    then(clienteRepository).should().findById(999L);
}
```

---

## üß© M√©todos Void

### doNothing() - M√©todo Void Sem A√ß√£o

```java
@Test
void deveEnviarEmailSemErro() {
    // Arrange
    doNothing().when(emailService).enviar(anyString(), anyString());

    // Act
    clienteService.notificarCliente(new Cliente(1L, "Jo√£o", "joao@mail.com"));

    // Assert
    verify(emailService).enviar("joao@mail.com", "Bem-vindo!");
}
```

### doThrow() - M√©todo Void Lan√ßando Exce√ß√£o

```java
@Test
void deveTratarErroAoEnviarEmail() {
    // Arrange
    doThrow(new EmailException("Falha no SMTP"))
        .when(emailService).enviar(anyString(), anyString());

    // Act & Assert
    assertThrows(EmailException.class, () -> {
        clienteService.notificarCliente(new Cliente(1L, "Jo√£o", "joao@mail.com"));
    });
}
```

### doAnswer() - L√≥gica Customizada

```java
@Test
void deveExecutarLogicaCustomizada() {
    // Arrange
    doAnswer(invocation -> {
        Cliente cliente = invocation.getArgument(0);
        System.out.println("Salvando: " + cliente.getNome());
        return new Cliente(1L, cliente.getNome(), cliente.getEmail());
    }).when(clienteRepository).save(any(Cliente.class));

    // Act
    Cliente resultado = clienteService.salvar(new Cliente("Jo√£o", "joao@mail.com"));

    // Assert
    assertNotNull(resultado.getId());
}
```

---

## üîÑ @MockBean (Spring Boot)

### Substituir Bean no Contexto

```java
@SpringBootTest
class ClienteControllerIntegrationTest {

    @Autowired
    private MockMvc mockMvc;

    @MockBean  // Substitui o bean real no contexto Spring
    private ClienteService clienteService;

    @Test
    void deveRetornarClientePorId() throws Exception {
        // Arrange
        Cliente cliente = new Cliente(1L, "Jo√£o", "joao@mail.com");
        when(clienteService.buscarPorId(1L)).thenReturn(Optional.of(cliente));

        // Act & Assert
        mockMvc.perform(get("/api/clientes/1"))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.nome").value("Jo√£o"))
                .andExpect(jsonPath("$.email").value("joao@mail.com"));
    }
}
```

### @MockBean vs @Mock

| Aspecto                 | @Mock            | @MockBean            |
| ----------------------- | ---------------- | -------------------- |
| **Framework**           | Mockito puro     | Spring Boot          |
| **Contexto Spring**     | N√£o              | Sim                  |
| **Substitui bean real** | N√£o              | Sim                  |
| **Uso**                 | Testes unit√°rios | Testes de integra√ß√£o |

---

## üé® Exemplo Completo: Pedido Service

```java
@ExtendWith(MockitoExtension.class)
class PedidoServiceTest {

    @Mock
    private PedidoRepository pedidoRepository;

    @Mock
    private ClienteService clienteService;

    @Mock
    private ProdutoService produtoService;

    @Mock
    private EmailService emailService;

    @Mock
    private EstoqueService estoqueService;

    @InjectMocks
    private PedidoService pedidoService;

    @Test
    @DisplayName("Deve criar pedido completo com sucesso")
    void deveCriarPedidoComSucesso() {
        // Given
        Long clienteId = 1L;
        Cliente cliente = new Cliente(clienteId, "Jo√£o", "joao@mail.com");

        PedidoRequest request = new PedidoRequest();
        request.setClienteId(clienteId);
        request.setItems(List.of(
            new ItemRequest("PROD-001", 2),
            new ItemRequest("PROD-002", 1)
        ));

        Produto produto1 = new Produto("PROD-001", "Notebook", new BigDecimal("3000.00"));
        Produto produto2 = new Produto("PROD-002", "Mouse", new BigDecimal("50.00"));

        Pedido pedidoSalvo = new Pedido();
        pedidoSalvo.setId(100L);
        pedidoSalvo.setCliente(cliente);
        pedidoSalvo.setTotal(new BigDecimal("6050.00"));

        given(clienteService.buscarPorId(clienteId)).willReturn(Optional.of(cliente));
        given(produtoService.buscarPorCodigo("PROD-001")).willReturn(Optional.of(produto1));
        given(produtoService.buscarPorCodigo("PROD-002")).willReturn(Optional.of(produto2));
        given(estoqueService.verificarDisponibilidade("PROD-001", 2)).willReturn(true);
        given(estoqueService.verificarDisponibilidade("PROD-002", 1)).willReturn(true);
        given(pedidoRepository.save(any(Pedido.class))).willReturn(pedidoSalvo);

        // When
        PedidoResponse response = pedidoService.criar(request);

        // Then
        assertNotNull(response.getId());
        assertEquals(new BigDecimal("6050.00"), response.getTotal());

        // Verifica ordem de chamadas
        InOrder inOrder = inOrder(clienteService, produtoService, estoqueService, pedidoRepository, emailService);
        inOrder.verify(clienteService).buscarPorId(clienteId);
        inOrder.verify(produtoService, times(2)).buscarPorCodigo(anyString());
        inOrder.verify(estoqueService, times(2)).verificarDisponibilidade(anyString(), anyInt());
        inOrder.verify(pedidoRepository).save(any(Pedido.class));
        inOrder.verify(emailService).enviarConfirmacao(eq(cliente), any(Pedido.class));

        // Captura pedido salvo
        ArgumentCaptor<Pedido> pedidoCaptor = ArgumentCaptor.forClass(Pedido.class);
        verify(pedidoRepository).save(pedidoCaptor.capture());

        Pedido pedidoCapturado = pedidoCaptor.getValue();
        assertEquals(2, pedidoCapturado.getItems().size());
        assertEquals(clienteId, pedidoCapturado.getCliente().getId());
    }

    @Test
    @DisplayName("Deve lan√ßar exce√ß√£o quando cliente n√£o encontrado")
    void deveLancarExcecaoQuandoClienteNaoEncontrado() {
        // Given
        PedidoRequest request = new PedidoRequest();
        request.setClienteId(999L);

        given(clienteService.buscarPorId(999L)).willReturn(Optional.empty());

        // When & Then
        assertThrows(ClienteNaoEncontradoException.class, () -> {
            pedidoService.criar(request);
        });

        // Verifica que n√£o interagiu com reposit√≥rio
        verifyNoInteractions(pedidoRepository);
        verifyNoInteractions(emailService);
    }

    @Test
    @DisplayName("Deve lan√ßar exce√ß√£o quando estoque insuficiente")
    void deveLancarExcecaoQuandoEstoqueInsuficiente() {
        // Given
        Long clienteId = 1L;
        Cliente cliente = new Cliente(clienteId, "Jo√£o", "joao@mail.com");

        PedidoRequest request = new PedidoRequest();
        request.setClienteId(clienteId);
        request.setItems(List.of(new ItemRequest("PROD-001", 10)));

        Produto produto = new Produto("PROD-001", "Notebook", new BigDecimal("3000.00"));

        given(clienteService.buscarPorId(clienteId)).willReturn(Optional.of(cliente));
        given(produtoService.buscarPorCodigo("PROD-001")).willReturn(Optional.of(produto));
        given(estoqueService.verificarDisponibilidade("PROD-001", 10)).willReturn(false);

        // When & Then
        assertThrows(EstoqueInsuficienteException.class, () -> {
            pedidoService.criar(request);
        });

        // Verifica que n√£o salvou pedido
        verify(pedidoRepository, never()).save(any(Pedido.class));
        verify(emailService, never()).enviarConfirmacao(any(), any());
    }
}
```

---

## üìã Boas Pr√°ticas

### ‚úÖ Recomenda√ß√µes

```java
// ‚úÖ Mock apenas depend√™ncias externas
@Mock private ClienteRepository clienteRepository;  // ‚úÖ Depend√™ncia externa
ClienteService clienteService = new ClienteService(clienteRepository);  // ‚úÖ Classe testada √© real

// ‚úÖ Use @InjectMocks para simplificar
@InjectMocks private ClienteService clienteService;

// ‚úÖ Use BDD style para legibilidade
given(repo.findById(1L)).willReturn(Optional.of(cliente));
then(repo).should().findById(1L);

// ‚úÖ Verify apenas o necess√°rio
verify(repo).save(any());  // ‚úÖ Verifica comportamento importante
// ‚ùå verify(repo).toString();  // M√©todo irrelevante

// ‚úÖ Use ArgumentCaptor para valida√ß√µes complexas
ArgumentCaptor<Cliente> captor = ArgumentCaptor.forClass(Cliente.class);
verify(repo).save(captor.capture());
assertEquals("joao@mail.com", captor.getValue().getEmail());

// ‚úÖ Cleanup (reset) quando necess√°rio
@AfterEach
void cleanup() {
    Mockito.reset(clienteRepository);
}
```

### ‚ùå Anti-Patterns

```java
// ‚ùå Mockar a classe testada
@Mock private ClienteService clienteService;  // ‚ùå N√£o faz sentido!

// ‚ùå Mockar classes simples (POJOs)
@Mock private Cliente cliente;  // ‚ùå Use new Cliente()

// ‚ùå Verify de tudo
verify(repo).save(any());
verify(repo).findById(any());
verify(repo).toString();  // ‚ùå Excessivo!

// ‚ùå N√£o usar matchers corretamente
when(repo.save(new Cliente("Jo√£o", "joao@mail.com")))  // ‚ùå Compara refer√™ncia
// ‚úÖ
when(repo.save(any(Cliente.class)))

// ‚ùå when() em m√©todos void
when(emailService.enviar()).thenReturn(...);  // ‚ùå N√£o compila!
// ‚úÖ
doNothing().when(emailService).enviar();
```

---

## üéØ Quando Usar Mockito?

| Cen√°rio                   | Mockito    | Objeto Real |
| ------------------------- | ---------- | ----------- |
| Reposit√≥rios (JPA)        | ‚úÖ Sim     | ‚ùå N√£o      |
| Servi√ßos externos (HTTP)  | ‚úÖ Sim     | ‚ùå N√£o      |
| Envio de email            | ‚úÖ Sim     | ‚ùå N√£o      |
| Entities/DTOs             | ‚ùå N√£o     | ‚úÖ Sim      |
| Utilit√°rios (validadores) | ‚ùå N√£o     | ‚úÖ Sim      |
| Classes de configura√ß√£o   | ‚ö†Ô∏è Depende | ‚ö†Ô∏è Depende  |

---

## üìù Resumo

**Mockito** oferece:

- ‚úÖ **@Mock**: Cria mocks de depend√™ncias
- ‚úÖ **@InjectMocks**: Injeta mocks automaticamente
- ‚úÖ **@Spy**: Mock parcial (real + stubbed)
- ‚úÖ **when...thenReturn**: Stubbing de m√©todos
- ‚úÖ **verify()**: Valida√ß√£o de intera√ß√µes
- ‚úÖ **ArgumentCaptor**: Captura argumentos passados
- ‚úÖ **BDDMockito**: Estilo given/when/then
- ‚úÖ **@MockBean**: Integra√ß√£o com Spring Boot

**Regra de ouro:** Mock **depend√™ncias externas** (reposit√≥rios, APIs, servi√ßos de infraestrutura), mas use **objetos reais** para POJOs e l√≥gica de neg√≥cio simples.
