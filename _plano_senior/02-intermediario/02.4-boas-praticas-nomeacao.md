# 02.4 Boas PrÃ¡ticas de NomeaÃ§Ã£o [INTERMEDIÃRIO] ğŸ“

## ğŸ¯ Objetivo

Estabelecer **convenÃ§Ãµes de nomeaÃ§Ã£o**, estruturas de **organizaÃ§Ã£o de testes**, uso de **@DisplayName**, padrÃ£o **AAA (Arrange-Act-Assert)**, **@Nested** e **test builders** para criar suÃ­tes de testes legÃ­veis e manutenÃ­veis.

---

## ğŸ“š Por Que NomeaÃ§Ã£o Importa?

```java
// âŒ Nome ruim
@Test
void test1() { ... }

// âš ï¸ Nome genÃ©rico
@Test
void testaCliente() { ... }

// âœ… Nome descritivo
@Test
void deveSalvarClienteComSucessoQuandoDadosValidos() { ... }

// âœ… Ainda melhor com @DisplayName
@Test
@DisplayName("Deve salvar cliente com sucesso quando dados sÃ£o vÃ¡lidos")
void deveSalvarClienteComSucessoQuandoDadosValidos() { ... }
```

---

## ğŸ“ ConvenÃ§Ãµes de NomeaÃ§Ã£o

### PadrÃ£o: deve + AÃ§Ã£o + CondiÃ§Ã£o

```java
// âœ… PadrÃ£o recomendado
@Test
void deveSalvarClienteQuandoDadosValidos() { ... }

@Test
void deveLancarExcecaoQuandoEmailInvalido() { ... }

@Test
void deveRetornarListaVaziaQuandoNaoHaClientes() { ... }
```

### PadrÃ£o: should + AÃ§Ã£o + CondiÃ§Ã£o (InglÃªs)

```java
// âœ… PadrÃ£o em inglÃªs
@Test
void shouldSaveClientWhenDataIsValid() { ... }

@Test
void shouldThrowExceptionWhenEmailIsInvalid() { ... }

@Test
void shouldReturnEmptyListWhenNoClientsExist() { ... }
```

### PadrÃ£o: when + CondiÃ§Ã£o + then + Resultado

```java
// âœ… Given-When-Then style
@Test
void whenSavingClientWithValidData_thenShouldReturnClientWithId() { ... }

@Test
void whenClientNotFound_thenShouldThrowException() { ... }

@Test
void whenCalculatingDiscount_thenShouldApply10Percent() { ... }
```

### PadrÃ£o: mÃ©todo_cenÃ¡rio_resultado

```java
// âœ… Snake case (menos comum em Java)
@Test
void salvar_dadosValidos_retornaClienteComId() { ... }

@Test
void buscarPorId_idInexistente_lancaExcecao() { ... }
```

---

## ğŸ¨ @DisplayName - DescriÃ§Ãµes em PortuguÃªs

### Frases Completas

```java
@Test
@DisplayName("Deve salvar cliente com sucesso quando todos os dados sÃ£o vÃ¡lidos")
void deveSalvarClienteComSucesso() {
    // Test logic
}

@Test
@DisplayName("Deve lanÃ§ar ValidationException quando email estÃ¡ em formato invÃ¡lido")
void deveLancarExcecaoQuandoEmailInvalido() {
    // Test logic
}

@Test
@DisplayName("Deve retornar lista vazia quando nÃ£o hÃ¡ clientes cadastrados")
void deveRetornarListaVazia() {
    // Test logic
}
```

### Uso de Emojis (Opcional)

```java
@Test
@DisplayName("âœ… Deve salvar cliente com sucesso")
void deveSalvarCliente() { ... }

@Test
@DisplayName("âŒ Deve lanÃ§ar exceÃ§Ã£o quando CPF invÃ¡lido")
void deveLancarExcecaoQuandoCpfInvalido() { ... }

@Test
@DisplayName("ğŸ” Deve buscar cliente por ID")
void deveBuscarClientePorId() { ... }

@Test
@DisplayName("ğŸ“§ Deve enviar email de boas-vindas")
void deveEnviarEmailBoasVindas() { ... }
```

### DisplayName em Classes

```java
@DisplayName("ClienteService - Testes de CRUD")
class ClienteServiceTest {

    @Test
    @DisplayName("Deve salvar cliente")
    void deveSalvarCliente() { ... }

    @Test
    @DisplayName("Deve atualizar cliente")
    void deveAtualizarCliente() { ... }

    @Test
    @DisplayName("Deve deletar cliente")
    void deveDeletarCliente() { ... }
}
```

---

## ğŸ—ï¸ PadrÃ£o AAA (Arrange-Act-Assert)

### Estrutura BÃ¡sica

```java
@Test
void deveSalvarClienteComSucesso() {
    // Arrange (Given) - PreparaÃ§Ã£o
    ClienteRequest request = new ClienteRequest(
        "JoÃ£o Silva",
        "joao@mail.com",
        "12345678901"
    );
    Cliente clienteSalvo = new Cliente(1L, "JoÃ£o Silva", "joao@mail.com");
    when(clienteRepository.save(any(Cliente.class))).thenReturn(clienteSalvo);

    // Act (When) - ExecuÃ§Ã£o
    ClienteResponse response = clienteService.salvar(request);

    // Assert (Then) - VerificaÃ§Ã£o
    assertNotNull(response.getId());
    assertEquals("JoÃ£o Silva", response.getNome());
    assertEquals("joao@mail.com", response.getEmail());
    verify(clienteRepository).save(any(Cliente.class));
}
```

### ComentÃ¡rios Visuais

```java
@Test
void deveCalcularDescontoVIP() {
    // ========== ARRANGE ==========
    Cliente cliente = new Cliente(1L, "JoÃ£o", "joao@mail.com");
    cliente.setVip(true);
    BigDecimal valorCompra = new BigDecimal("1000.00");

    // ========== ACT ==========
    BigDecimal desconto = descontoService.calcular(cliente, valorCompra);

    // ========== ASSERT ==========
    assertEquals(new BigDecimal("100.00"), desconto);  // 10% de desconto
}
```

### SeparaÃ§Ã£o por Linhas

```java
@Test
void deveCriarPedidoCompleto() {
    // Arrange
    Long clienteId = 1L;
    PedidoRequest request = new PedidoRequest();
    request.setClienteId(clienteId);

    // Act
    PedidoResponse response = pedidoService.criar(request);

    // Assert
    assertNotNull(response.getId());
    assertEquals(clienteId, response.getClienteId());
}
```

---

## ğŸ“¦ @Nested - OrganizaÃ§Ã£o de Testes

### Agrupando Por MÃ©todo

```java
@DisplayName("ClienteService")
class ClienteServiceTest {

    @Nested
    @DisplayName("salvar()")
    class SalvarTests {

        @Test
        @DisplayName("Deve salvar cliente quando dados vÃ¡lidos")
        void deveSalvarQuandoDadosValidos() { ... }

        @Test
        @DisplayName("Deve lanÃ§ar exceÃ§Ã£o quando email invÃ¡lido")
        void deveLancarExcecaoQuandoEmailInvalido() { ... }

        @Test
        @DisplayName("Deve lanÃ§ar exceÃ§Ã£o quando CPF invÃ¡lido")
        void deveLancarExcecaoQuandoCpfInvalido() { ... }
    }

    @Nested
    @DisplayName("buscarPorId()")
    class BuscarPorIdTests {

        @Test
        @DisplayName("Deve retornar cliente quando ID existe")
        void deveRetornarClienteQuandoIdExiste() { ... }

        @Test
        @DisplayName("Deve lanÃ§ar exceÃ§Ã£o quando ID nÃ£o existe")
        void deveLancarExcecaoQuandoIdNaoExiste() { ... }
    }

    @Nested
    @DisplayName("deletar()")
    class DeletarTests {

        @Test
        @DisplayName("Deve deletar cliente quando ID existe")
        void deveDeletarQuandoIdExiste() { ... }

        @Test
        @DisplayName("Deve lanÃ§ar exceÃ§Ã£o quando cliente tem pedidos ativos")
        void deveLancarExcecaoQuandoClienteTemPedidosAtivos() { ... }
    }
}
```

### Agrupando Por CenÃ¡rio

```java
@DisplayName("PedidoService")
class PedidoServiceTest {

    @Nested
    @DisplayName("CenÃ¡rios de Sucesso")
    class CenariosSucesso {

        @Test
        @DisplayName("Deve criar pedido com 1 item")
        void deveCriarPedidoComUmItem() { ... }

        @Test
        @DisplayName("Deve criar pedido com mÃºltiplos items")
        void deveCriarPedidoComMultiplosItems() { ... }

        @Test
        @DisplayName("Deve aplicar desconto VIP")
        void deveAplicarDescontoVIP() { ... }
    }

    @Nested
    @DisplayName("CenÃ¡rios de Erro")
    class CenariosErro {

        @Test
        @DisplayName("Deve falhar quando cliente nÃ£o encontrado")
        void deveFalharQuandoClienteNaoEncontrado() { ... }

        @Test
        @DisplayName("Deve falhar quando produto sem estoque")
        void deveFalharQuandoProdutoSemEstoque() { ... }

        @Test
        @DisplayName("Deve falhar quando valor mÃ­nimo nÃ£o atingido")
        void deveFalharQuandoValorMinimoNaoAtingido() { ... }
    }

    @Nested
    @DisplayName("ValidaÃ§Ãµes de NegÃ³cio")
    class ValidacoesNegocio {

        @Test
        @DisplayName("Deve validar limite de crÃ©dito do cliente")
        void deveValidarLimiteCredito() { ... }

        @Test
        @DisplayName("Deve validar disponibilidade de entrega")
        void deveValidarDisponibilidadeEntrega() { ... }
    }
}
```

### @Nested com Compartilhamento de Contexto

```java
@DisplayName("DescontoService")
class DescontoServiceTest {

    private DescontoService descontoService;
    private Cliente clienteRegular;
    private Cliente clienteVip;

    @BeforeEach
    void setUp() {
        descontoService = new DescontoService();
        clienteRegular = new Cliente(1L, "JoÃ£o", "joao@mail.com");
        clienteVip = new Cliente(2L, "Maria", "maria@mail.com");
        clienteVip.setVip(true);
    }

    @Nested
    @DisplayName("Cliente Regular")
    class ClienteRegularTests {

        @Test
        @DisplayName("NÃ£o deve aplicar desconto em compras abaixo de R$ 100")
        void naoDeveAplicarDescontoAbaixoDe100() {
            BigDecimal desconto = descontoService.calcular(clienteRegular, new BigDecimal("50"));
            assertEquals(BigDecimal.ZERO, desconto);
        }

        @Test
        @DisplayName("Deve aplicar 5% de desconto em compras acima de R$ 100")
        void deveAplicar5PorcentoAcimaDe100() {
            BigDecimal desconto = descontoService.calcular(clienteRegular, new BigDecimal("200"));
            assertEquals(new BigDecimal("10.00"), desconto);
        }
    }

    @Nested
    @DisplayName("Cliente VIP")
    class ClienteVipTests {

        @Test
        @DisplayName("Deve aplicar 10% de desconto em qualquer compra")
        void deveAplicar10PorcentoSempre() {
            BigDecimal desconto = descontoService.calcular(clienteVip, new BigDecimal("100"));
            assertEquals(new BigDecimal("10.00"), desconto);
        }

        @Test
        @DisplayName("Deve aplicar 15% de desconto em compras acima de R$ 500")
        void deveAplicar15PorcentoAcimaDe500() {
            BigDecimal desconto = descontoService.calcular(clienteVip, new BigDecimal("1000"));
            assertEquals(new BigDecimal("150.00"), desconto);
        }
    }
}
```

---

## ğŸ­ Test Builders (Object Mother / Test Data Builder)

### Builder Pattern para Testes

```java
public class ClienteTestBuilder {

    private Long id = 1L;
    private String nome = "JoÃ£o Silva";
    private String email = "joao@mail.com";
    private String cpf = "12345678901";
    private boolean vip = false;
    private LocalDateTime dataCadastro = LocalDateTime.now();

    public static ClienteTestBuilder umCliente() {
        return new ClienteTestBuilder();
    }

    public ClienteTestBuilder comId(Long id) {
        this.id = id;
        return this;
    }

    public ClienteTestBuilder comNome(String nome) {
        this.nome = nome;
        return this;
    }

    public ClienteTestBuilder comEmail(String email) {
        this.email = email;
        return this;
    }

    public ClienteTestBuilder comCpf(String cpf) {
        this.cpf = cpf;
        return this;
    }

    public ClienteTestBuilder vip() {
        this.vip = true;
        return this;
    }

    public ClienteTestBuilder regular() {
        this.vip = false;
        return this;
    }

    public ClienteTestBuilder cadastradoEm(LocalDateTime data) {
        this.dataCadastro = data;
        return this;
    }

    public Cliente build() {
        return new Cliente(id, nome, email, cpf, vip, dataCadastro);
    }
}
```

### Usando o Builder nos Testes

```java
@Test
void deveSalvarClienteVIP() {
    // Arrange - Usando builder
    Cliente cliente = ClienteTestBuilder.umCliente()
            .comNome("Maria Silva")
            .comEmail("maria@mail.com")
            .vip()
            .build();

    when(clienteRepository.save(any())).thenReturn(cliente);

    // Act
    Cliente salvo = clienteService.salvar(cliente);

    // Assert
    assertTrue(salvo.isVip());
}

@Test
void deveCalcularDescontoParaClienteVIP() {
    // Arrange
    Cliente clienteVip = ClienteTestBuilder.umCliente()
            .vip()
            .build();

    // Act
    BigDecimal desconto = descontoService.calcular(clienteVip, new BigDecimal("1000"));

    // Assert
    assertEquals(new BigDecimal("100.00"), desconto);
}
```

### Object Mother Pattern

```java
public class ClienteMother {

    public static Cliente clienteRegular() {
        return new Cliente(1L, "JoÃ£o Silva", "joao@mail.com", "12345678901", false);
    }

    public static Cliente clienteVip() {
        return new Cliente(2L, "Maria Silva", "maria@mail.com", "98765432109", true);
    }

    public static Cliente clienteInativo() {
        Cliente cliente = clienteRegular();
        cliente.setAtivo(false);
        return cliente;
    }

    public static Cliente clienteComPedidosAtivos() {
        Cliente cliente = clienteRegular();
        cliente.setPedidos(List.of(
            new Pedido(1L, cliente, new BigDecimal("100.00")),
            new Pedido(2L, cliente, new BigDecimal("200.00"))
        ));
        return cliente;
    }
}
```

### Usando Object Mother

```java
@Test
void deveCalcularDescontoVIP() {
    // Arrange
    Cliente cliente = ClienteMother.clienteVip();

    // Act
    BigDecimal desconto = descontoService.calcular(cliente, new BigDecimal("1000"));

    // Assert
    assertEquals(new BigDecimal("100.00"), desconto);
}

@Test
void naoDeveDeletarClienteComPedidosAtivos() {
    // Arrange
    Cliente cliente = ClienteMother.clienteComPedidosAtivos();

    // Act & Assert
    assertThrows(ClienteComPedidosException.class, () -> {
        clienteService.deletar(cliente.getId());
    });
}
```

---

## ğŸ“‚ Estrutura de Pacotes

### Espelhar Estrutura do CÃ³digo

```
src/
â”œâ”€â”€ main/
â”‚   â””â”€â”€ java/
â”‚       â””â”€â”€ com/empresa/pedidos/
â”‚           â”œâ”€â”€ controller/
â”‚           â”‚   â””â”€â”€ ClienteController.java
â”‚           â”œâ”€â”€ service/
â”‚           â”‚   â””â”€â”€ ClienteService.java
â”‚           â””â”€â”€ repository/
â”‚               â””â”€â”€ ClienteRepository.java
â”‚
â””â”€â”€ test/
    â””â”€â”€ java/
        â””â”€â”€ com/empresa/pedidos/
            â”œâ”€â”€ controller/
            â”‚   â””â”€â”€ ClienteControllerTest.java
            â”œâ”€â”€ service/
            â”‚   â””â”€â”€ ClienteServiceTest.java
            â””â”€â”€ repository/
                â””â”€â”€ ClienteRepositoryTest.java
```

### Organizar Por Tipo de Teste

```
src/test/java/
â””â”€â”€ com/empresa/pedidos/
    â”œâ”€â”€ unit/
    â”‚   â”œâ”€â”€ service/
    â”‚   â”‚   â””â”€â”€ ClienteServiceTest.java
    â”‚   â””â”€â”€ validator/
    â”‚       â””â”€â”€ EmailValidatorTest.java
    â”‚
    â”œâ”€â”€ integration/
    â”‚   â”œâ”€â”€ controller/
    â”‚   â”‚   â””â”€â”€ ClienteControllerIntegrationTest.java
    â”‚   â””â”€â”€ repository/
    â”‚       â””â”€â”€ ClienteRepositoryIntegrationTest.java
    â”‚
    â””â”€â”€ e2e/
        â””â”€â”€ ClienteE2ETest.java
```

### Builders e Fixtures Separados

```
src/test/java/
â””â”€â”€ com/empresa/pedidos/
    â”œâ”€â”€ builders/
    â”‚   â”œâ”€â”€ ClienteTestBuilder.java
    â”‚   â”œâ”€â”€ PedidoTestBuilder.java
    â”‚   â””â”€â”€ ProdutoTestBuilder.java
    â”‚
    â”œâ”€â”€ fixtures/
    â”‚   â”œâ”€â”€ ClienteMother.java
    â”‚   â”œâ”€â”€ PedidoMother.java
    â”‚   â””â”€â”€ ProdutoMother.java
    â”‚
    â””â”€â”€ service/
        â””â”€â”€ ClienteServiceTest.java
```

---

## ğŸ¯ ConvenÃ§Ãµes de Assertions

### Ordem: Esperado vs Atual

```java
// âœ… Correto: assertEquals(esperado, atual)
assertEquals(10, resultado);
assertEquals("JoÃ£o", cliente.getNome());

// âŒ Invertido (confuso)
assertEquals(resultado, 10);  // âŒ
assertEquals(cliente.getNome(), "JoÃ£o");  // âŒ
```

### Mensagens Descritivas

```java
// âœ… Com mensagem clara
assertTrue(cliente.isVip(),
    "Cliente deveria ser VIP apÃ³s upgrade");

assertNotNull(response.getId(),
    "ID do cliente salvo nÃ£o pode ser nulo");

assertEquals(2, pedido.getItems().size(),
    String.format("Pedido deveria ter 2 items, mas tem %d", pedido.getItems().size()));
```

### assertAll() para MÃºltiplas ValidaÃ§Ãµes

```java
@Test
void deveSalvarClienteCompleto() {
    // Arrange
    ClienteRequest request = new ClienteRequest("JoÃ£o", "joao@mail.com", "12345678901");

    // Act
    ClienteResponse response = clienteService.salvar(request);

    // Assert - Todas validaÃ§Ãµes executam mesmo se uma falhar
    assertAll("Cliente salvo",
        () -> assertNotNull(response.getId(), "ID nÃ£o pode ser nulo"),
        () -> assertEquals("JoÃ£o", response.getNome(), "Nome incorreto"),
        () -> assertEquals("joao@mail.com", response.getEmail(), "Email incorreto"),
        () -> assertTrue(CpfValidator.isValid(response.getCpf()), "CPF invÃ¡lido")
    );
}
```

---

## ğŸ“‹ Boas PrÃ¡ticas Gerais

### âœ… RecomendaÃ§Ãµes

```java
// âœ… Um cenÃ¡rio por teste
@Test
void deveSalvarCliente() { ... }

@Test
void deveAtualizarCliente() { ... }

// âŒ MÃºltiplos cenÃ¡rios em um teste
@Test
void testaCRUD() {
    // Salva
    // Atualiza
    // Deleta
}

// âœ… Nomes longos e descritivos
void deveLancarExcecaoQuandoEmailInvalidoAoSalvarCliente() { ... }

// âŒ Nomes genÃ©ricos
void test1() { ... }
void testaEmail() { ... }

// âœ… Use @DisplayName para frases completas
@Test
@DisplayName("Deve lanÃ§ar ValidationException quando email estÃ¡ em formato invÃ¡lido ao salvar cliente")
void deveLancarExcecaoQuandoEmailInvalido() { ... }

// âœ… Organize com @Nested
@Nested
@DisplayName("CenÃ¡rios de Erro")
class CenariosErro { ... }

// âœ… Use builders para dados de teste complexos
Cliente cliente = ClienteTestBuilder.umCliente()
        .comNome("JoÃ£o")
        .vip()
        .build();

// âœ… PadrÃ£o AAA sempre
// Arrange
// Act
// Assert
```

### âŒ Anti-Patterns

```java
// âŒ Testes dependentes uns dos outros
static Cliente clienteSalvo;

@Test
void test1_salvar() {
    clienteSalvo = clienteService.salvar(...);
}

@Test
void test2_atualizar() {
    clienteService.atualizar(clienteSalvo);  // âŒ Depende de test1
}

// âŒ LÃ³gica complexa em testes
@Test
void testComplexo() {
    for (int i = 0; i < 100; i++) {
        if (i % 2 == 0) {
            // ...
        }
    }
}

// âŒ Catch de exceÃ§Ãµes (use assertThrows)
@Test
void testaExcecao() {
    try {
        clienteService.salvar(null);
        fail("Deveria ter lanÃ§ado exceÃ§Ã£o");  // âŒ
    } catch (Exception e) {
        // OK
    }
}

// âœ… Use assertThrows
@Test
void deveUsar assertThrows() {
    assertThrows(ValidationException.class, () -> {
        clienteService.salvar(null);
    });
}

// âŒ Magic numbers
assertEquals(10, resultado);  // âŒ O que Ã© 10?

// âœ… Constantes descritivas
final int DESCONTO_VIP_PERCENTUAL = 10;
assertEquals(DESCONTO_VIP_PERCENTUAL, resultado);
```

---

## ğŸ“Š Exemplo Completo: Teste Bem Organizado

```java
package com.empresa.pedidos.service;

import com.empresa.pedidos.builders.ClienteTestBuilder;
import com.empresa.pedidos.builders.PedidoTestBuilder;
import com.empresa.pedidos.exception.ClienteNaoEncontradoException;
import com.empresa.pedidos.exception.EstoqueInsuficienteException;
import org.junit.jupiter.api.*;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.BDDMockito.*;

@DisplayName("PedidoService - Testes de LÃ³gica de NegÃ³cio")
@ExtendWith(MockitoExtension.class)
class PedidoServiceTest {

    @Mock
    private PedidoRepository pedidoRepository;

    @Mock
    private ClienteService clienteService;

    @Mock
    private EstoqueService estoqueService;

    @InjectMocks
    private PedidoService pedidoService;

    private Cliente clienteRegular;
    private Cliente clienteVip;
    private Produto produto;

    @BeforeEach
    void setUp() {
        clienteRegular = ClienteTestBuilder.umCliente()
                .comId(1L)
                .comNome("JoÃ£o Silva")
                .regular()
                .build();

        clienteVip = ClienteTestBuilder.umCliente()
                .comId(2L)
                .comNome("Maria Silva")
                .vip()
                .build();

        produto = ProdutoTestBuilder.umProduto()
                .comCodigo("PROD-001")
                .comNome("Notebook")
                .comPreco(new BigDecimal("3000.00"))
                .build();
    }

    @Nested
    @DisplayName("criar() - CriaÃ§Ã£o de Pedidos")
    class CriarPedidoTests {

        @Nested
        @DisplayName("CenÃ¡rios de Sucesso")
        class CenariosSucesso {

            @Test
            @DisplayName("Deve criar pedido com sucesso para cliente regular")
            void deveCriarPedidoParaClienteRegular() {
                // ========== ARRANGE ==========
                PedidoRequest request = PedidoTestBuilder.umPedidoRequest()
                        .paraCliente(clienteRegular.getId())
                        .comItem(produto.getCodigo(), 1)
                        .build();

                given(clienteService.buscarPorId(clienteRegular.getId()))
                        .willReturn(Optional.of(clienteRegular));
                given(estoqueService.verificarDisponibilidade(produto.getCodigo(), 1))
                        .willReturn(true);
                given(pedidoRepository.save(any(Pedido.class)))
                        .willAnswer(invocation -> {
                            Pedido pedido = invocation.getArgument(0);
                            pedido.setId(100L);
                            return pedido;
                        });

                // ========== ACT ==========
                PedidoResponse response = pedidoService.criar(request);

                // ========== ASSERT ==========
                assertAll("Pedido criado",
                    () -> assertNotNull(response.getId(), "ID nÃ£o pode ser nulo"),
                    () -> assertEquals(clienteRegular.getId(), response.getClienteId()),
                    () -> assertEquals(1, response.getItems().size()),
                    () -> assertTrue(response.getTotal().compareTo(BigDecimal.ZERO) > 0)
                );

                then(pedidoRepository).should().save(any(Pedido.class));
            }

            @Test
            @DisplayName("Deve aplicar desconto VIP ao criar pedido para cliente VIP")
            void deveAplicarDescontoVIP() {
                // ========== ARRANGE ==========
                final BigDecimal PRECO_PRODUTO = new BigDecimal("1000.00");
                final BigDecimal DESCONTO_VIP = new BigDecimal("100.00");  // 10%

                PedidoRequest request = PedidoTestBuilder.umPedidoRequest()
                        .paraCliente(clienteVip.getId())
                        .comItem(produto.getCodigo(), 1)
                        .build();

                given(clienteService.buscarPorId(clienteVip.getId()))
                        .willReturn(Optional.of(clienteVip));
                given(estoqueService.verificarDisponibilidade(anyString(), anyInt()))
                        .willReturn(true);

                // ========== ACT ==========
                PedidoResponse response = pedidoService.criar(request);

                // ========== ASSERT ==========
                BigDecimal totalEsperado = PRECO_PRODUTO.subtract(DESCONTO_VIP);
                assertEquals(totalEsperado, response.getTotal(),
                    "Desconto VIP de 10% deveria ter sido aplicado");
            }
        }

        @Nested
        @DisplayName("CenÃ¡rios de Erro")
        class CenariosErro {

            @Test
            @DisplayName("Deve lanÃ§ar ClienteNaoEncontradoException quando cliente nÃ£o existe")
            void deveLancarExcecaoQuandoClienteNaoExiste() {
                // ========== ARRANGE ==========
                PedidoRequest request = PedidoTestBuilder.umPedidoRequest()
                        .paraCliente(999L)
                        .build();

                given(clienteService.buscarPorId(999L))
                        .willReturn(Optional.empty());

                // ========== ACT & ASSERT ==========
                ClienteNaoEncontradoException exception = assertThrows(
                    ClienteNaoEncontradoException.class,
                    () -> pedidoService.criar(request),
                    "Deveria lanÃ§ar ClienteNaoEncontradoException"
                );

                assertTrue(exception.getMessage().contains("999"));

                then(pedidoRepository).should(never()).save(any(Pedido.class));
            }

            @Test
            @DisplayName("Deve lanÃ§ar EstoqueInsuficienteException quando produto sem estoque")
            void deveLancarExcecaoQuandoProdutoSemEstoque() {
                // ========== ARRANGE ==========
                PedidoRequest request = PedidoTestBuilder.umPedidoRequest()
                        .paraCliente(clienteRegular.getId())
                        .comItem(produto.getCodigo(), 10)
                        .build();

                given(clienteService.buscarPorId(clienteRegular.getId()))
                        .willReturn(Optional.of(clienteRegular));
                given(estoqueService.verificarDisponibilidade(produto.getCodigo(), 10))
                        .willReturn(false);

                // ========== ACT & ASSERT ==========
                assertThrows(EstoqueInsuficienteException.class,
                    () -> pedidoService.criar(request),
                    "Deveria lanÃ§ar EstoqueInsuficienteException quando estoque insuficiente"
                );

                then(pedidoRepository).should(never()).save(any(Pedido.class));
            }
        }
    }

    @Nested
    @DisplayName("cancelar() - Cancelamento de Pedidos")
    class CancelarPedidoTests {

        @Test
        @DisplayName("Deve cancelar pedido quando status Ã© PENDENTE")
        void deveCancelarPedidoQuandoStatusPendente() {
            // ========== ARRANGE ==========
            Pedido pedido = PedidoTestBuilder.umPedido()
                    .comId(1L)
                    .comStatus(StatusPedido.PENDENTE)
                    .build();

            given(pedidoRepository.findById(1L)).willReturn(Optional.of(pedido));

            // ========== ACT ==========
            pedidoService.cancelar(1L);

            // ========== ASSERT ==========
            assertEquals(StatusPedido.CANCELADO, pedido.getStatus());
            then(pedidoRepository).should().save(pedido);
        }

        @Test
        @DisplayName("Deve lanÃ§ar exceÃ§Ã£o ao cancelar pedido jÃ¡ entregue")
        void deveLancarExcecaoAoCancelarPedidoEntregue() {
            // ========== ARRANGE ==========
            Pedido pedido = PedidoTestBuilder.umPedido()
                    .comId(1L)
                    .comStatus(StatusPedido.ENTREGUE)
                    .build();

            given(pedidoRepository.findById(1L)).willReturn(Optional.of(pedido));

            // ========== ACT & ASSERT ==========
            assertThrows(PedidoNaoPodeCanceladoException.class,
                () -> pedidoService.cancelar(1L),
                "NÃ£o deveria permitir cancelar pedido jÃ¡ entregue"
            );

            then(pedidoRepository).should(never()).save(any(Pedido.class));
        }
    }
}
```

---

## ğŸ“ Resumo

**Boas PrÃ¡ticas de NomeaÃ§Ã£o** incluem:

- âœ… **ConvenÃ§Ãµes**: `deve + AÃ§Ã£o + CondiÃ§Ã£o`
- âœ… **@DisplayName**: Frases completas em portuguÃªs
- âœ… **PadrÃ£o AAA**: Arrange-Act-Assert sempre
- âœ… **@Nested**: Organizar por mÃ©todo ou cenÃ¡rio
- âœ… **Test Builders**: Facilitar criaÃ§Ã£o de dados
- âœ… **Object Mother**: Objetos reutilizÃ¡veis
- âœ… **assertAll()**: Validar mÃºltiplos aspectos
- âœ… **Mensagens descritivas**: Facilitar debug
- âœ… **Um cenÃ¡rio por teste**: Testes independentes
- âœ… **Estrutura de pacotes**: Espelhar cÃ³digo principal

**Regra de ouro:** Testes devem ser **documentaÃ§Ã£o viva** do sistema - qualquer desenvolvedor deve entender o comportamento esperado apenas **lendo o nome do teste e o cÃ³digo AAA**.
