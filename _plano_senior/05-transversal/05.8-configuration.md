# 05.8 Configuration [INTERMEDI√ÅRIO] ‚öôÔ∏è

## üéØ Objetivo

Implementar **gerenciamento de configura√ß√µes** usando **@ConfigurationProperties**, profiles, **externaliza√ß√µes** (Config Server/Consul), **type-safe bindings**, e **recarregamento din√¢mico** com @RefreshScope.

---

## üìö O Que √â?

**Configuration** √© o padr√£o para externalizar e gerenciar propriedades da aplica√ß√£o (database, cache, APIs externas, etc.) de forma **type-safe**, **test√°vel** e **independente de ambiente**.

### Analogia

Como **painel de controle centralizado**:

- **Sem Configuration**: Hardcoded em c√≥digo (recompila√ß√£o para mudar)
- **Com Configuration**: Painel externo com switches e valores ajust√°veis
- **Vantagem**: Altera√ß√µes sem recompilar ou redeploy

---

## ‚ùå Problema que Resolve

### Antes (Configura√ß√£o Hardcoded)

```java
// ‚ùå PROBLEMA: Configura√ß√£o hardcoded e n√£o test√°vel

@Service
class EmailService {

    // ‚ùå Hardcoded
    private static final String SMTP_HOST = "smtp.gmail.com";
    private static final int SMTP_PORT = 587;
    private static final String USERNAME = "noreply@empresa.com";
    private static final String PASSWORD = "senha123"; // ‚ö†Ô∏è CR√çTICO: Senha exposta

    void enviarEmail(String destinatario, String mensagem) {
        // Usa valores fixos
    }
}

@Service
class PagamentoService {

    // ‚ùå Diferentes para dev/prod, mas fixo
    private static final String API_URL = "https://api.pagamento.com";
    private static final String API_KEY = "pk_test_123"; // ‚ùå N√£o muda entre ambientes

    void processar(Pagamento pagamento) {
        // ...
    }
}
```

**Problemas:**

- ‚ùå Valores fixos (requer recompila√ß√£o)
- ‚ùå Senhas expostas no c√≥digo
- ‚ùå Sem diferencia√ß√£o de ambientes (dev/prod)
- ‚ùå Dif√≠cil testar com valores diferentes
- ‚ùå Configura√ß√£o espalhada por m√∫ltiplas classes

---

## ‚úÖ Solu√ß√£o: Externalized Configuration + Type-Safe Properties

### 1Ô∏è‚É£ application.yml (Base)

```yaml
# src/main/resources/application.yml

spring:
  application:
    name: pedidos-api

  profiles:
    active: ${ENVIRONMENT:dev} # ‚úÖ Default dev, sobrescrito por env var

# Configura√ß√µes da aplica√ß√£o
app:
  name: "Pedidos API"
  version: "1.0.0"

  # Email
  email:
    enabled: true
    smtp:
      host: smtp.gmail.com
      port: 587
      username: noreply@empresa.com
      password: ${EMAIL_PASSWORD} # ‚úÖ Externalizado via env var
    from: "noreply@empresa.com"
    timeout: 5000

  # Pagamento
  payment:
    provider: stripe
    api-url: https://api.stripe.com
    api-key: ${STRIPE_API_KEY} # ‚úÖ Externalizado
    timeout: 30000
    retry:
      max-attempts: 3
      backoff: 1000

  # Cache
  cache:
    enabled: true
    ttl: 3600
    max-size: 10000

  # Seguran√ßa
  security:
    jwt:
      secret: ${JWT_SECRET}
      expiration: 86400000 # 24 horas
      refresh-expiration: 604800000 # 7 dias
    cors:
      allowed-origins:
        - http://localhost:3000
        - https://app.empresa.com
      allowed-methods:
        - GET
        - POST
        - PUT
        - DELETE

  # Features Flags
  features:
    new-checkout: false
    loyalty-program: false
```

---

### 2Ô∏è‚É£ Profiles Espec√≠ficos

```yaml
# application-dev.yml
spring:
  datasource:
    url: jdbc:postgresql://localhost:5432/pedidos_dev
    username: dev_user
    password: dev_pass

  jpa:
    show-sql: true
    hibernate:
      ddl-auto: create-drop

app:
  email:
    enabled: false # ‚úÖ Desabilita em dev

  payment:
    api-url: https://api.stripe.com/test # ‚úÖ URL de teste

  features:
    new-checkout: true # ‚úÖ Testa feature em dev
```

```yaml
# application-prod.yml
spring:
  datasource:
    url: ${DATABASE_URL}
    username: ${DATABASE_USERNAME}
    password: ${DATABASE_PASSWORD}
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5

  jpa:
    show-sql: false
    hibernate:
      ddl-auto: validate

app:
  email:
    enabled: true

  payment:
    api-url: https://api.stripe.com # ‚úÖ URL de produ√ß√£o

  cache:
    ttl: 7200 # ‚úÖ Cache mais longo em prod

  features:
    new-checkout: false # ‚úÖ Desabilitado at√© teste completo
```

---

### 3Ô∏è‚É£ Type-Safe Configuration Properties

```java
// ‚öôÔ∏è EMAIL PROPERTIES
package com.empresa.pedidos.config.properties;

import jakarta.validation.constraints.*;
import lombok.Data;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.validation.annotation.Validated;

@Data
@Validated
@ConfigurationProperties(prefix = "app.email")
public class EmailProperties {

    private Boolean enabled = true;

    @NotNull
    private Smtp smtp = new Smtp();

    @NotBlank
    @Email
    private String from;

    @Min(1000)
    @Max(60000)
    private Integer timeout = 5000;

    @Data
    public static class Smtp {

        @NotBlank
        private String host;

        @Min(1)
        @Max(65535)
        private Integer port;

        @NotBlank
        private String username;

        @NotBlank
        private String password;
    }
}
```

```java
// ‚öôÔ∏è PAYMENT PROPERTIES
package com.empresa.pedidos.config.properties;

import jakarta.validation.constraints.*;
import lombok.Data;
import org.hibernate.validator.constraints.URL;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.validation.annotation.Validated;

@Data
@Validated
@ConfigurationProperties(prefix = "app.payment")
public class PaymentProperties {

    @NotBlank
    private String provider;

    @NotBlank
    @URL
    private String apiUrl;

    @NotBlank
    private String apiKey;

    @Min(1000)
    private Integer timeout = 30000;

    @NotNull
    private Retry retry = new Retry();

    @Data
    public static class Retry {

        @Min(1)
        @Max(10)
        private Integer maxAttempts = 3;

        @Min(100)
        private Long backoff = 1000L;
    }
}
```

```java
// ‚öôÔ∏è SECURITY PROPERTIES
package com.empresa.pedidos.config.properties;

import jakarta.validation.constraints.*;
import lombok.Data;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.validation.annotation.Validated;

import java.util.List;

@Data
@Validated
@ConfigurationProperties(prefix = "app.security")
public class SecurityProperties {

    @NotNull
    private Jwt jwt = new Jwt();

    @NotNull
    private Cors cors = new Cors();

    @Data
    public static class Jwt {

        @NotBlank
        @Size(min = 32)
        private String secret;

        @Min(60000) // M√≠nimo 1 minuto
        private Long expiration;

        @Min(60000)
        private Long refreshExpiration;
    }

    @Data
    public static class Cors {

        @NotEmpty
        private List<String> allowedOrigins;

        @NotEmpty
        private List<String> allowedMethods;
    }
}
```

---

### 4Ô∏è‚É£ Habilitando Configuration Properties

```java
// ‚öôÔ∏è CONFIGURATION
package com.empresa.pedidos.config;

import com.empresa.pedidos.config.properties.*;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.context.annotation.Configuration;

@Configuration
@EnableConfigurationProperties({
    EmailProperties.class,
    PaymentProperties.class,
    SecurityProperties.class
})
public class PropertiesConfig {
    // Habilita as properties classes
}
```

---

### 5Ô∏è‚É£ Usando Configuration Properties

```java
// üìß EMAIL SERVICE
package com.empresa.pedidos.service;

import com.empresa.pedidos.config.properties.EmailProperties;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
import org.springframework.mail.SimpleMailMessage;
import org.springframework.mail.javamail.JavaMailSender;
import org.springframework.stereotype.Service;

@Slf4j
@Service
@RequiredArgsConstructor
@ConditionalOnProperty(prefix = "app.email", name = "enabled", havingValue = "true") // ‚úÖ S√≥ ativa se enabled=true
public class EmailService {

    private final JavaMailSender mailSender;
    private final EmailProperties emailProperties;

    public void enviarEmail(String destinatario, String assunto, String mensagem) {
        if (!emailProperties.getEnabled()) {
            log.warn("Email desabilitado nas configura√ß√µes");
            return;
        }

        log.info("Enviando email: destinatario={}, smtp={}:{}",
                destinatario,
                emailProperties.getSmtp().getHost(),
                emailProperties.getSmtp().getPort());

        SimpleMailMessage message = new SimpleMailMessage();
        message.setFrom(emailProperties.getFrom());
        message.setTo(destinatario);
        message.setSubject(assunto);
        message.setText(mensagem);

        mailSender.send(message);

        log.info("Email enviado com sucesso");
    }
}
```

```java
// üí≥ PAYMENT SERVICE
package com.empresa.pedidos.service;

import com.empresa.pedidos.config.properties.PaymentProperties;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.retry.annotation.Backoff;
import org.springframework.retry.annotation.Retryable;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;

@Slf4j
@Service
@RequiredArgsConstructor
public class PaymentService {

    private final RestTemplate restTemplate;
    private final PaymentProperties paymentProperties;

    @Retryable(
            maxAttempts = 3, // ‚úÖ Poderia vir de paymentProperties.getRetry().getMaxAttempts()
            backoff = @Backoff(delay = 1000)
    )
    public PaymentResponse processar(Pagamento pagamento) {
        log.info("Processando pagamento: provider={}, url={}",
                paymentProperties.getProvider(),
                paymentProperties.getApiUrl());

        String url = paymentProperties.getApiUrl() + "/charges";

        // Configura headers com API Key
        HttpHeaders headers = new HttpHeaders();
        headers.set("Authorization", "Bearer " + paymentProperties.getApiKey());

        HttpEntity<Pagamento> request = new HttpEntity<>(pagamento, headers);

        return restTemplate.postForObject(url, request, PaymentResponse.class);
    }
}
```

---

### 6Ô∏è‚É£ Feature Flags

```java
// üö© FEATURE FLAG PROPERTIES
package com.empresa.pedidos.config.properties;

import lombok.Data;
import org.springframework.boot.context.properties.ConfigurationProperties;

@Data
@ConfigurationProperties(prefix = "app.features")
public class FeatureFlagProperties {

    private Boolean newCheckout = false;
    private Boolean loyaltyProgram = false;
    private Boolean notificationCenter = false;
}

// Uso
@Service
@RequiredArgsConstructor
class CheckoutService {

    private final FeatureFlagProperties featureFlags;

    void processar(Pedido pedido) {
        if (featureFlags.getNewCheckout()) {
            // ‚úÖ Nova vers√£o do checkout
            processarCheckoutV2(pedido);
        } else {
            // ‚úÖ Vers√£o antiga
            processarCheckoutV1(pedido);
        }
    }
}
```

---

### 7Ô∏è‚É£ Spring Cloud Config Server

#### Config Server

```yaml
# config-server/application.yml
server:
  port: 8888

spring:
  application:
    name: config-server

  cloud:
    config:
      server:
        git:
          uri: https://github.com/empresa/config-repo
          default-label: main
          search-paths:
            - pedidos-api
            - clientes-api
```

```java
// Config Server Main
@SpringBootApplication
@EnableConfigServer
public class ConfigServerApplication {
    public static void main(String[] args) {
        SpringApplication.run(ConfigServerApplication.class, args);
    }
}
```

#### Client Application

```yaml
# bootstrap.yml (client)
spring:
  application:
    name: pedidos-api

  cloud:
    config:
      uri: http://config-server:8888
      fail-fast: true
      retry:
        max-attempts: 5
        initial-interval: 1000
```

```xml
<!-- pom.xml -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-config</artifactId>
</dependency>
```

---

### 8Ô∏è‚É£ Dynamic Refresh (@RefreshScope)

```java
// üîÑ REFRESH SCOPE
package com.empresa.pedidos.service;

import com.empresa.pedidos.config.properties.PaymentProperties;
import lombok.RequiredArgsConstructor;
import org.springframework.cloud.context.config.annotation.RefreshScope;
import org.springframework.stereotype.Service;

@Service
@RefreshScope // ‚úÖ Permite recarregar configura√ß√µes sem restart
@RequiredArgsConstructor
public class PaymentService {

    private final PaymentProperties paymentProperties;

    public void processar(Pagamento pagamento) {
        // ‚úÖ Usa configura√ß√µes atualizadas ap√≥s /actuator/refresh
        String apiUrl = paymentProperties.getApiUrl();
        // ...
    }
}
```

**Endpoint para Recarregar:**

```yaml
# application.yml
management:
  endpoints:
    web:
      exposure:
        include: refresh, health, info
```

```bash
# Atualizar configura√ß√µes
curl -X POST http://localhost:8080/actuator/refresh
```

---

### 9Ô∏è‚É£ Encrypting Sensitive Properties (Jasypt)

```xml
<!-- pom.xml -->
<dependency>
    <groupId>com.github.ulisesbocchio</groupId>
    <artifactId>jasypt-spring-boot-starter</artifactId>
    <version>3.0.5</version>
</dependency>
```

```yaml
# application.yml
jasypt:
  encryptor:
    password: ${JASYPT_ENCRYPTOR_PASSWORD} # Master password via env var
    algorithm: PBEWithMD5AndDES

app:
  payment:
    api-key: ENC(G8wHvZ7xYz3kL9mN2pQ5tR6uV8wX1yZ4a) # ‚úÖ Encrypted

  security:
    jwt:
      secret: ENC(A1bC2dE3fG4hI5jK6lM7nO8pQ9rS0tU1v) # ‚úÖ Encrypted
```

**Encrypt Value:**

```bash
java -cp jasypt-1.9.3.jar \
  org.jasypt.intf.cli.JasyptPBEStringEncryptionCLI \
  input="my-secret-key" \
  password="master-password" \
  algorithm=PBEWithMD5AndDES
```

---

### üîü Consul Configuration

```xml
<!-- pom.xml -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-consul-config</artifactId>
</dependency>
```

```yaml
# bootstrap.yml
spring:
  application:
    name: pedidos-api

  cloud:
    consul:
      host: localhost
      port: 8500
      config:
        enabled: true
        format: YAML
        data-key: data
        watch:
          enabled: true # ‚úÖ Atualiza√ß√£o autom√°tica
```

**Consul UI:**

```
http://localhost:8500/ui/dc1/kv/config/pedidos-api/data/edit
```

---

## üß™ Testes de Configuration

### 1Ô∏è‚É£ Testando Properties Binding

```java
// üß™ TEST
package com.empresa.pedidos.config.properties;

import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.TestPropertySource;

import static org.assertj.core.api.Assertions.assertThat;

@SpringBootTest(classes = EmailProperties.class)
@EnableConfigurationProperties(EmailProperties.class)
@TestPropertySource(properties = {
        "app.email.enabled=true",
        "app.email.smtp.host=smtp.test.com",
        "app.email.smtp.port=587",
        "app.email.smtp.username=test@test.com",
        "app.email.smtp.password=test123",
        "app.email.from=noreply@test.com",
        "app.email.timeout=5000"
})
class EmailPropertiesTest {

    @Autowired
    private EmailProperties emailProperties;

    @Test
    void deveria_carregar_email_properties() {
        assertThat(emailProperties.getEnabled()).isTrue();
        assertThat(emailProperties.getSmtp().getHost()).isEqualTo("smtp.test.com");
        assertThat(emailProperties.getSmtp().getPort()).isEqualTo(587);
        assertThat(emailProperties.getFrom()).isEqualTo("noreply@test.com");
    }
}
```

---

### 2Ô∏è‚É£ Testando Profiles

```java
// üß™ TEST
package com.empresa.pedidos.config;

import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.ActiveProfiles;

import static org.assertj.core.api.Assertions.assertThat;

@SpringBootTest
@ActiveProfiles("dev") // ‚úÖ Testa profile dev
class DevProfileTest {

    @Value("${app.email.enabled}")
    private Boolean emailEnabled;

    @Value("${app.features.new-checkout}")
    private Boolean newCheckout;

    @Test
    void deveria_usar_configuracoes_dev() {
        assertThat(emailEnabled).isFalse(); // Desabilitado em dev
        assertThat(newCheckout).isTrue(); // Habilitado em dev
    }
}
```

---

### 3Ô∏è‚É£ Testando @ConditionalOnProperty

```java
// üß™ TEST
package com.empresa.pedidos.service;

import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.context.ApplicationContext;
import org.springframework.test.context.TestPropertySource;

import static org.assertj.core.api.Assertions.assertThat;

@SpringBootTest
@TestPropertySource(properties = {
        "app.email.enabled=false" // ‚úÖ Desabilita EmailService
})
class EmailServiceConditionalTest {

    @Autowired
    private ApplicationContext context;

    @Test
    void nao_deveria_criar_email_service_quando_desabilitado() {
        boolean exists = context.containsBean("emailService");
        assertThat(exists).isFalse();
    }
}
```

---

### 4Ô∏è‚É£ Testando com @DynamicPropertySource

```java
// üß™ TEST
package com.empresa.pedidos.service;

import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.DynamicPropertyRegistry;
import org.springframework.test.context.DynamicPropertySource;

import static org.assertj.core.api.Assertions.assertThat;

@SpringBootTest
class DynamicPropertiesTest {

    @DynamicPropertySource
    static void registerProperties(DynamicPropertyRegistry registry) {
        // ‚úÖ Define properties dinamicamente (√∫til para containers)
        registry.add("app.payment.api-url", () -> "http://mock-payment-api:8080");
        registry.add("app.payment.api-key", () -> "test-key");
    }

    @Autowired
    private PaymentService paymentService;

    @Test
    void deveria_usar_propriedades_dinamicas() {
        // Testa com configura√ß√µes injetadas dinamicamente
        assertThat(paymentService).isNotNull();
    }
}
```

---

## üìã Boas Pr√°ticas

### ‚úÖ Recomenda√ß√µes

```yaml
# ‚úÖ Use prefixos organizados
app:
  email: ...
  payment: ...
  security: ...

# ‚úÖ Externalize segredos via env vars
password: ${DATABASE_PASSWORD}

# ‚úÖ Defaults sensatos
timeout: ${TIMEOUT:5000}

# ‚úÖ Valida√ß√£o nas properties classes
@Min(1000)
@Max(60000)
private Integer timeout;

# ‚úÖ Use profiles para ambientes
spring.profiles.active: ${ENVIRONMENT:dev}

# ‚úÖ Use kebab-case para nomes
app:
  email-timeout: 5000

# ‚úÖ Agrupe configura√ß√µes relacionadas
app:
  payment:
    retry:
      max-attempts: 3
      backoff: 1000
```

---

### ‚ùå Anti-Patterns

```yaml
# ‚ùå Senhas hardcoded
password: senha123

# ‚ùå Sem defaults
timeout: # Deve ter default

# ‚ùå Sem prefixo organizado
emailHost: smtp.com
paymentUrl: https://api.com

# ‚ùå CamelCase (prefira kebab-case)
emailTimeout: 5000
# ‚ùå Valores m√°gicos espalhados
# Centralize em properties
```

```java
// ‚ùå Hardcoded
private static final String API_URL = "https://api.com";

// ‚úÖ Externalizado
@Value("${app.payment.api-url}")
private String apiUrl;
```

---

## üîç Preced√™ncia de Propriedades

Spring Boot carrega propriedades na seguinte ordem (√∫ltima sobrescreve):

1. Defaults no c√≥digo (`@Value` com default)
2. `application.yml` / `application.properties`
3. `application-{profile}.yml`
4. Environment variables (`DATABASE_PASSWORD`)
5. Command-line arguments (`--app.email.enabled=false`)
6. Config Server (Spring Cloud Config)
7. `@TestPropertySource` (em testes)

---

## ‚öñÔ∏è Vantagens e Desvantagens

### ‚úÖ Vantagens

- **Type-Safe**: `@ConfigurationProperties` com valida√ß√£o
- **Test√°vel**: `@TestPropertySource`, `@DynamicPropertySource`
- **Profiles**: Configura√ß√µes espec√≠ficas por ambiente
- **Externalized**: Segredos em env vars / Config Server
- **Recarreg√°vel**: `@RefreshScope` para updates din√¢micos

### ‚ö†Ô∏è Desvantagens

- **Complexidade**: Config Server adiciona depend√™ncia externa
- **Seguran√ßa**: Exige cuidado com secrets (use Vault/Jasypt)
- **Ordem de preced√™ncia**: Pode confundir iniciantes

---

## üéØ Quando Usar?

| Cen√°rio                   | Solu√ß√£o                    |
| ------------------------- | -------------------------- |
| Configura√ß√£o simples      | `application.yml`          |
| Type-safe properties      | `@ConfigurationProperties` |
| Segredos sens√≠veis        | Env vars + Jasypt          |
| M√∫ltiplos ambientes       | Profiles (dev/prod)        |
| Configura√ß√£o centralizada | Config Server / Consul     |
| Atualiza√ß√£o sem restart   | `@RefreshScope` + actuator |

---

## üîó Recursos

- [Spring Boot Externalized Configuration](https://docs.spring.io/spring-boot/reference/features/external-config.html)
- [Configuration Properties](https://docs.spring.io/spring-boot/reference/configuration-metadata/annotation-processor.html)
- [Spring Cloud Config](https://spring.io/projects/spring-cloud-config)
- [Jasypt Spring Boot](https://github.com/ulisesbocchio/jasypt-spring-boot)

---

## üìù Resumo

**Configuration Management** com Spring Boot garante:

- ‚úÖ Type-safe properties com `@ConfigurationProperties`
- ‚úÖ Valida√ß√£o autom√°tica de configura√ß√µes
- ‚úÖ Profiles para diferentes ambientes (dev/prod)
- ‚úÖ Externaliza√ß√£o de segredos (env vars, Jasypt)
- ‚úÖ Configura√ß√£o centralizada (Config Server/Consul)
- ‚úÖ Recarregamento din√¢mico com `@RefreshScope`

**Regra de ouro:** Externalize tudo que varia entre ambientes, use type-safe properties, e NUNCA commite segredos no c√≥digo.
