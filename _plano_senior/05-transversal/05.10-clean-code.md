# 05.10 Clean Code [INTERMEDI√ÅRIO] ‚ú®

## üéØ Objetivo

Escrever c√≥digo **limpo**, **leg√≠vel** e **manuten√≠vel** seguindo as pr√°ticas de **Clean Code** de Robert C. Martin (Uncle Bob) aplicadas a Java/Spring Boot.

---

## üìö O Que √â Clean Code?

**Clean Code** √© c√≥digo que:

- √â **f√°cil de ler** (como prosa bem escrita)
- √â **f√°cil de entender** (inten√ß√£o clara)
- √â **f√°cil de modificar** (baixo acoplamento)
- √â **f√°cil de testar** (test√°vel por design)

### Analogia

Como **livro bem escrito**:

- **C√≥digo Sujo**: Par√°grafo confuso que precisa ser relido 10 vezes
- **C√≥digo Limpo**: Frase clara que se entende na primeira leitura
- **Vantagem**: Menos tempo debugando, mais tempo criando valor

---

## üìõ Nomes Significativos

### ‚ùå Nomes Ruins

```java
// ‚ùå PROBLEMA: Nomes n√£o revelam inten√ß√£o

public class Data {
    private int d; // Dias? Data? Delta?
    private List<int[]> lst; // Lista de qu√™?

    public List<int[]> getThem() { // Pegar o qu√™?
        List<int[]> list1 = new ArrayList<>();
        for (int[] x : lst) {
            if (x[0] == 4) { // M√°gico: 4 significa o qu√™?
                list1.add(x);
            }
        }
        return list1;
    }
}
```

### ‚úÖ Nomes que Revelam Inten√ß√£o

```java
// ‚úÖ SOLU√á√ÉO: Nomes auto-explicativos

public class Campo {
    private static final int STATUS_MARCADO = 4;

    private List<Celula> celulas;

    public List<Celula> getCelulasMarcadas() {
        List<Celula> celulasMarcadas = new ArrayList<>();
        for (Celula celula : celulas) {
            if (celula.estaMarcada()) {
                celulasMarcadas.add(celula);
            }
        }
        return celulasMarcadas;
    }
}

public class Celula {
    private int status;

    public boolean estaMarcada() {
        return status == STATUS_MARCADO;
    }
}
```

### Regras para Nomes

```java
// ‚úÖ Use nomes pronunci√°veis
class ClienteRegistroData {} // ‚úÖ
class ClntRgDt {} // ‚ùå

// ‚úÖ Use nomes busc√°veis
int diasDesdeModificacao = 7; // ‚úÖ
int d = 7; // ‚ùå

// ‚úÖ Evite codifica√ß√£o
String nome; // ‚úÖ
String nomeStr; // ‚ùå (tipo j√° √© evidente)
String sNome; // ‚ùå (nota√ß√£o h√∫ngara)

// ‚úÖ Classes: substantivos
class Cliente {} // ‚úÖ
class Pedido {} // ‚úÖ
class Processar {} // ‚ùå (verbo)

// ‚úÖ M√©todos: verbos
void salvar() {} // ‚úÖ
void buscarPorId() {} // ‚úÖ
void nome() {} // ‚ùå (n√£o √© verbo)

// ‚úÖ Booleanos: perguntas
boolean isAtivo; // ‚úÖ
boolean temEstoque; // ‚úÖ
boolean podeSerProcessado; // ‚úÖ
boolean status; // ‚ùå (n√£o √© pergunta)

// ‚úÖ Constantes: UPPER_SNAKE_CASE
public static final int MAX_TENTATIVAS = 3; // ‚úÖ
public static final String urlPadrao = "..."; // ‚ùå
```

---

## üîß Fun√ß√µes

### Pequenas e Focadas

```java
// ‚ùå PROBLEMA: Fun√ß√£o longa e complexa

public void processarPedido(Pedido pedido) {
    // Valida√ß√£o
    if (pedido.getItens().isEmpty()) {
        throw new ValidationException("Pedido vazio");
    }
    if (pedido.getClienteId() == null) {
        throw new ValidationException("Cliente inv√°lido");
    }

    // C√°lculo
    BigDecimal total = BigDecimal.ZERO;
    for (ItemPedido item : pedido.getItens()) {
        BigDecimal subtotal = item.getPreco().multiply(BigDecimal.valueOf(item.getQuantidade()));
        total = total.add(subtotal);
    }
    pedido.setTotal(total);

    // Desconto
    Cliente cliente = clienteRepository.findById(pedido.getClienteId()).orElseThrow();
    if (cliente.getTipo() == TipoCliente.VIP) {
        BigDecimal desconto = total.multiply(BigDecimal.valueOf(0.10));
        total = total.subtract(desconto);
    }

    // Persist√™ncia
    pedidoRepository.save(pedido);

    // Notifica√ß√£o
    emailService.enviar(cliente.getEmail(), "Pedido processado");
}
```

### ‚úÖ Fun√ß√µes Pequenas e √önicas

```java
// ‚úÖ SOLU√á√ÉO: Dividir em fun√ß√µes focadas

public void processarPedido(Pedido pedido) {
    validarPedido(pedido);
    calcularTotal(pedido);
    aplicarDesconto(pedido);
    salvarPedido(pedido);
    notificarCliente(pedido);
}

private void validarPedido(Pedido pedido) {
    if (pedido.getItens().isEmpty()) {
        throw new ValidationException("Pedido vazio");
    }
    if (pedido.getClienteId() == null) {
        throw new ValidationException("Cliente inv√°lido");
    }
}

private void calcularTotal(Pedido pedido) {
    BigDecimal total = pedido.getItens().stream()
            .map(this::calcularSubtotal)
            .reduce(BigDecimal.ZERO, BigDecimal::add);
    pedido.setTotal(total);
}

private BigDecimal calcularSubtotal(ItemPedido item) {
    return item.getPreco().multiply(BigDecimal.valueOf(item.getQuantidade()));
}

private void aplicarDesconto(Pedido pedido) {
    Cliente cliente = buscarCliente(pedido.getClienteId());
    if (cliente.getTipo() == TipoCliente.VIP) {
        BigDecimal desconto = calcularDescontoVip(pedido.getTotal());
        pedido.setTotal(pedido.getTotal().subtract(desconto));
    }
}

private BigDecimal calcularDescontoVip(BigDecimal total) {
    return total.multiply(BigDecimal.valueOf(0.10));
}

private void salvarPedido(Pedido pedido) {
    pedidoRepository.save(pedido);
}

private void notificarCliente(Pedido pedido) {
    Cliente cliente = buscarCliente(pedido.getClienteId());
    emailService.enviar(cliente.getEmail(), "Pedido processado");
}

private Cliente buscarCliente(Long clienteId) {
    return clienteRepository.findById(clienteId).orElseThrow();
}
```

### Regras para Fun√ß√µes

```java
// ‚úÖ 1. Fa√ßa uma coisa s√≥
public void salvarCliente(Cliente cliente) {
    repository.save(cliente); // ‚úÖ Apenas salva
}

// ‚ùå
public void salvarClienteEEnviarEmail(Cliente cliente) {
    repository.save(cliente);
    emailService.enviar(...); // ‚ùå Faz duas coisas
}

// ‚úÖ 2. Use poucos par√¢metros (m√°ximo 3)
public void criar(String nome, String email) {} // ‚úÖ 2 par√¢metros

public void criar(String nome, String email, String telefone,
                  String endereco, String cidade, String estado) {} // ‚ùå 6 par√¢metros

// Melhor: usar objeto
public void criar(ClienteRequest request) {} // ‚úÖ 1 par√¢metro (objeto)

// ‚úÖ 3. Sem side effects
public boolean validarSenha(String senha) {
    if (senha.length() < 8) {
        return false;
    }
    Session.initialize(); // ‚ùå Side effect escondido
    return true;
}

// ‚úÖ 4. Command-Query Separation
public boolean isAtivo() { return ativo; } // ‚úÖ Query (n√£o muda estado)
public void ativar() { this.ativo = true; } // ‚úÖ Command (muda estado)

public boolean ativarSeInativo() { // ‚ùå Faz as duas coisas
    if (!ativo) {
        ativo = true;
        return true;
    }
    return false;
}
```

---

## üí¨ Coment√°rios

### ‚ùå Coment√°rios Ruins

```java
// ‚ùå PROBLEMA: Coment√°rios desnecess√°rios ou enganosos

// Verifica se o cliente tem mais de 18 anos
if (cliente.getIdade() > 18) { // ‚ùå Coment√°rio √≥bvio
    // ...
}

// Incrementa i
i++; // ‚ùå Coment√°rio in√∫til

// TODO: Implementar valida√ß√£o (escrito em 2020)
// ‚ùå TODO nunca implementado

// Fix tempor√°rio (n√£o √© tempor√°rio h√° 3 anos)
// ‚ùå Coment√°rio mentiroso

/**
 * @param nome o nome
 * @param email o email
 * @return o cliente
 */
public Cliente criar(String nome, String email) { // ‚ùå Javadoc in√∫til
    // ...
}
```

### ‚úÖ C√≥digo Auto-Explicativo

```java
// ‚úÖ SOLU√á√ÉO: C√≥digo que n√£o precisa de coment√°rios

// ‚ùå Antes
if (cliente.getIdade() > 18) { // Maior de idade

// ‚úÖ Depois
if (cliente.isMaiorDeIdade()) { // M√©todo revela inten√ß√£o

// ‚ùå Antes
// Verifica se pedido pode ser cancelado (menos de 24h e n√£o enviado)
if (pedido.getDataCriacao().plusHours(24).isAfter(LocalDateTime.now())
        && pedido.getStatus() != Status.ENVIADO) {

// ‚úÖ Depois
if (pedido.podeCancelar()) { // M√©todo encapsula l√≥gica

public boolean podeCancelar() {
    boolean dentroDoPrazo = dataCriacao.plusHours(24).isAfter(LocalDateTime.now());
    boolean naoEnviado = status != Status.ENVIADO;
    return dentroDoPrazo && naoEnviado;
}
```

### Coment√°rios Aceit√°veis

```java
// ‚úÖ Explicar inten√ß√£o de decis√£o complexa
// Usamos ConcurrentHashMap ao inv√©s de HashMap porque este m√©todo
// pode ser chamado por m√∫ltiplas threads simultaneamente
private final Map<String, Cliente> cache = new ConcurrentHashMap<>();

// ‚úÖ Avisar sobre consequ√™ncias
// AVISO: Este m√©todo pode demorar at√© 30 segundos para processar lotes grandes
public void processarLote(List<Pedido> pedidos) {
    // ...
}

// ‚úÖ TODO leg√≠timo com deadline
// TODO: Implementar retry ap√≥s vers√£o 2.0 (deadline: 2025-12-01)

// ‚úÖ Explicar regex complexo
// Formato: +55 (11) 98765-4321
Pattern pattern = Pattern.compile("^\\+55 \\(\\d{2}\\) \\d{5}-\\d{4}$");

// ‚úÖ Javadoc para APIs p√∫blicas
/**
 * Calcula desconto baseado no tipo de cliente.
 *
 * @param total valor total do pedido
 * @param tipo tipo de cliente (VIP, GOLD, SILVER)
 * @return valor do desconto calculado
 * @throws IllegalArgumentException se total for negativo
 */
public BigDecimal calcularDesconto(BigDecimal total, TipoCliente tipo) {
    // ...
}
```

---

## üì¶ Formata√ß√£o

### Vertical

```java
// ‚úÖ Conceitos relacionados pr√≥ximos

public class PedidoService {

    // Depend√™ncias agrupadas
    private final PedidoRepository repository;
    private final ClienteRepository clienteRepository;
    private final EmailService emailService;

    // Construtor pr√≥ximo das depend√™ncias
    public PedidoService(PedidoRepository repository,
                         ClienteRepository clienteRepository,
                         EmailService emailService) {
        this.repository = repository;
        this.clienteRepository = clienteRepository;
        this.emailService = emailService;
    }

    // M√©todos p√∫blicos primeiro
    public Pedido criar(PedidoRequest request) {
        validarRequest(request);
        Pedido pedido = construirPedido(request);
        return salvarENotificar(pedido);
    }

    // M√©todos privados auxiliares depois (ordem de chamada)
    private void validarRequest(PedidoRequest request) {
        // ...
    }

    private Pedido construirPedido(PedidoRequest request) {
        // ...
    }

    private Pedido salvarENotificar(Pedido pedido) {
        // ...
    }
}
```

### Horizontal

```java
// ‚úÖ Linhas curtas (m√°ximo 120 caracteres)

// ‚ùå Linha muito longa
String mensagem = "Ol√° " + cliente.getNome() + ", seu pedido " + pedido.getId() + " foi processado com sucesso em " + pedido.getDataCriacao() + " e ser√° entregue em " + pedido.getDataEntrega();

// ‚úÖ Quebrado adequadamente
String mensagem = String.format(
        "Ol√° %s, seu pedido %d foi processado com sucesso em %s e ser√° entregue em %s",
        cliente.getNome(),
        pedido.getId(),
        pedido.getDataCriacao(),
        pedido.getDataEntrega()
);

// ‚úÖ Indenta√ß√£o consistente
public void processar() {
    if (condicao1) {
        if (condicao2) {
            if (condicao3) {
                // N√≠vel 3 de indenta√ß√£o
            }
        }
    }
}

// ‚ùå M√∫ltiplas declara√ß√µes na mesma linha
int a = 1; int b = 2; int c = 3;

// ‚úÖ Uma por linha
int a = 1;
int b = 2;
int c = 3;
```

---

## üö´ Tratamento de Erros

### ‚ùå Try-Catch Poluindo L√≥gica

```java
// ‚ùå PROBLEMA: L√≥gica misturada com tratamento de erro

public void processar(Pedido pedido) {
    try {
        validarPedido(pedido);
    } catch (ValidationException e) {
        log.error("Erro valida√ß√£o", e);
        throw e;
    }

    try {
        calcularTotal(pedido);
    } catch (Exception e) {
        log.error("Erro c√°lculo", e);
        throw new BusinessException("Erro ao calcular", e);
    }

    try {
        repository.save(pedido);
    } catch (DataAccessException e) {
        log.error("Erro persist√™ncia", e);
        throw new DatabaseException("Erro ao salvar", e);
    }
}
```

### ‚úÖ Separar L√≥gica de Tratamento

```java
// ‚úÖ SOLU√á√ÉO: Delegar tratamento para camada superior

@Service
public class PedidoService {

    public Pedido processar(PedidoRequest request) {
        // ‚úÖ L√≥gica limpa, sem try-catch
        validarRequest(request);
        Pedido pedido = construirPedido(request);
        calcularTotal(pedido);
        return repository.save(pedido);
    }

    // M√©todos lan√ßam exce√ß√µes espec√≠ficas
    private void validarRequest(PedidoRequest request) {
        if (request.getItens().isEmpty()) {
            throw new ValidationException("Pedido vazio");
        }
    }
}

// ‚úÖ Tratamento centralizado
@RestControllerAdvice
public class GlobalExceptionHandler {

    @ExceptionHandler(ValidationException.class)
    public ResponseEntity<ErrorResponse> handleValidation(ValidationException ex) {
        log.error("Erro de valida√ß√£o", ex);
        ErrorResponse error = new ErrorResponse(ex.getMessage());
        return ResponseEntity.badRequest().body(error);
    }

    @ExceptionHandler(DatabaseException.class)
    public ResponseEntity<ErrorResponse> handleDatabase(DatabaseException ex) {
        log.error("Erro de banco de dados", ex);
        ErrorResponse error = new ErrorResponse("Erro interno");
        return ResponseEntity.status(500).body(error);
    }
}
```

### Use Exce√ß√µes, N√£o C√≥digos de Erro

```java
// ‚ùå C√≥digos de erro
public int salvar(Cliente cliente) {
    if (cliente.getNome() == null) {
        return -1; // Erro
    }
    repository.save(cliente);
    return 0; // Sucesso
}

// Uso complexo
int resultado = service.salvar(cliente);
if (resultado == -1) {
    // Tratar erro
} else if (resultado == 0) {
    // Sucesso
}

// ‚úÖ Exce√ß√µes
public void salvar(Cliente cliente) {
    if (cliente.getNome() == null) {
        throw new ValidationException("Nome obrigat√≥rio");
    }
    repository.save(cliente);
}

// Uso limpo
try {
    service.salvar(cliente);
    // Sucesso
} catch (ValidationException e) {
    // Tratar erro
}
```

---

## üèóÔ∏è Classes

### Coes√£o

```java
// ‚ùå Baixa coes√£o: classe com m√©todos n√£o relacionados

public class UtilityHelper {
    public String formatarCpf(String cpf) { }
    public BigDecimal calcularDesconto(BigDecimal total) { }
    public void enviarEmail(String destinatario) { }
    public LocalDate parseData(String data) { }
}

// ‚úÖ Alta coes√£o: classes focadas

public class CpfFormatter {
    public String formatar(String cpf) { }
}

public class DescontoCalculator {
    public BigDecimal calcular(BigDecimal total) { }
}

public class EmailSender {
    public void enviar(String destinatario, String mensagem) { }
}

public class DateParser {
    public LocalDate parse(String data) { }
}
```

### Organiza√ß√£o

```java
// ‚úÖ Ordem recomendada

public class PedidoService {

    // 1. Constantes
    private static final int MAX_ITENS = 100;

    // 2. Campos est√°ticos
    private static int contador = 0;

    // 3. Campos de inst√¢ncia
    private final PedidoRepository repository;
    private final EmailService emailService;

    // 4. Construtores
    public PedidoService(PedidoRepository repository, EmailService emailService) {
        this.repository = repository;
        this.emailService = emailService;
    }

    // 5. M√©todos p√∫blicos
    public Pedido criar(PedidoRequest request) {
        // ...
    }

    public Pedido buscar(Long id) {
        // ...
    }

    // 6. M√©todos privados (ordem de uso)
    private void validar(PedidoRequest request) {
        // ...
    }

    private Pedido construir(PedidoRequest request) {
        // ...
    }
}
```

---

## üß™ Testes Limpos

### Padr√£o AAA (Arrange-Act-Assert)

```java
// ‚úÖ Testes leg√≠veis

@Test
void deveria_calcular_desconto_vip_corretamente() {
    // Arrange (Given)
    Pedido pedido = new Pedido();
    pedido.setTotal(new BigDecimal("100.00"));

    Cliente cliente = new Cliente();
    cliente.setTipo(TipoCliente.VIP);

    // Act (When)
    BigDecimal desconto = service.calcularDesconto(pedido, cliente);

    // Assert (Then)
    assertThat(desconto).isEqualByComparingTo(new BigDecimal("10.00"));
}

@Test
void deveria_lancar_excecao_quando_pedido_vazio() {
    // Arrange
    PedidoRequest request = new PedidoRequest();
    request.setItens(Collections.emptyList());

    // Act & Assert
    assertThatThrownBy(() -> service.criar(request))
            .isInstanceOf(ValidationException.class)
            .hasMessage("Pedido vazio");
}
```

### Um Assert Por Teste (Ideal)

```java
// ‚ùå M√∫ltiplos asserts n√£o relacionados
@Test
void teste() {
    Pedido pedido = service.criar(request);

    assertThat(pedido.getId()).isNotNull();
    assertThat(pedido.getTotal()).isPositive();
    assertThat(pedido.getStatus()).isEqualTo(Status.PENDENTE);
    assertThat(pedido.getItens()).hasSize(2);
}

// ‚úÖ Testes focados
@Test
void deveria_gerar_id_ao_criar() {
    Pedido pedido = service.criar(request);
    assertThat(pedido.getId()).isNotNull();
}

@Test
void deveria_calcular_total_positivo() {
    Pedido pedido = service.criar(request);
    assertThat(pedido.getTotal()).isPositive();
}

@Test
void deveria_iniciar_com_status_pendente() {
    Pedido pedido = service.criar(request);
    assertThat(pedido.getStatus()).isEqualTo(Status.PENDENTE);
}
```

---

## üìã Checklist Clean Code

### Nomes

- [ ] Nomes revelam inten√ß√£o?
- [ ] Nomes s√£o pronunci√°veis e busc√°veis?
- [ ] Sem codifica√ß√£o (nota√ß√£o h√∫ngara)?
- [ ] Classes s√£o substantivos, m√©todos s√£o verbos?

### Fun√ß√µes

- [ ] Fun√ß√µes pequenas (menos de 20 linhas)?
- [ ] Uma responsabilidade por fun√ß√£o?
- [ ] Poucos par√¢metros (m√°ximo 3)?
- [ ] Sem side effects?

### Coment√°rios

- [ ] C√≥digo auto-explicativo (coment√°rios m√≠nimos)?
- [ ] Sem coment√°rios obsoletos ou enganosos?
- [ ] Javadoc apenas em APIs p√∫blicas?

### Formata√ß√£o

- [ ] Linhas curtas (m√°ximo 120 caracteres)?
- [ ] Indenta√ß√£o consistente?
- [ ] Conceitos relacionados pr√≥ximos?

### Tratamento de Erros

- [ ] Exce√ß√µes ao inv√©s de c√≥digos de erro?
- [ ] Tratamento centralizado?
- [ ] L√≥gica separada de tratamento?

### Classes

- [ ] Alta coes√£o?
- [ ] Baixo acoplamento?
- [ ] Organiza√ß√£o clara?

### Testes

- [ ] Padr√£o AAA (Arrange-Act-Assert)?
- [ ] Um conceito por teste?
- [ ] Nomes descritivos?

---

## ‚öñÔ∏è Clean Code vs. Performance

```java
// ‚ùå Otimiza√ß√£o prematura
public int calcular(int n) {
    // C√≥digo complexo e ileg√≠vel "otimizado"
    return (n * (n + 1)) >> 1;
}

// ‚úÖ C√≥digo limpo primeiro
public int calcularSoma(int n) {
    int soma = 0;
    for (int i = 1; i <= n; i++) {
        soma += i;
    }
    return soma;
}

// ‚úÖ Otimizar APENAS se necess√°rio (com benchmark)
public int calcularSomaOtimizado(int n) {
    // F√≥rmula de Gauss (documentada)
    return n * (n + 1) / 2;
}
```

**Regra:** Clean code primeiro, otimiza√ß√£o depois (apenas se necess√°rio).

---

## üéØ Quando Aplicar?

| Situa√ß√£o                 | Clean Code?    |
| ------------------------ | -------------- |
| C√≥digo novo              | ‚úÖ Sempre      |
| Refatora√ß√£o              | ‚úÖ Sempre      |
| Hotfix urgente           | ‚ö†Ô∏è Depois      |
| C√≥digo legado (mantendo) | ‚ö†Ô∏è Incremental |
| Performance cr√≠tica      | ‚ö†Ô∏è Balancear   |

---

## üîó Recursos

- **Clean Code** (Robert C. Martin) - [Amazon](https://www.amazon.com/Clean-Code-Handbook-Software-Craftsmanship/dp/0132350882)
- **Refactoring** (Martin Fowler) - [refactoring.com](https://refactoring.com/)
- **Effective Java** (Joshua Bloch) - [Amazon](https://www.amazon.com/Effective-Java-Joshua-Bloch/dp/0134685997)

---

## üìù Resumo

**Clean Code** garante:

- ‚úÖ **Legibilidade**: C√≥digo como prosa
- ‚úÖ **Manutenibilidade**: F√°cil modificar
- ‚úÖ **Testabilidade**: F√°cil testar
- ‚úÖ **Escalabilidade**: F√°cil evoluir

**Regra de ouro:** Deixe o c√≥digo **mais limpo** do que encontrou (regra do escoteiro).

**Cita√ß√£o:**

> "Any fool can write code that a computer can understand. Good programmers write code that humans can understand." - Martin Fowler
