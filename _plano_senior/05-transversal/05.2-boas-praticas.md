# 5.2 Boas Pr√°ticas de Testes [TODOS OS N√çVEIS]

üéØ **Objetivo:** Consolidar conven√ß√µes pr√°ticas que tornam testes mais leg√≠veis, manuten√≠veis e eficazes no longo prazo.

---

## üìù Nomea√ß√£o Clara de Testes

### Padr√µes Recomendados

#### Portugu√™s

- `deve[Verbo][Condi√ß√£o]`
- `naoDeve[Verbo][Condi√ß√£o]`
- `quando[Contexto]Entao[Resultado]`
- `lanca[Excecao]Se[Condi√ß√£o]`

#### English

- `should[Verb][Condition]`
- `shouldNot[Verb][Condition]`
- `when[Context]Then[Outcome]`
- `throws[Exception]If[Condition]`

### Exemplos Pr√°ticos

```java
// ‚úÖ BOM - Inten√ß√£o clara
@Test
void deveRetornarErroAoSalvarUsuarioSemEmail() { }

@Test
void naoDeveAceitarCpfInvalido() { }

@Test
void quandoStatusForInativoEntaoBloqueiaAcesso() { }

@Test
void lancaIllegalArgumentSeValorNulo() { }

// ‚ùå RUIM - Vago, sem contexto
@Test
void testeEmail() { }

@Test
void teste1() { }

@Test
void validarCpf() { } // Valida como? O que espera?
```

### @DisplayName Bil√≠ngue

Combine m√©todo em portugu√™s com descri√ß√£o em ingl√™s (ou vice-versa) para times internacionais:

```java
@Test
@DisplayName("Deve rejeitar CPF inv√°lido / Should reject invalid CPF")
void deveRejeitarCpfInvalido() {
    assertFalse(validator.validarCpf("123.456.789-00"));
}

@Nested
@DisplayName("Valida√ß√£o de e-mail / Email validation")
class EmailValidation {

    @Test
    @DisplayName("Aceita e-mail bem formado / Accepts well-formed email")
    void deveAceitarEmailValido() {
        assertTrue(service.emailValido("user@example.com"));
    }

    @Test
    @DisplayName("Rejeita e-mail sem @ / Rejects email missing @")
    void naoDeveAceitarEmailSemArroba() {
        assertFalse(service.emailValido("userexample.com"));
    }
}
```

### Testes Parametrizados: Placeholders Descritivos

```java
@ParameterizedTest(name = "[{index}] CPF inv√°lido: ''{0}'' / Invalid CPF: ''{0}''")
@ValueSource(strings = {"123.456.789-00", "000.000.000-00", "111.111.111-11"})
void deveRejeitarCpfsInvalidos(String cpf) {
    assertFalse(validator.validar(cpf));
}

@ParameterizedTest(name = "Caso {index}: {0} + {1} = {2}")
@CsvSource({"1,2,3", "5,5,10", "-2,2,0"})
void deveSomarCorretamente(int a, int b, int esperado) {
    assertEquals(esperado, calc.somar(a, b));
}
```

---

## üéØ Organiza√ß√£o com @Nested

Agrupe testes relacionados em classes internas para melhor estrutura:

```java
class CarrinhoDeComprasTest {

    @Nested
    @DisplayName("Adi√ß√£o de Produtos")
    class AdicaoProdutos {

        @Test
        void deveAdicionarProdutoValido() { }

        @Test
        void naoDeveAdicionarProdutoNulo() { }

        @Test
        void deveIncrementarQuantidadeSeJaExiste() { }
    }

    @Nested
    @DisplayName("C√°lculo de Total")
    class CalculoTotal {

        @Test
        void deveCalcularTotalComUmProduto() { }

        @Test
        void deveCalcularTotalComMultiplosProdutos() { }

        @Test
        void deveAplicarDescontoSeElegivel() { }
    }

    @Nested
    @DisplayName("Finaliza√ß√£o de Compra")
    class Finalizacao {

        @Test
        void deveLimparCarrinhoAposFinalizar() { }

        @Test
        void lancaExcecaoSeCarrinhoVazio() { }
    }
}
```

**Benef√≠cios:**

- ‚úÖ Estrutura visual clara no relat√≥rio de testes
- ‚úÖ Compartilhamento de setup via `@BeforeEach` na nested class
- ‚úÖ Facilita navega√ß√£o em su√≠tes grandes

---

## üîß Setup e Teardown Eficientes

### @BeforeEach vs @BeforeAll

```java
class ExemploSetupTest {

    // ‚úÖ Use @BeforeAll para recursos caros compartilhados
    @BeforeAll
    static void setupGlobal() {
        // Conex√£o DB, leitura de arquivo grande, etc.
        ConexaoDB.inicializar();
    }

    // ‚úÖ Use @BeforeEach para estado fresco por teste
    @BeforeEach
    void setupPorTeste() {
        // Lista vazia, mock novo, objeto resetado
        lista = new ArrayList<>();
        service = new UsuarioService();
    }

    @Test
    void teste1() { /* lista est√° vazia aqui */ }

    @Test
    void teste2() { /* lista est√° vazia novamente */ }

    @AfterEach
    void limpeza() {
        // Fechar recursos espec√≠ficos do teste
    }

    @AfterAll
    static void limpezaGlobal() {
        ConexaoDB.fechar();
    }
}
```

### ‚ö† Evite Estado Compartilhado Mut√°vel

```java
// ‚ùå RUIM - Campo est√°tico mut√°vel
class TesteFr√°gil {
    static List<String> cache = new ArrayList<>(); // ‚ö†Ô∏è PERIGO

    @Test
    void teste1() {
        cache.add("A");
        assertEquals(1, cache.size()); // Falha se teste2 rodou antes
    }

    @Test
    void teste2() {
        cache.clear();
        assertTrue(cache.isEmpty());
    }
}

// ‚úÖ BOM - Campo de inst√¢ncia + @BeforeEach
class TesteRobusto {
    List<String> cache; // Inst√¢ncia

    @BeforeEach
    void setup() {
        cache = new ArrayList<>(); // Reset autom√°tico
    }

    @Test
    void teste1() {
        cache.add("A");
        assertEquals(1, cache.size());
    }

    @Test
    void teste2() {
        assertTrue(cache.isEmpty()); // Sempre vazio aqui
    }
}
```

---

## üìä Assertions Expressivas

### Use assertAll para M√∫ltiplas Valida√ß√µes

```java
// ‚ùå RUIM - Primeira falha oculta as demais
@Test
void validarUsuario() {
    assertEquals("Admin", user.getNome());
    assertEquals("admin@test.com", user.getEmail()); // Nunca executa se acima falhar
    assertTrue(user.isAtivo());
}

// ‚úÖ BOM - Mostra todas as falhas
@Test
void validarUsuario() {
    assertAll("Valida√ß√£o de Usu√°rio",
        () -> assertEquals("Admin", user.getNome()),
        () -> assertEquals("admin@test.com", user.getEmail()),
        () -> assertTrue(user.isAtivo())
    );
}
```

### Mensagens de Erro √öteis

```java
// ‚ùå Mensagem vaga
assertEquals(200, response.getStatus());

// ‚úÖ Contexto claro
assertEquals(200, response.getStatus(),
    "API deve retornar 200 OK para requisi√ß√£o v√°lida");

// ‚úÖ Mensagem din√¢mica
assertEquals(expected, actual,
    () -> String.format("Esperado %s mas obteve %s para entrada %s",
        expected, actual, input));
```

### assertThrows com Valida√ß√£o de Mensagem

```java
@Test
void deveLancarExcecaoComMensagem() {
    IllegalArgumentException ex = assertThrows(
        IllegalArgumentException.class,
        () -> service.processar(null)
    );

    assertTrue(ex.getMessage().contains("n√£o pode ser nulo"),
        "Mensagem de erro deve indicar par√¢metro nulo");
}
```

---

## üß™ Testes Parametrizados: Boas Pr√°ticas

### 1. Nomes Descritivos

```java
// ‚ùå Gen√©rico
@ParameterizedTest
@ValueSource(ints = {2, 4, 6})
void teste(int n) { }

// ‚úÖ Espec√≠fico
@ParameterizedTest(name = "N√∫mero {0} deve ser par")
@ValueSource(ints = {2, 4, 6, 8, 10})
void deveIdentificarNumerosPares(int numero) { }
```

### 2. Fontes Externas para Muitos Dados

```java
// ‚ùå RUIM - Polui√ß√£o no c√≥digo
@CsvSource({
    "1,2,3", "4,5,9", "10,20,30", /* ...50 linhas... */
})

// ‚úÖ BOM - Arquivo externo
@CsvFileSource(resources = "/dados-calculo.csv", numLinesToSkip = 1)
void deveSomarCorretamente(int a, int b, int esperado) { }
```

**Arquivo:** `src/test/resources/dados-calculo.csv`

```csv
a,b,esperado
1,2,3
4,5,9
10,20,30
```

### 3. Reutilizar @MethodSource

```java
// Classe utilit√°ria
class TestDataFactory {
    static Stream<Arguments> usuariosValidos() {
        return Stream.of(
            Arguments.of(new Usuario("Admin", "admin@test.com"), true),
            Arguments.of(new Usuario("User", "user@test.com"), true)
        );
    }

    static Stream<Arguments> usuariosInvalidos() {
        return Stream.of(
            Arguments.of(new Usuario("", "email@test.com"), false),
            Arguments.of(new Usuario("User", "invalido"), false)
        );
    }
}

// Reutilizar em m√∫ltiplos testes
class ValidacaoTest {
    @ParameterizedTest
    @MethodSource("com.exemplo.TestDataFactory#usuariosValidos")
    void deveAceitarUsuariosValidos(Usuario u, boolean esperado) { }
}
```

### 4. Um Conceito por Teste

```java
// ‚ùå RUIM - Mistura valida√ß√µes diferentes
@ParameterizedTest
@CsvSource({
    "12345678901, true",  // CPF v√°lido
    "user@test.com, true" // Email v√°lido (??)
})
void validar(String valor, boolean esperado) { } // O que valida?

// ‚úÖ BOM - Testes separados
@ParameterizedTest
@ValueSource(strings = {"12345678901", "98765432100"})
void deveValidarCpf(String cpf) { }

@ParameterizedTest
@ValueSource(strings = {"user@test.com", "admin@example.org"})
void deveValidarEmail(String email) { }
```

---

## üîç Mocking com Mockito

### Quando Usar Mocks

‚úÖ **USE para:**

- Isolar depend√™ncias externas (DB, APIs, filesystem)
- Testar comportamento sem efeitos colaterais
- Simular cen√°rios dif√≠ceis (timeout, exce√ß√£o)

‚ùå **N√ÉO USE para:**

- Objetos simples (DTOs, value objects)
- L√≥gica de neg√≥cio (teste a implementa√ß√£o real)
- Tudo (excesso de mocks = teste fr√°gil)

### Padr√£o Given-When-Then

```java
@Test
void deveAutenticarUsuarioValido() {
    // Given - Setup
    Usuario user = new Usuario("admin", "senha123");
    when(repository.findByUsername("admin"))
        .thenReturn(Optional.of(user));

    // When - A√ß√£o
    boolean autenticado = service.autenticar("admin", "senha123");

    // Then - Verifica√ß√£o
    assertTrue(autenticado);
    verify(repository).findByUsername("admin");
}
```

### Evite Over-Verification

```java
// ‚ùå RUIM - Muito acoplado √† implementa√ß√£o
@Test
void buscarUsuario() {
    service.buscar(1L);
    verify(cache, times(1)).get("user:1");
    verify(cache, never()).put(anyString(), any());
    verify(logger, times(1)).info(contains("cache"));
    // Se refatorar implementa√ß√£o, teste quebra
}

// ‚úÖ BOM - Testa comportamento p√∫blico
@Test
void buscarUsuario() {
    Usuario u = service.buscar(1L);
    assertNotNull(u);
    assertEquals("Admin", u.getNome());
}
```

---

## üìÅ Estrutura de Diret√≥rios

Organize testes espelhando estrutura de produ√ß√£o:

```
src/
‚îú‚îÄ‚îÄ main/java/com/exemplo/
‚îÇ   ‚îú‚îÄ‚îÄ controller/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ UsuarioController.java
‚îÇ   ‚îú‚îÄ‚îÄ service/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ UsuarioService.java
‚îÇ   ‚îî‚îÄ‚îÄ repository/
‚îÇ       ‚îî‚îÄ‚îÄ UsuarioRepository.java
‚îÇ
‚îî‚îÄ‚îÄ test/java/com/exemplo/
    ‚îú‚îÄ‚îÄ controller/
    ‚îÇ   ‚îî‚îÄ‚îÄ UsuarioControllerTest.java
    ‚îú‚îÄ‚îÄ service/
    ‚îÇ   ‚îî‚îÄ‚îÄ UsuarioServiceTest.java
    ‚îú‚îÄ‚îÄ repository/
    ‚îÇ   ‚îî‚îÄ‚îÄ UsuarioRepositoryTest.java
    ‚îî‚îÄ‚îÄ integration/
        ‚îî‚îÄ‚îÄ UsuarioIntegrationTest.java
```

### Conven√ß√µes de Nomenclatura

| Tipo             | Sufixo            | Exemplo                      |
| ---------------- | ----------------- | ---------------------------- |
| Teste unit√°rio   | `Test`            | `CalculadoraTest`            |
| Teste integra√ß√£o | `IntegrationTest` | `UsuarioIntegrationTest`     |
| Teste E2E        | `E2ETest` / `IT`  | `LoginE2ETest`, `CheckoutIT` |

---

## ‚è± Performance de Testes

### Paraleliza√ß√£o

```java
// junit-platform.properties
junit.jupiter.execution.parallel.enabled = true
junit.jupiter.execution.parallel.mode.default = concurrent
junit.jupiter.execution.parallel.mode.classes.default = concurrent
```

### Medi√ß√£o de Tempo

```java
@Test
@Timeout(value = 500, unit = TimeUnit.MILLISECONDS)
void deveExecutarRapido() {
    // Se levar >500ms, falha
    service.processar();
}
```

### Usar @Disabled com Justificativa

```java
@Test
@Disabled("JIRA-123: Bug conhecido, aguardando corre√ß√£o do backend")
void testeTemporariamenteDesabilitado() {
    // N√£o executa, mas mant√©m registro
}
```

---

## üìù Documenta√ß√£o Viva

### Testes como Documenta√ß√£o

```java
@Test
@DisplayName("""
    Dado um usu√°rio com cr√©ditos insuficientes,
    Quando tentar realizar uma compra,
    Ent√£o deve lan√ßar SaldoInsuficienteException
    """)
void deveLancarExcecaoSeSaldoInsuficiente() {
    Usuario user = new Usuario(saldo = 10.0);
    Produto produto = new Produto(preco = 50.0);

    assertThrows(SaldoInsuficienteException.class,
        () -> carrinhoService.finalizar(user, produto));
}
```

### Tags para Categoriza√ß√£o

```java
@Tag("unit")
@Tag("fast")
class CalculadoraTest { }

@Tag("integration")
@Tag("database")
class RepositorioIntegrationTest { }

// Executar apenas testes r√°pidos:
// mvn test -Dgroups="fast"
```

---

## ‚úÖ Checklist Geral

### Nomea√ß√£o

- [ ] M√©todos seguem padr√£o `deve/naoDeve/quando/lanca`?
- [ ] @DisplayName complementa com contexto?
- [ ] Testes parametrizados t√™m `name` descritivo?

### Estrutura

- [ ] Uso de @Nested para organizar su√≠tes grandes?
- [ ] AAA (Arrange-Act-Assert) √© claro?
- [ ] @BeforeEach/AfterEach para setup/limpeza?

### Assertions

- [ ] assertAll para valida√ß√µes m√∫ltiplas?
- [ ] Mensagens de erro √∫teis?
- [ ] assertThrows valida mensagem da exce√ß√£o?

### Parametriza√ß√£o

- [ ] Dados externos em arquivo CSV quando >10 casos?
- [ ] @MethodSource reutilizado em classe utilit√°ria?
- [ ] Um conceito por teste parametrizado?

### Mocks

- [ ] Mocks apenas para depend√™ncias externas?
- [ ] Evita over-verification de detalhes internos?
- [ ] Given-When-Then √© claro?

### Performance

- [ ] Testes unit√°rios <10ms?
- [ ] @Timeout para prevenir travamentos?
- [ ] Paraleliza√ß√£o habilitada?

---

## üß† Perguntas Reflexivas

1. Como voc√™ equilibra legibilidade vs concis√£o em nomes de testes?
2. Quando usar @DisplayName vs nomes de m√©todo longos?
3. Qual o limite aceit√°vel de mocks em um teste?
4. Como decidir entre @CsvSource e @MethodSource?
5. Testes devem testar implementa√ß√£o ou comportamento?

---

## üìö Pr√≥ximos Passos

- [5.1 Princ√≠pios Fundamentais](05.1-principios-testes.md) - Base te√≥rica
- [5.3 Anti-Patterns](05.3-anti-patterns.md) - Erros comuns
- [5.4 Gloss√°rio](05.4-glossario.md) - Termos t√©cnicos
- [Voltar ao √çndice](../../README.md)

---

**√öltima Atualiza√ß√£o:** 2025-11-14  
**N√≠vel:** [TODOS OS N√çVEIS]  
**Tempo Estimado:** 2 horas
