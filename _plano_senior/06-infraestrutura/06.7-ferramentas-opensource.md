# 06.7 Ferramentas Open Source para Infraestrutura [AVAN√áADO] üõ†Ô∏è

## üéØ Objetivo

Conhecer e utilizar **ferramentas open source** como alternativas para **containeriza√ß√£o**, **orquestra√ß√£o**, **CI/CD**, **monitoramento**, **autentica√ß√£o** e **gest√£o de infraestrutura**.

---

## üìö Por Que Open Source?

### Vantagens

- ‚úÖ **Custo zero**: Sem licen√ßas propriet√°rias
- ‚úÖ **Flexibilidade**: C√≥digo aberto, customiz√°vel
- ‚úÖ **Comunidade**: Suporte ativo, plugins
- ‚úÖ **Vendor lock-in**: Sem depend√™ncia de fornecedor √∫nico
- ‚úÖ **Transpar√™ncia**: Audit√°vel, seguro

### Desvantagens

- ‚ùå **Suporte**: Sem SLA comercial (exceto vers√µes pagas)
- ‚ùå **Complexidade**: Mais setup manual
- ‚ùå **Manuten√ß√£o**: Atualiza√ß√£o responsabilidade sua

---

## üê≥ Containeriza√ß√£o

### 1. Podman (Alternativa ao Docker)

**O que √©:** Container engine compat√≠vel com Docker, mas **daemonless** e **rootless**.

#### Vantagens sobre Docker

- ‚úÖ **Rootless**: Roda sem root (mais seguro)
- ‚úÖ **Daemonless**: Sem daemon central (menos ponto √∫nico de falha)
- ‚úÖ **OCI compliant**: Mesmo formato de imagem do Docker
- ‚úÖ **Drop-in replacement**: `alias docker=podman`

#### Instala√ß√£o

```bash
# Fedora/RHEL
sudo dnf install podman

# Ubuntu
sudo apt install podman

# macOS
brew install podman
podman machine init
podman machine start
```

#### Uso

```bash
# ‚úÖ Comandos id√™nticos ao Docker
podman pull postgres:15
podman run -d --name db -e POSTGRES_PASSWORD=secret postgres:15
podman ps
podman logs db
podman stop db

# Rootless (roda sem sudo)
podman run -d -p 8080:8080 myapp:latest

# Build de imagem
podman build -t myapp:1.0 .

# Push para registry
podman login registry.empresa.com
podman push myapp:1.0 registry.empresa.com/myapp:1.0

# Pods (conceito do Kubernetes)
podman pod create --name app-pod -p 8080:8080
podman run -d --pod app-pod --name app myapp:latest
podman run -d --pod app-pod --name db postgres:15
```

#### Dockerfile (id√™ntico)

```dockerfile
FROM amazoncorretto:17-alpine

WORKDIR /app

COPY target/app.jar app.jar

RUN addgroup -S appgroup && adduser -S appuser -G appgroup
USER appuser

EXPOSE 8080

ENTRYPOINT ["java", "-jar", "app.jar"]
```

#### Integra√ß√£o com CI/CD

```yaml
# GitLab CI
build:
  image: quay.io/podman/stable
  script:
    - podman build -t myapp:${CI_COMMIT_SHA} .
    - podman push myapp:${CI_COMMIT_SHA}
```

---

### 2. Buildah (Build de imagens)

**O que √©:** Ferramenta especializada em **build de imagens OCI** (mais poderosa que `podman build`).

```bash
# Instalar
sudo dnf install buildah

# Build de imagem (sem Dockerfile)
container=$(buildah from amazoncorretto:17-alpine)
buildah copy $container target/app.jar /app/app.jar
buildah config --entrypoint '["java", "-jar", "/app/app.jar"]' $container
buildah config --port 8080 $container
buildah commit $container myapp:1.0

# Build com Dockerfile
buildah bud -t myapp:1.0 .
```

---

### 3. Skopeo (Gerenciamento de imagens)

**O que √©:** Ferramenta para **inspecionar**, **copiar** e **deletar** imagens de registries.

```bash
# Instalar
sudo dnf install skopeo

# Inspecionar imagem (sem pull)
skopeo inspect docker://postgres:15

# Copiar entre registries
skopeo copy \
  docker://docker.io/myapp:1.0 \
  docker://registry.empresa.com/myapp:1.0

# Delete de imagem remota
skopeo delete docker://registry.empresa.com/myapp:old

# Sync de registry
skopeo sync --src docker --dest dir \
  docker.io/library/postgres:15 /backup/images/
```

---

## ‚ò∏Ô∏è Orquestra√ß√£o Kubernetes

### 1. K3s (Kubernetes Leve)

**O que √©:** Kubernetes **minimalista** (< 100MB), ideal para **edge**, **IoT** e **desenvolvimento**.

#### Instala√ß√£o

```bash
# Master node
curl -sfL https://get.k3s.io | sh -

# Worker node
curl -sfL https://get.k3s.io | K3S_URL=https://master:6443 K3S_TOKEN=<token> sh -

# Verificar
kubectl get nodes
```

#### Uso

```bash
# Deploy app
kubectl apply -f deployment.yaml

# Traefik j√° vem instalado (Ingress)
kubectl get svc -n kube-system

# Remover componentes n√£o necess√°rios
curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="--disable traefik" sh -
```

---

### 2. MicroK8s (Kubernetes Canonical)

**O que √©:** Kubernetes **zero-ops** da Canonical (Ubuntu).

```bash
# Instalar
sudo snap install microk8s --classic

# Habilitar addons
microk8s enable dns dashboard ingress storage

# Kubectl
microk8s kubectl get nodes

# Alias
alias kubectl='microk8s kubectl'
```

---

### 3. Minikube (Desenvolvimento Local)

**O que √©:** Kubernetes local para **desenvolvimento**.

```bash
# Instalar
brew install minikube

# Iniciar
minikube start --cpus=4 --memory=8192

# Dashboard
minikube dashboard

# Tunnel (acesso a LoadBalancer local)
minikube tunnel
```

---

### 4. Helm (Package Manager)

**O que √©:** **Gerenciador de pacotes** para Kubernetes (como apt/yum).

```bash
# Instalar
brew install helm

# Add repo
helm repo add bitnami https://charts.bitnami.com/bitnami
helm repo update

# Instalar PostgreSQL
helm install my-postgres bitnami/postgresql \
  --set auth.password=secret \
  --set primary.persistence.size=10Gi

# Criar chart pr√≥prio
helm create myapp

# Instalar
helm install myapp ./myapp

# Upgrade
helm upgrade myapp ./myapp --set replicaCount=3

# Rollback
helm rollback myapp 1
```

---

## üîÑ CI/CD Open Source

### 1. Jenkins (Mais Popular)

**O que √©:** Servidor de **automa√ß√£o** open source, altamente extens√≠vel.

#### Instala√ß√£o (Docker)

```bash
docker run -d \
  --name jenkins \
  -p 8080:8080 -p 50000:50000 \
  -v jenkins_home:/var/jenkins_home \
  jenkins/jenkins:lts
```

#### Jenkinsfile (Pipeline as Code)

```groovy
pipeline {
    agent any

    environment {
        DOCKER_REGISTRY = 'registry.empresa.com'
        IMAGE_NAME = 'pedidos-api'
    }

    stages {
        stage('Build') {
            steps {
                sh 'mvn clean package -DskipTests'
            }
        }

        stage('Test') {
            parallel {
                stage('Unit Tests') {
                    steps {
                        sh 'mvn test'
                        junit 'target/surefire-reports/*.xml'
                    }
                }
                stage('Integration Tests') {
                    steps {
                        sh 'mvn verify -P integration-tests'
                    }
                }
            }
        }

        stage('SonarQube') {
            steps {
                withSonarQubeEnv('SonarQube') {
                    sh 'mvn sonar:sonar'
                }
            }
        }

        stage('Docker Build') {
            steps {
                script {
                    docker.build("${IMAGE_NAME}:${BUILD_NUMBER}")
                }
            }
        }

        stage('Push') {
            steps {
                script {
                    docker.withRegistry("https://${DOCKER_REGISTRY}", 'docker-credentials') {
                        docker.image("${IMAGE_NAME}:${BUILD_NUMBER}").push()
                        docker.image("${IMAGE_NAME}:${BUILD_NUMBER}").push('latest')
                    }
                }
            }
        }

        stage('Deploy K8s') {
            steps {
                sh """
                    kubectl set image deployment/pedidos-api \
                      pedidos-api=${DOCKER_REGISTRY}/${IMAGE_NAME}:${BUILD_NUMBER} \
                      -n prod
                """
            }
        }
    }

    post {
        success {
            slackSend(color: 'good', message: "Deploy success: ${env.JOB_NAME} #${env.BUILD_NUMBER}")
        }
        failure {
            slackSend(color: 'danger', message: "Deploy failed: ${env.JOB_NAME} #${env.BUILD_NUMBER}")
        }
    }
}
```

#### Plugins Essenciais

- **Pipeline**: Pipeline as code
- **Docker**: Build e push de imagens
- **Kubernetes**: Deploy em K8s
- **SonarQube**: Quality gate
- **Slack**: Notifica√ß√µes
- **Blue Ocean**: UI moderna

---

### 2. Drone CI (Nativo Docker)

**O que √©:** CI/CD **cloud-native**, pipelines em YAML.

#### docker-compose.yml

```yaml
version: "3"

services:
  drone-server:
    image: drone/drone:2
    ports:
      - "80:80"
    environment:
      DRONE_GITHUB_CLIENT_ID: ${GITHUB_CLIENT_ID}
      DRONE_GITHUB_CLIENT_SECRET: ${GITHUB_SECRET}
      DRONE_RPC_SECRET: ${RPC_SECRET}
      DRONE_SERVER_HOST: drone.empresa.com
      DRONE_SERVER_PROTO: https
    volumes:
      - /var/lib/drone:/data

  drone-runner:
    image: drone/drone-runner-docker:1
    environment:
      DRONE_RPC_PROTO: https
      DRONE_RPC_HOST: drone.empresa.com
      DRONE_RPC_SECRET: ${RPC_SECRET}
      DRONE_RUNNER_CAPACITY: 2
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
```

#### .drone.yml

```yaml
kind: pipeline
type: docker
name: default

steps:
  - name: build
    image: maven:3.9-amazoncorretto-17
    commands:
      - mvn clean package -DskipTests

  - name: test
    image: maven:3.9-amazoncorretto-17
    commands:
      - mvn test

  - name: docker-build
    image: plugins/docker
    settings:
      repo: registry.empresa.com/pedidos-api
      tags:
        - ${DRONE_COMMIT_SHA}
        - latest
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password

  - name: deploy
    image: bitnami/kubectl
    commands:
      - kubectl set image deployment/pedidos-api pedidos-api=registry.empresa.com/pedidos-api:${DRONE_COMMIT_SHA}
    when:
      branch:
        - main
```

---

### 3. Tekton (Kubernetes-Native)

**O que √©:** CI/CD **nativo do Kubernetes**, CRDs para pipelines.

```yaml
# task.yaml
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: build-java-app
spec:
  params:
    - name: image
      type: string
  steps:
    - name: build
      image: maven:3.9-amazoncorretto-17
      script: |
        mvn clean package -DskipTests
    - name: docker-build
      image: gcr.io/kaniko-project/executor:latest
      args:
        - --dockerfile=Dockerfile
        - --destination=$(params.image)
```

---

### 4. Woodpecker CI (Fork do Drone)

**O que √©:** Fork **100% open source** do Drone (sem limita√ß√µes).

```yaml
# .woodpecker.yml
pipeline:
  build:
    image: maven:3.9-amazoncorretto-17
    commands:
      - mvn clean package -DskipTests

  test:
    image: maven:3.9-amazoncorretto-17
    commands:
      - mvn test

  docker:
    image: plugins/docker
    settings:
      repo: myapp
      tags: latest
      username: user
      password: pass
```

---

## üìä Monitoramento & Observabilidade

### 1. Prometheus (M√©tricas)

**O que √©:** Sistema de **monitoramento** com time-series database.

#### docker-compose.yml

```yaml
version: "3"

services:
  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.retention.time=15d"

  alertmanager:
    image: prom/alertmanager:latest
    ports:
      - "9093:9093"
    volumes:
      - ./alertmanager.yml:/etc/alertmanager/alertmanager.yml

volumes:
  prometheus-data:
```

#### prometheus.yml

```yaml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: "spring-boot-app"
    metrics_path: "/actuator/prometheus"
    static_configs:
      - targets: ["app:8080"]

  - job_name: "postgres"
    static_configs:
      - targets: ["postgres-exporter:9187"]

  - job_name: "node"
    static_configs:
      - targets: ["node-exporter:9100"]
```

#### Spring Boot Integration

```xml
<dependency>
    <groupId>io.micrometer</groupId>
    <artifactId>micrometer-registry-prometheus</artifactId>
</dependency>
```

```yaml
management:
  endpoints:
    web:
      exposure:
        include: prometheus,health,metrics
  metrics:
    export:
      prometheus:
        enabled: true
```

---

### 2. Grafana (Visualiza√ß√£o)

```yaml
# docker-compose.yml
grafana:
  image: grafana/grafana:latest
  ports:
    - "3000:3000"
  environment:
    GF_SECURITY_ADMIN_PASSWORD: admin
  volumes:
    - grafana-data:/var/lib/grafana
    - ./grafana/dashboards:/etc/grafana/provisioning/dashboards
    - ./grafana/datasources:/etc/grafana/provisioning/datasources
```

#### datasources.yml

```yaml
apiVersion: 1

datasources:
  - name: Prometheus
    type: prometheus
    access: proxy
    url: http://prometheus:9090
    isDefault: true
```

---

### 3. Loki (Logs)

**O que √©:** Sistema de **agrega√ß√£o de logs** (Prometheus para logs).

```yaml
loki:
  image: grafana/loki:latest
  ports:
    - "3100:3100"
  command: -config.file=/etc/loki/local-config.yaml

promtail:
  image: grafana/promtail:latest
  volumes:
    - /var/log:/var/log
    - ./promtail-config.yml:/etc/promtail/config.yml
  command: -config.file=/etc/promtail/config.yml
```

---

### 4. Jaeger (Distributed Tracing)

```bash
docker run -d --name jaeger \
  -p 16686:16686 \
  -p 14268:14268 \
  jaegertracing/all-in-one:latest
```

```xml
<dependency>
    <groupId>io.opentelemetry</groupId>
    <artifactId>opentelemetry-exporter-jaeger</artifactId>
</dependency>
```

---

## üîê Autentica√ß√£o & Autoriza√ß√£o

### 1. Keycloak (Identity Provider)

**O que √©:** **IAM** open source (SSO, OAuth2, SAML).

```bash
docker run -d --name keycloak \
  -p 8080:8080 \
  -e KEYCLOAK_ADMIN=admin \
  -e KEYCLOAK_ADMIN_PASSWORD=admin \
  quay.io/keycloak/keycloak:latest start-dev
```

#### Spring Boot + Keycloak

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-oauth2-client</artifactId>
</dependency>
```

```yaml
spring:
  security:
    oauth2:
      client:
        registration:
          keycloak:
            client-id: pedidos-api
            client-secret: ${KEYCLOAK_SECRET}
            authorization-grant-type: authorization_code
            redirect-uri: "{baseUrl}/login/oauth2/code/{registrationId}"
        provider:
          keycloak:
            issuer-uri: http://keycloak:8080/realms/empresa
```

---

### 2. OpenLDAP (Diret√≥rio)

**O que √©:** Servidor **LDAP** para gerenciar usu√°rios e grupos.

```yaml
# docker-compose.yml
openldap:
  image: osixia/openldap:latest
  ports:
    - "389:389"
    - "636:636"
  environment:
    LDAP_ORGANISATION: "Empresa"
    LDAP_DOMAIN: "empresa.com"
    LDAP_ADMIN_PASSWORD: "admin"
  volumes:
    - ldap-data:/var/lib/ldap
    - ldap-config:/etc/ldap/slapd.d

phpldapadmin:
  image: osixia/phpldapadmin:latest
  ports:
    - "6443:443"
  environment:
    PHPLDAPADMIN_LDAP_HOSTS: openldap
```

#### Spring Boot + LDAP

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-ldap</artifactId>
</dependency>
```

```java
@Configuration
public class SecurityConfig {

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/public/**").permitAll()
                .anyRequest().authenticated()
            )
            .formLogin(Customizer.withDefaults());

        return http.build();
    }

    @Bean
    public AuthenticationManager authManager(LdapAuthoritiesPopulator authorities) {
        LdapAuthenticationProviderConfigurer<AuthenticationManagerBuilder> provider =
            new LdapAuthenticationProviderConfigurer<>();

        provider
            .userDnPatterns("uid={0},ou=people")
            .groupSearchBase("ou=groups")
            .contextSource()
            .url("ldap://localhost:389/dc=empresa,dc=com")
            .managerDn("cn=admin,dc=empresa,dc=com")
            .managerPassword("admin");

        return provider.build();
    }
}
```

---

## üñ•Ô∏è Terminais & Shells

### 1. Zsh + Oh My Zsh

**O que √©:** Shell **poderoso** com plugins e temas.

```bash
# Instalar Zsh
sudo apt install zsh
chsh -s $(which zsh)

# Instalar Oh My Zsh
sh -c "$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"

# Plugins √∫teis
plugins=(git docker kubectl helm terraform aws)

# Temas
ZSH_THEME="powerlevel10k/powerlevel10k"
```

---

### 2. Tmux (Terminal Multiplexer)

```bash
# Instalar
sudo apt install tmux

# Criar sess√£o
tmux new -s dev

# Split vertical
Ctrl+b %

# Split horizontal
Ctrl+b "

# Navegar
Ctrl+b arrow-keys

# Detach
Ctrl+b d

# Attach
tmux attach -t dev
```

---

## üèóÔ∏è Infrastructure as Code

### 1. Terraform (Multi-Cloud)

```hcl
# main.tf
terraform {
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
  }
}

provider "aws" {
  region = "us-east-1"
}

resource "aws_instance" "app" {
  ami           = "ami-0c55b159cbfafe1f0"
  instance_type = "t3.medium"

  tags = {
    Name = "pedidos-api"
  }
}
```

---

### 2. Pulumi (IaC com c√≥digo)

```typescript
// index.ts
import * as aws from "@pulumi/aws";

const instance = new aws.ec2.Instance("app", {
  ami: "ami-0c55b159cbfafe1f0",
  instanceType: "t3.medium",
  tags: { Name: "pedidos-api" },
});

export const publicIp = instance.publicIp;
```

---

## üìù Resumo

**Ferramentas Open Source essenciais:**

- üê≥ **Containers**: Podman, Buildah, Skopeo
- ‚ò∏Ô∏è **Orquestra√ß√£o**: K3s, MicroK8s, Minikube, Helm
- üîÑ **CI/CD**: Jenkins, Drone, Tekton, Woodpecker
- üìä **Monitoramento**: Prometheus, Grafana, Loki, Jaeger
- üîê **Autentica√ß√£o**: Keycloak, OpenLDAP
- üñ•Ô∏è **Terminais**: Zsh, Tmux
- üèóÔ∏è **IaC**: Terraform, Pulumi

**Regra de ouro:** Open source oferece **flexibilidade** e **custo zero**, mas exige **conhecimento** e **manuten√ß√£o** pr√≥pria.
