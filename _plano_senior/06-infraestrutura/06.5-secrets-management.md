# 06.5 Secrets Management [AVAN√áADO] üîê

## üéØ Objetivo

Gerenciar **secrets** (senhas, API keys, certificados) de forma **segura**, **centralizada** e **audit√°vel** usando **Key Vault**, **AWS Secrets Manager**, **HashiCorp Vault** e alternativas open source.

---

## üìö O Que √â Secrets Management?

**Secrets Management** √© a pr√°tica de armazenar, acessar e rotacionar **dados sens√≠veis** de forma segura, evitando exposi√ß√£o em c√≥digo ou configura√ß√µes.

### Analogia

Como **cofre de banco**:

- **Sem secrets management**: Senha em post-it na tela (inseguro)
- **Com secrets management**: Cofre com acesso auditado (seguro)
- **Vantagem**: Secrets protegidos, rota√ß√£o autom√°tica, auditoria

---

## ‚ö†Ô∏è O Problema

### ‚ùå Secrets no C√≥digo (Anti-Pattern)

```java
// ‚ùå NUNCA fa√ßa isso
@Configuration
public class DatabaseConfig {

    @Bean
    public DataSource dataSource() {
        HikariConfig config = new HikariConfig();
        config.setJdbcUrl("jdbc:postgresql://db.empresa.com:5432/pedidos");
        config.setUsername("admin");
        config.setPassword("Prod@123456");  // ‚ùå Senha hardcoded
        return new HikariDataSource(config);
    }
}
```

**Riscos:**

- üö® Senha vaza no Git (hist√≥rico permanente)
- üö® Qualquer dev tem acesso
- üö® Imposs√≠vel rotacionar sem redeploy
- üö® Sem auditoria (quem acessou?)

---

## üîê Solu√ß√µes de Secrets Management

### Compara√ß√£o de Ferramentas

| Ferramenta            | Tipo        | Cloud       | Open Source | Custo            | Complexidade |
| --------------------- | ----------- | ----------- | ----------- | ---------------- | ------------ |
| AWS Secrets Manager   | Gerenciado  | AWS         | ‚ùå N√£o      | $0.40/secret/m√™s | Baixa        |
| Azure Key Vault       | Gerenciado  | Azure       | ‚ùå N√£o      | $0.03/10k ops    | Baixa        |
| Google Secret Manager | Gerenciado  | GCP         | ‚ùå N√£o      | $0.06/secret/m√™s | Baixa        |
| HashiCorp Vault       | Self-hosted | Multi-cloud | ‚úÖ Sim      | Gr√°tis (OSS)     | Alta         |
| Sealed Secrets        | K8s         | K8s         | ‚úÖ Sim      | Gr√°tis           | M√©dia        |
| Doppler               | SaaS        | Multi-cloud | ‚ùå N√£o      | $7/user/m√™s      | Baixa        |
| Spring Cloud Config   | Self-hosted | Multi-cloud | ‚úÖ Sim      | Gr√°tis           | M√©dia        |

---

## ‚òÅÔ∏è AWS Secrets Manager

### Cria√ß√£o de Secret

```bash
# CLI - Criar secret
aws secretsmanager create-secret \
  --name prod/db/credentials \
  --description "Credenciais do banco de produ√ß√£o" \
  --secret-string '{
    "username": "admin",
    "password": "SuperSecure123!",
    "host": "db.empresa.com",
    "port": "5432",
    "database": "pedidos"
  }'
```

### Terraform

```hcl
# Criar secret no AWS Secrets Manager
resource "aws_secretsmanager_secret" "db_credentials" {
  name        = "prod/db/credentials"
  description = "Credenciais do banco de produ√ß√£o"

  rotation_rules {
    automatically_after_days = 30  # Rota√ß√£o autom√°tica a cada 30 dias
  }
}

resource "aws_secretsmanager_secret_version" "db_credentials" {
  secret_id = aws_secretsmanager_secret.db_credentials.id
  secret_string = jsonencode({
    username = "admin"
    password = random_password.db_password.result
    host     = aws_db_instance.postgres.endpoint
    port     = 5432
    database = "pedidos"
  })
}

# Lambda para rota√ß√£o autom√°tica
resource "aws_lambda_function" "rotate_secret" {
  function_name = "rotate-db-credentials"
  runtime       = "python3.11"
  handler       = "lambda_function.lambda_handler"
  filename      = "rotate_secret.zip"

  environment {
    variables = {
      SECRET_ARN = aws_secretsmanager_secret.db_credentials.arn
    }
  }
}
```

### Spring Boot + AWS Secrets Manager

```xml
<!-- pom.xml -->
<dependency>
    <groupId>com.amazonaws.secretsmanager</groupId>
    <artifactId>aws-secretsmanager-jdbc</artifactId>
    <version>1.0.8</version>
</dependency>
```

```java
// Op√ß√£o 1: JDBC Driver com Secrets Manager
@Configuration
public class DatabaseConfig {

    @Bean
    public DataSource dataSource() {
        HikariConfig config = new HikariConfig();

        // ‚úÖ JDBC URL especial que busca secret automaticamente
        config.setJdbcUrl(
            "jdbc-secretsmanager:postgresql://db.empresa.com:5432/pedidos"
        );
        config.setUsername("prod/db/credentials");  // Nome do secret
        config.setDriverClassName(
            "com.amazonaws.secretsmanager.sql.AWSSecretsManagerPostgreSQLDriver"
        );

        return new HikariDataSource(config);
    }
}

// Op√ß√£o 2: Manual via SDK
@Configuration
public class DatabaseConfigManual {

    private final SecretsManagerClient secretsClient;

    @Bean
    public DataSource dataSource() {
        // Busca secret do AWS Secrets Manager
        GetSecretValueRequest request = GetSecretValueRequest.builder()
                .secretId("prod/db/credentials")
                .build();

        GetSecretValueResponse response = secretsClient.getSecretValue(request);

        JsonNode secret = new ObjectMapper()
                .readTree(response.secretString());

        HikariConfig config = new HikariConfig();
        config.setJdbcUrl(
            String.format("jdbc:postgresql://%s:%s/%s",
                secret.get("host").asText(),
                secret.get("port").asText(),
                secret.get("database").asText()
            )
        );
        config.setUsername(secret.get("username").asText());
        config.setPassword(secret.get("password").asText());

        return new HikariDataSource(config);
    }
}

// Secrets para API Keys
@Service
public class PaymentService {

    private final SecretsManagerClient secretsClient;
    private String apiKey;

    @PostConstruct
    public void init() {
        GetSecretValueRequest request = GetSecretValueRequest.builder()
                .secretId("prod/payment/apikey")
                .build();

        GetSecretValueResponse response = secretsClient.getSecretValue(request);
        this.apiKey = response.secretString();
    }

    public PaymentResponse processar(PaymentRequest request) {
        HttpHeaders headers = new HttpHeaders();
        headers.set("X-API-Key", apiKey);  // ‚úÖ API Key do Secrets Manager

        // Chama gateway de pagamento
        return restTemplate.exchange(...);
    }
}
```

---

## üî∑ Azure Key Vault

### Terraform

```hcl
resource "azurerm_key_vault" "app" {
  name                = "pedidos-keyvault"
  location            = azurerm_resource_group.main.location
  resource_group_name = azurerm_resource_group.main.name
  tenant_id           = data.azurerm_client_config.current.tenant_id
  sku_name            = "standard"

  access_policy {
    tenant_id = data.azurerm_client_config.current.tenant_id
    object_id = azurerm_user_assigned_identity.app.principal_id

    secret_permissions = [
      "Get",
      "List"
    ]
  }
}

resource "azurerm_key_vault_secret" "db_password" {
  name         = "db-password"
  value        = random_password.db.result
  key_vault_id = azurerm_key_vault.app.id
}
```

### Spring Boot + Azure Key Vault

```xml
<!-- pom.xml -->
<dependency>
    <groupId>com.azure.spring</groupId>
    <artifactId>spring-cloud-azure-starter-keyvault-secrets</artifactId>
</dependency>
```

```yaml
# application.yml
spring:
  cloud:
    azure:
      keyvault:
        secret:
          endpoint: https://pedidos-keyvault.vault.azure.net/
          credential:
            managed-identity-enabled: true
```

```java
@Configuration
public class DatabaseConfig {

    @Value("${db-username}")  // ‚úÖ Busca do Key Vault automaticamente
    private String username;

    @Value("${db-password}")
    private String password;

    @Bean
    public DataSource dataSource() {
        HikariConfig config = new HikariConfig();
        config.setJdbcUrl("jdbc:postgresql://db.empresa.com:5432/pedidos");
        config.setUsername(username);
        config.setPassword(password);
        return new HikariDataSource(config);
    }
}
```

---

## üü† Google Cloud Secret Manager

### Terraform

```hcl
resource "google_secret_manager_secret" "db_password" {
  secret_id = "db-password"

  replication {
    automatic = true
  }
}

resource "google_secret_manager_secret_version" "db_password" {
  secret      = google_secret_manager_secret.db_password.id
  secret_data = random_password.db.result
}

# IAM - Permitir app acessar secret
resource "google_secret_manager_secret_iam_member" "app" {
  secret_id = google_secret_manager_secret.db_password.id
  role      = "roles/secretmanager.secretAccessor"
  member    = "serviceAccount:${google_service_account.app.email}"
}
```

### Spring Boot + GCP Secret Manager

```xml
<dependency>
    <groupId>com.google.cloud</groupId>
    <artifactId>spring-cloud-gcp-starter-secretmanager</artifactId>
</dependency>
```

```yaml
# application.yml
spring:
  cloud:
    gcp:
      secretmanager:
        enabled: true
```

```java
@Configuration
public class DatabaseConfig {

    @Value("${sm://db-username}")  // ‚úÖ sm:// busca do Secret Manager
    private String username;

    @Value("${sm://db-password}")
    private String password;

    @Bean
    public DataSource dataSource() {
        HikariConfig config = new HikariConfig();
        config.setUsername(username);
        config.setPassword(password);
        return new HikariDataSource(config);
    }
}
```

---

## üîì HashiCorp Vault (Open Source)

### Instala√ß√£o (Docker)

```yaml
# docker-compose.yml
version: "3.8"

services:
  vault:
    image: hashicorp/vault:latest
    container_name: vault
    ports:
      - "8200:8200"
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: root # Apenas para dev
      VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
    cap_add:
      - IPC_LOCK
    volumes:
      - ./vault-data:/vault/data
```

### Configura√ß√£o

```bash
# Inicializar Vault
vault operator init

# Unseal (necess√°rio ap√≥s restart)
vault operator unseal <key1>
vault operator unseal <key2>
vault operator unseal <key3>

# Login
vault login <root-token>

# Criar secret
vault kv put secret/prod/db \
  username=admin \
  password=SuperSecure123! \
  host=db.empresa.com \
  port=5432

# Ler secret
vault kv get secret/prod/db

# Habilitar AppRole (para apps)
vault auth enable approle

vault write auth/approle/role/pedidos-api \
  token_ttl=1h \
  token_max_ttl=4h \
  secret_id_ttl=0

# Criar policy
vault policy write pedidos-api-policy - <<EOF
path "secret/data/prod/db" {
  capabilities = ["read"]
}
EOF
```

### Spring Boot + Vault

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-vault-config</artifactId>
</dependency>
```

```yaml
# bootstrap.yml
spring:
  cloud:
    vault:
      uri: http://localhost:8200
      authentication: APPROLE
      app-role:
        role-id: ${VAULT_ROLE_ID}
        secret-id: ${VAULT_SECRET_ID}
      kv:
        enabled: true
        backend: secret
        application-name: pedidos-api
```

```java
@Configuration
@ConfigurationProperties(prefix = "db")
public class DatabaseProperties {
    private String username;
    private String password;
    private String host;
    private int port;

    // ‚úÖ Getters/Setters - Vault preenche automaticamente
}

@Configuration
public class DatabaseConfig {

    @Bean
    public DataSource dataSource(DatabaseProperties props) {
        HikariConfig config = new HikariConfig();
        config.setJdbcUrl(
            String.format("jdbc:postgresql://%s:%d/pedidos",
                props.getHost(), props.getPort())
        );
        config.setUsername(props.getUsername());
        config.setPassword(props.getPassword());
        return new HikariDataSource(config);
    }
}
```

---

## üîí Sealed Secrets (Kubernetes)

### O Problema com K8s Secrets

```yaml
# ‚ùå Secret em base64 (facilmente decodific√°vel)
apiVersion: v1
kind: Secret
metadata:
  name: db-credentials
type: Opaque
data:
  username: YWRtaW4= # base64("admin")
  password: cGFzc3dvcmQ= # base64("password")
```

**Problema:** Base64 **N√ÉO √© encryption**, qualquer um com acesso ao cluster decodifica.

### Solu√ß√£o: Sealed Secrets

```bash
# Instalar controller
kubectl apply -f https://github.com/bitnami-labs/sealed-secrets/releases/download/v0.24.0/controller.yaml

# Instalar kubeseal CLI
brew install kubeseal
```

```bash
# Criar secret normal
kubectl create secret generic db-credentials \
  --from-literal=username=admin \
  --from-literal=password=SuperSecure123! \
  --dry-run=client -o yaml > secret.yaml

# Criptografar com kubeseal
kubeseal -f secret.yaml -w sealed-secret.yaml

# Aplicar (pode commitar no Git agora)
kubectl apply -f sealed-secret.yaml
```

```yaml
# sealed-secret.yaml (pode commitar no Git)
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: db-credentials
spec:
  encryptedData:
    username: AgB7Y... (criptografado)
    password: AgCQ... (criptografado)
```

**Spring Boot usa normalmente:**

```yaml
# deployment.yaml
env:
  - name: DB_USERNAME
    valueFrom:
      secretKeyRef:
        name: db-credentials # SealedSecret desencripta automaticamente
        key: username
  - name: DB_PASSWORD
    valueFrom:
      secretKeyRef:
        name: db-credentials
        key: password
```

---

## üõ†Ô∏è Ferramentas Open Source

### 1. **HashiCorp Vault** (Mais completo)

- ‚úÖ Dynamic secrets (gera credentials on-demand)
- ‚úÖ Secret rotation autom√°tica
- ‚úÖ Auditoria completa
- ‚úÖ Encryption as a Service
- ‚ùå Complexo de configurar

### 2. **Sealed Secrets** (Simples para K8s)

- ‚úÖ F√°cil integra√ß√£o com GitOps
- ‚úÖ Secrets criptografados no Git
- ‚ùå Apenas para Kubernetes

### 3. **SOPS (Mozilla)** (Para arquivos)

```bash
# Instalar
brew install sops

# Criptografar arquivo
sops -e secrets.yaml > secrets.enc.yaml

# Descriptografar
sops -d secrets.enc.yaml
```

```yaml
# secrets.yaml (antes)
db:
  username: admin
  password: SuperSecure123!

# secrets.enc.yaml (depois - pode commitar)
db:
  username: ENC[AES256_GCM,data:...,tag:...]
  password: ENC[AES256_GCM,data:...,tag:...]
```

### 4. **External Secrets Operator** (K8s + Cloud)

```yaml
# Sincroniza secrets de AWS/Azure/GCP para K8s
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: db-credentials
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: db-credentials
  data:
    - secretKey: username
      remoteRef:
        key: prod/db/credentials
        property: username
    - secretKey: password
      remoteRef:
        key: prod/db/credentials
        property: password
```

---

## üîÑ Rota√ß√£o de Secrets

### Rota√ß√£o Autom√°tica (AWS Lambda)

```python
# lambda_function.py
import boto3
import psycopg2

def lambda_handler(event, context):
    secretsmanager = boto3.client('secretsmanager')

    # Gera nova senha
    new_password = generate_password()

    # Atualiza no banco
    conn = psycopg2.connect(...)
    cursor = conn.cursor()
    cursor.execute(f"ALTER USER admin WITH PASSWORD '{new_password}'")
    conn.commit()

    # Atualiza no Secrets Manager
    secretsmanager.update_secret(
        SecretId='prod/db/credentials',
        SecretString=json.dumps({
            'username': 'admin',
            'password': new_password
        })
    )

    return {'statusCode': 200}
```

---

## üìã Boas Pr√°ticas

### ‚úÖ Recomenda√ß√µes

```java
// ‚úÖ Buscar secrets de vault
@Value("${db.password}")  // De Key Vault/Secrets Manager
private String password;

// ‚úÖ Rota√ß√£o autom√°tica
rotation_rules {
  automatically_after_days = 30
}

// ‚úÖ Auditoria habilitada
audit_enabled = true

// ‚úÖ Least privilege
secret_permissions = ["Get"]  // N√£o "Set", "Delete"

// ‚úÖ Secrets por ambiente
prod/db/credentials
dev/db/credentials

// ‚úÖ Encryption at rest
kms_key_id = aws_kms_key.secrets.arn
```

### ‚ùå Anti-Patterns

```java
// ‚ùå Senha hardcoded
String password = "senha123";

// ‚ùå Senha em vari√°vel de ambiente
export DB_PASSWORD="senha123"  # Vis√≠vel em `ps aux`

// ‚ùå Senha em ConfigMap
kind: ConfigMap  # ‚ùå N√£o √© criptografado

// ‚ùå Senha em base64
data:
  password: cGFzc3dvcmQ=  # ‚ùå Base64 n√£o √© encryption

// ‚ùå Secret √∫nico para tudo
secret_name = "all-secrets"  # Dificulta rota√ß√£o
```

---

## üéØ Quando Usar Cada Solu√ß√£o?

| Cen√°rio                    | Recomenda√ß√£o              |
| -------------------------- | ------------------------- |
| AWS exclusivo              | AWS Secrets Manager       |
| Azure exclusivo            | Azure Key Vault           |
| GCP exclusivo              | Google Secret Manager     |
| Multi-cloud                | HashiCorp Vault           |
| Kubernetes (GitOps)        | Sealed Secrets            |
| Kubernetes + Cloud Secrets | External Secrets Operator |
| Arquivos de configura√ß√£o   | SOPS                      |

---

## üîó Recursos

- [HashiCorp Vault](https://www.vaultproject.io/)
- [Sealed Secrets](https://github.com/bitnami-labs/sealed-secrets)
- [External Secrets Operator](https://external-secrets.io/)
- [AWS Secrets Manager](https://aws.amazon.com/secrets-manager/)
- [Azure Key Vault](https://azure.microsoft.com/en-us/services/key-vault/)
- [Google Secret Manager](https://cloud.google.com/secret-manager)

---

## üìù Resumo

**Secrets Management** garante:

- ‚úÖ **Seguran√ßa**: Secrets criptografados, n√£o no c√≥digo
- ‚úÖ **Auditoria**: Quem acessou, quando
- ‚úÖ **Rota√ß√£o**: Autom√°tica (reduz risco)
- ‚úÖ **Centraliza√ß√£o**: √önico local para secrets
- ‚úÖ **Compliance**: LGPD, PCI-DSS

**Regra de ouro:** **NUNCA** commite secrets no Git. Use **Key Vault** ou **HashiCorp Vault**.
