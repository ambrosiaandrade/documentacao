# 06.3 CI/CD [AVANÃ‡ADO] ğŸš€

## ğŸ¯ Objetivo

Automatizar **build**, **teste** e **deploy** de aplicaÃ§Ãµes **Java/Spring Boot** com **GitHub Actions**, **GitLab CI** e **Jenkins**.

---

## ğŸ“š O Que Ã‰ CI/CD?

**CI/CD** = **Continuous Integration** + **Continuous Deployment**

- **CI**: Integrar cÃ³digo frequentemente, rodar testes automaticamente
- **CD**: Deploy automatizado para produÃ§Ã£o

### Analogia

Como **linha de produÃ§Ã£o automatizada**:

- **Sem CI/CD**: Deploy manual, propenso a erros
- **Com CI/CD**: Pipeline automÃ¡tico, deploy confiÃ¡vel
- **Vantagem**: Feedback rÃ¡pido, deploy frequente

---

## ğŸ—ï¸ Pipeline BÃ¡sico

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Commit  â”‚â”€â”€â”€>â”‚ Build â”‚â”€â”€â”€>â”‚ Test â”‚â”€â”€â”€>â”‚ Docker â”‚â”€â”€â”€>â”‚ Deploy â”‚
â”‚  & Push  â”‚    â”‚ Maven â”‚    â”‚ JUnitâ”‚    â”‚ Image  â”‚    â”‚  K8s   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ™ GitHub Actions

### Workflow Completo

```yaml
# .github/workflows/ci-cd.yml

name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main

env:
  JAVA_VERSION: "17"
  DOCKER_REGISTRY: ghcr.io
  IMAGE_NAME: empresa/pedidos-api

jobs:
  # ========================================
  # JOB 1: Build & Test
  # ========================================
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: "17"
          distribution: "corretto"
          cache: "maven"

      - name: Build with Maven
        run: mvn clean install -DskipTests

      - name: Run Unit Tests
        run: mvn test

      - name: Run Integration Tests
        run: mvn verify -P integration-tests

      - name: Generate Coverage Report
        run: mvn jacoco:report

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./target/site/jacoco/jacoco.xml
          fail_ci_if_error: true

      - name: SonarQube Analysis
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn sonar:sonar \
            -Dsonar.projectKey=pedidos-api \
            -Dsonar.host.url=${{ secrets.SONAR_URL }}

      - name: Upload Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: app-jar
          path: target/*.jar
          retention-days: 7

  # ========================================
  # JOB 2: Security Scan
  # ========================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: "trivy-results.sarif"

  # ========================================
  # JOB 3: Build Docker Image
  # ========================================
  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to Container Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix={{branch}}-
            type=ref,event=branch
            type=semver,pattern={{version}}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache,mode=max

  # ========================================
  # JOB 4: Deploy to Kubernetes
  # ========================================
  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    needs: build-docker
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: "v1.27.0"

      - name: Configure Kubernetes Context
        run: |
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config

      - name: Deploy to Kubernetes
        run: |
          kubectl set image deployment/pedidos-api \
            pedidos-api=${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:main-${{ github.sha }} \
            -n prod

          kubectl rollout status deployment/pedidos-api -n prod --timeout=5m

      - name: Verify Deployment
        run: |
          kubectl get pods -n prod -l app=pedidos-api
          kubectl get svc -n prod pedidos-api-service

  # ========================================
  # JOB 5: Smoke Tests
  # ========================================
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: Wait for Service
        run: sleep 30

      - name: Health Check
        run: |
          curl -f https://api.empresa.com/actuator/health || exit 1

      - name: Basic API Test
        run: |
          response=$(curl -s https://api.empresa.com/api/pedidos)
          echo $response | grep -q "pedidos" || exit 1
```

---

## ğŸ¦Š GitLab CI

```yaml
# .gitlab-ci.yml

stages:
  - build
  - test
  - security
  - docker
  - deploy

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  DOCKER_REGISTRY: registry.gitlab.com
  IMAGE_NAME: $CI_REGISTRY_IMAGE

# Cache Maven dependencies
cache:
  paths:
    - .m2/repository

# ========================================
# Build
# ========================================
build:
  stage: build
  image: maven:3.9-amazoncorretto-17
  script:
    - mvn clean install -DskipTests
  artifacts:
    paths:
      - target/*.jar
    expire_in: 1 week

# ========================================
# Test
# ========================================
unit-tests:
  stage: test
  image: maven:3.9-amazoncorretto-17
  script:
    - mvn test
  coverage: "/Total.*?([0-9]{1,3})%/"
  artifacts:
    reports:
      junit:
        - target/surefire-reports/TEST-*.xml
      coverage_report:
        coverage_format: cobertura
        path: target/site/cobertura/coverage.xml

integration-tests:
  stage: test
  image: maven:3.9-amazoncorretto-17
  services:
    - postgres:15
  variables:
    POSTGRES_DB: pedidos_test
    POSTGRES_USER: test
    POSTGRES_PASSWORD: test
  script:
    - mvn verify -P integration-tests

# ========================================
# Security
# ========================================
sonarqube:
  stage: security
  image: maven:3.9-amazoncorretto-17
  script:
    - mvn sonar:sonar
      -Dsonar.projectKey=$CI_PROJECT_NAME
      -Dsonar.host.url=$SONAR_URL
      -Dsonar.token=$SONAR_TOKEN
  only:
    - main

trivy-scan:
  stage: security
  image: aquasec/trivy:latest
  script:
    - trivy fs --exit-code 1 --severity HIGH,CRITICAL .

# ========================================
# Docker
# ========================================
docker-build:
  stage: docker
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $IMAGE_NAME:$CI_COMMIT_SHORT_SHA .
    - docker tag $IMAGE_NAME:$CI_COMMIT_SHORT_SHA $IMAGE_NAME:latest
    - docker push $IMAGE_NAME:$CI_COMMIT_SHORT_SHA
    - docker push $IMAGE_NAME:latest
  only:
    - main

# ========================================
# Deploy
# ========================================
deploy-prod:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
    - kubectl config use-context $KUBE_CONTEXT
    - kubectl set image deployment/pedidos-api
      pedidos-api=$IMAGE_NAME:$CI_COMMIT_SHORT_SHA
      -n prod
    - kubectl rollout status deployment/pedidos-api -n prod --timeout=5m
  environment:
    name: production
    url: https://api.empresa.com
  only:
    - main
```

---

## ğŸ”¨ Jenkins

```groovy
// Jenkinsfile

pipeline {
    agent any

    environment {
        JAVA_HOME = tool 'JDK17'
        MAVEN_HOME = tool 'Maven3'
        DOCKER_REGISTRY = 'docker.io'
        IMAGE_NAME = 'empresa/pedidos-api'
        KUBECONFIG = credentials('kubeconfig-prod')
    }

    stages {
        // ========================================
        // Checkout
        // ========================================
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        // ========================================
        // Build
        // ========================================
        stage('Build') {
            steps {
                script {
                    sh "${MAVEN_HOME}/bin/mvn clean install -DskipTests"
                }
            }
        }

        // ========================================
        // Test
        // ========================================
        stage('Test') {
            parallel {
                stage('Unit Tests') {
                    steps {
                        sh "${MAVEN_HOME}/bin/mvn test"
                    }
                    post {
                        always {
                            junit 'target/surefire-reports/*.xml'
                        }
                    }
                }

                stage('Integration Tests') {
                    steps {
                        sh "${MAVEN_HOME}/bin/mvn verify -P integration-tests"
                    }
                }
            }
        }

        // ========================================
        // Quality Gate
        // ========================================
        stage('SonarQube') {
            steps {
                withSonarQubeEnv('SonarQube') {
                    sh "${MAVEN_HOME}/bin/mvn sonar:sonar"
                }
            }
        }

        stage('Quality Gate') {
            steps {
                timeout(time: 5, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: true
                }
            }
        }

        // ========================================
        // Docker
        // ========================================
        stage('Docker Build') {
            when {
                branch 'main'
            }
            steps {
                script {
                    docker.withRegistry('https://${DOCKER_REGISTRY}', 'docker-credentials') {
                        def image = docker.build("${IMAGE_NAME}:${BUILD_NUMBER}")
                        image.push()
                        image.push('latest')
                    }
                }
            }
        }

        // ========================================
        // Deploy
        // ========================================
        stage('Deploy to Kubernetes') {
            when {
                branch 'main'
            }
            steps {
                script {
                    sh """
                        kubectl --kubeconfig=${KUBECONFIG} set image deployment/pedidos-api \
                          pedidos-api=${IMAGE_NAME}:${BUILD_NUMBER} \
                          -n prod

                        kubectl --kubeconfig=${KUBECONFIG} rollout status deployment/pedidos-api -n prod --timeout=5m
                    """
                }
            }
        }

        // ========================================
        // Smoke Tests
        // ========================================
        stage('Smoke Tests') {
            when {
                branch 'main'
            }
            steps {
                script {
                    sh """
                        sleep 30
                        curl -f https://api.empresa.com/actuator/health || exit 1
                    """
                }
            }
        }
    }

    post {
        success {
            slackSend(
                color: 'good',
                message: "Deploy successful: ${env.JOB_NAME} #${env.BUILD_NUMBER}"
            )
        }
        failure {
            slackSend(
                color: 'danger',
                message: "Deploy failed: ${env.JOB_NAME} #${env.BUILD_NUMBER}"
            )
        }
    }
}
```

---

## ğŸ§ª Testes no Pipeline

### JUnit + Mockito

```java
// PedidoServiceTest.java (unit test)

@SpringBootTest
class PedidoServiceTest {

    @Mock
    private PedidoRepository repository;

    @InjectMocks
    private PedidoService service;

    @Test
    @DisplayName("Deve criar pedido com sucesso")
    void deveCriarPedido() {
        // Arrange
        var pedido = new Pedido("Cliente", 100.0);
        when(repository.save(any())).thenReturn(pedido);

        // Act
        var resultado = service.criar(pedido);

        // Assert
        assertNotNull(resultado);
        assertEquals("Cliente", resultado.getCliente());
        verify(repository, times(1)).save(any());
    }
}
```

### Integration Test

```java
// PedidoControllerIT.java (integration test)

@SpringBootTest(webEnvironment = WebEnvironment.RANDOM_PORT)
@ActiveProfiles("test")
class PedidoControllerIT {

    @Autowired
    private TestRestTemplate restTemplate;

    @Test
    @DisplayName("Deve criar pedido via API")
    void deveCriarPedidoViaAPI() {
        // Arrange
        var request = new PedidoRequest("Cliente", 100.0);

        // Act
        var response = restTemplate.postForEntity(
            "/api/pedidos",
            request,
            PedidoResponse.class
        );

        // Assert
        assertEquals(HttpStatus.CREATED, response.getStatusCode());
        assertNotNull(response.getBody());
        assertNotNull(response.getBody().getId());
    }
}
```

---

## ğŸ¯ EstratÃ©gias de Deploy

### Blue-Green Deployment

```yaml
# deployment-blue.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pedidos-api-blue
spec:
  replicas: 3
  selector:
    matchLabels:
      app: pedidos-api
      version: blue
  template:
    metadata:
      labels:
        app: pedidos-api
        version: blue
    spec:
      containers:
        - name: pedidos-api
          image: empresa/pedidos-api:1.0.0
```

```yaml
# service.yaml
apiVersion: v1
kind: Service
metadata:
  name: pedidos-api-service
spec:
  selector:
    app: pedidos-api
    version: blue # Muda para 'green' apÃ³s validaÃ§Ã£o
  ports:
    - port: 80
      targetPort: 8080
```

### Canary Deployment

```yaml
# Istio VirtualService

apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: pedidos-api
spec:
  hosts:
    - pedidos-api
  http:
    - match:
        - headers:
            canary:
              exact: "true"
      route:
        - destination:
            host: pedidos-api
            subset: v2
    - route:
        - destination:
            host: pedidos-api
            subset: v1
          weight: 90
        - destination:
            host: pedidos-api
            subset: v2
          weight: 10 # 10% do trÃ¡fego para nova versÃ£o
```

---

## ğŸ“‹ Boas PrÃ¡ticas

### âœ… RecomendaÃ§Ãµes

```yaml
# âœ… Cache de dependÃªncias
cache:
  paths:
    - .m2/repository

# âœ… Jobs paralelos
jobs:
  unit-tests:
    ...
  integration-tests:
    ...

# âœ… Fail fast
- name: Build
  run: mvn clean install -DskipTests -e -B

# âœ… Artifacts com expiraÃ§Ã£o
artifacts:
  paths:
    - target/*.jar
  expire_in: 1 week

# âœ… Quality gates
- name: Wait for Quality Gate
  run: sonar-quality-gate --fail-on-quality-gate

# âœ… Rollback automÃ¡tico
on_failure:
  - kubectl rollout undo deployment/pedidos-api -n prod

# âœ… NotificaÃ§Ãµes
post:
  failure:
    slackSend(color: 'danger', message: 'Deploy failed!')

# âœ… Secrets seguros
env:
  DATABASE_PASSWORD: ${{ secrets.DB_PASSWORD }}
```

### âŒ Anti-Patterns

```yaml
# âŒ Sem testes
# (deploy sem garantia de qualidade)

# âŒ Deploy manual
# (propenso a erros)

# âŒ Credenciais no cÃ³digo
password: "senha123" # âŒ

# âŒ Deploy direto em prod
# (sem staging)

# âŒ Sem rollback
# (deploy falho deixa prod quebrado)

# âŒ Build lento
# (sem cache, demora 10min)
```

---

## ğŸ¯ Quando Usar CI/CD?

| CenÃ¡rio                       | Usar CI/CD? |
| ----------------------------- | ----------- |
| Deploy frequente (>1x/semana) | âœ… Sim      |
| MÃºltiplos desenvolvedores     | âœ… Sim      |
| Testes automatizados          | âœ… Sim      |
| Microservices                 | âœ… Sim      |
| Projeto pessoal simples       | âŒ NÃ£o      |

---

## ğŸ”— Recursos

- [GitHub Actions Documentation](https://docs.github.com/en/actions)
- [GitLab CI/CD Documentation](https://docs.gitlab.com/ee/ci/)
- [Jenkins Documentation](https://www.jenkins.io/doc/)

---

## ğŸ“ Resumo

**CI/CD** garante:

- âœ… **Build automatizado**: Maven/Gradle
- âœ… **Testes automatizados**: JUnit, Integration Tests
- âœ… **Quality gates**: SonarQube, coverage
- âœ… **Deploy automatizado**: Kubernetes
- âœ… **Rollback rÃ¡pido**: Em caso de falha

**Regra de ouro:** Teste **tudo** antes de deploy, use **quality gates**, e tenha **rollback automÃ¡tico**.
