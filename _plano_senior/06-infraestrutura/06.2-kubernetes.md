# 06.2 Kubernetes [AVANÃ‡ADO] â˜¸ï¸

## ğŸ¯ Objetivo

Orquestrar aplicaÃ§Ãµes **Java/Spring Boot** em **Kubernetes** com **Deployments**, **Services**, **ConfigMaps**, **Secrets**, **Ingress** e **autoscaling**.

---

## ğŸ“š O Que Ã‰ Kubernetes?

**Kubernetes** (K8s) Ã© um sistema de orquestr aÃ§Ã£o de containers que automatiza **deploy**, **scaling** e **gerenciamento** de aplicaÃ§Ãµes containerizadas.

### Analogia

Como **maestro de orquestra**:

- **Sem K8s**: Docker run manual em cada servidor
- **Com K8s**: Maestro coordena containers automaticamente
- **Vantagem**: Self-healing, scaling automÃ¡tico, zero-downtime

---

## ğŸ—ï¸ Arquitetura BÃ¡sica

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Kubernetes Cluster            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         Namespace: prod          â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚                                  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚  â”‚  â”‚      Deployment         â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”       â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ Pod â”‚  â”‚ Pod â”‚       â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜       â”‚    â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚  â”‚              â–²                   â”‚  â”‚
â”‚  â”‚              â”‚                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚  â”‚  â”‚        Service          â”‚    â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚  â”‚              â–²                   â”‚  â”‚
â”‚  â”‚              â”‚                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚  â”‚  â”‚        Ingress          â”‚    â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚  â”‚                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ Deployment

```yaml
# deployment.yaml

apiVersion: apps/v1
kind: Deployment
metadata:
  name: pedidos-api
  namespace: prod
  labels:
    app: pedidos-api
    version: "1.0.0"
spec:
  replicas: 3 # 3 instÃ¢ncias
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1 # MÃ¡ximo 1 pod extra durante update
      maxUnavailable: 0 # Zero downtime
  selector:
    matchLabels:
      app: pedidos-api
  template:
    metadata:
      labels:
        app: pedidos-api
        version: "1.0.0"
    spec:
      containers:
        - name: pedidos-api
          image: empresa/pedidos-api:1.0.0
          imagePullPolicy: Always
          ports:
            - containerPort: 8080
              name: http
              protocol: TCP

          # VariÃ¡veis de ambiente
          env:
            - name: SPRING_PROFILES_ACTIVE
              value: "prod"
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: app-secrets
                  key: database-url
            - name: DATABASE_USERNAME
              valueFrom:
                secretKeyRef:
                  name: app-secrets
                  key: database-username
            - name: DATABASE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: app-secrets
                  key: database-password

          # ConfigMap
          envFrom:
            - configMapRef:
                name: app-config

          # Recursos
          resources:
            requests:
              memory: "512Mi"
              cpu: "500m"
            limits:
              memory: "1Gi"
              cpu: "1000m"

          # Health checks
          livenessProbe:
            httpGet:
              path: /actuator/health/liveness
              port: 8080
            initialDelaySeconds: 60
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3

          readinessProbe:
            httpGet:
              path: /actuator/health/readiness
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3

          # Volumes
          volumeMounts:
            - name: logs
              mountPath: /app/logs

      volumes:
        - name: logs
          emptyDir: {}

      # Afinidade (evitar mÃºltiplos pods no mesmo nÃ³)
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - pedidos-api
                topologyKey: kubernetes.io/hostname
```

---

## ğŸŒ Service

```yaml
# service.yaml

apiVersion: v1
kind: Service
metadata:
  name: pedidos-api-service
  namespace: prod
  labels:
    app: pedidos-api
spec:
  type: ClusterIP # Interno ao cluster
  selector:
    app: pedidos-api
  ports:
    - name: http
      protocol: TCP
      port: 80
      targetPort: 8080
  sessionAffinity: ClientIP # Sticky sessions
```

---

## ğŸ”’ Secrets

```yaml
# secrets.yaml

apiVersion: v1
kind: Secret
metadata:
  name: app-secrets
  namespace: prod
type: Opaque
data:
  # Valores em Base64
  database-url: amRiYzpwb3N0Z3Jlc3FsOi8vZGI6NTQzMi9wZWRpZG9z
  database-username: cGVkaWRvc191c2Vy
  database-password: c2VjdXJlX3Bhc3N3b3Jk
```

**Criar secret via CLI:**

```bash
kubectl create secret generic app-secrets \
  --from-literal=database-url='jdbc:postgresql://db:5432/pedidos' \
  --from-literal=database-username='pedidos_user' \
  --from-literal=database-password='secure_password' \
  -n prod
```

---

## âš™ï¸ ConfigMap

```yaml
# configmap.yaml

apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
  namespace: prod
data:
  JAVA_OPTS: "-Xms512m -Xmx1024m"
  REDIS_HOST: "redis-service"
  REDIS_PORT: "6379"
  RABBITMQ_HOST: "rabbitmq-service"
  RABBITMQ_PORT: "5672"
  LOG_LEVEL: "INFO"
```

---

## ğŸ”€ Ingress

```yaml
# ingress.yaml

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: pedidos-api-ingress
  namespace: prod
  annotations:
    kubernetes.io/ingress.class: "nginx"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/rate-limit: "100"
spec:
  tls:
    - hosts:
        - api.empresa.com
      secretName: pedidos-api-tls
  rules:
    - host: api.empresa.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: pedidos-api-service
                port:
                  number: 80
```

---

## ğŸ“Š HorizontalPodAutoscaler

```yaml
# hpa.yaml

apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: pedidos-api-hpa
  namespace: prod
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: pedidos-api
  minReplicas: 3
  maxReplicas: 10
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 50
          periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
        - type: Percent
          value: 100
          periodSeconds: 30
```

---

## ğŸ—„ï¸ PersistentVolumeClaim

```yaml
# pvc.yaml

apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: postgres-pvc
  namespace: prod
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 20Gi
  storageClassName: standard
```

---

## ğŸš€ Deploy Completo

### Kustomization

```yaml
# kustomization.yaml

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: prod

resources:
  - deployment.yaml
  - service.yaml
  - ingress.yaml
  - hpa.yaml
  - configmap.yaml
  - secrets.yaml

images:
  - name: empresa/pedidos-api
    newTag: 1.0.0

configMapGenerator:
  - name: app-config
    literals:
      - JAVA_OPTS="-Xms512m -Xmx1024m"
      - LOG_LEVEL=INFO

secretGenerator:
  - name: app-secrets
    literals:
      - database-password=secure_password
```

### Comandos

```bash
# Aplicar configuraÃ§Ãµes
kubectl apply -f deployment.yaml
kubectl apply -f service.yaml
kubectl apply -f ingress.yaml
kubectl apply -f hpa.yaml

# Ou via kustomize
kubectl apply -k .

# Ver recursos
kubectl get all -n prod

# Ver logs
kubectl logs -f deployment/pedidos-api -n prod

# Escalar manualmente
kubectl scale deployment pedidos-api --replicas=5 -n prod

# Rollout status
kubectl rollout status deployment/pedidos-api -n prod

# Rollback
kubectl rollout undo deployment/pedidos-api -n prod

# Exec em pod
kubectl exec -it pedidos-api-xxx-yyy -n prod -- sh

# Port forward (debug)
kubectl port-forward svc/pedidos-api-service 8080:80 -n prod
```

---

## ğŸ” Health Checks Spring Boot

```yaml
# application.yml

management:
  endpoint:
    health:
      probes:
        enabled: true
  health:
    livenessState:
      enabled: true
    readinessState:
      enabled: true
```

**Endpoints:**

- **Liveness**: `/actuator/health/liveness` - Pod estÃ¡ vivo?
- **Readiness**: `/actuator/health/readiness` - Pod pronto para trÃ¡fego?

---

## ğŸ“‹ Boas PrÃ¡ticas

### âœ… RecomendaÃ§Ãµes

```yaml
# âœ… Sempre defina resource limits
resources:
  requests:
    memory: "512Mi"
    cpu: "500m"
  limits:
    memory: "1Gi"
    cpu: "1000m"

# âœ… Use health checks
livenessProbe:
  httpGet:
    path: /actuator/health/liveness

# âœ… Rolling updates (zero downtime)
strategy:
  type: RollingUpdate
  rollingUpdate:
    maxUnavailable: 0

# âœ… Use namespaces
metadata:
  namespace: prod

# âœ… Labels e selectors consistentes
metadata:
  labels:
    app: pedidos-api
    version: "1.0.0"

# âœ… Secrets para dados sensÃ­veis
env:
- name: PASSWORD
  valueFrom:
    secretKeyRef:
      name: app-secrets
      key: password

# âœ… ConfigMaps para configuraÃ§Ãµes
envFrom:
- configMapRef:
    name: app-config

# âœ… Autoscaling habilitado
kind: HorizontalPodAutoscaler
```

### âŒ Anti-Patterns

```yaml
# âŒ Sem resource limits
# (pods podem consumir todos recursos do nÃ³)

# âŒ Sem health checks
# (K8s nÃ£o sabe se pod estÃ¡ saudÃ¡vel)

# âŒ Usar :latest
image: pedidos-api:latest  # âŒ
image: pedidos-api:1.0.0   # âœ…

# âŒ Secrets em ConfigMaps
data:
  password: "senha123"  # âŒ ConfigMap nÃ£o Ã© criptografado

# âŒ Rodar como root
securityContext:
  runAsUser: 0  # âŒ

# âœ… Usar usuÃ¡rio nÃ£o-root
securityContext:
  runAsNonRoot: true
  runAsUser: 1000
```

---

## ğŸ¯ Quando Usar Kubernetes?

| CenÃ¡rio                      | Usar K8s? |
| ---------------------------- | --------- |
| Microservices (5+ serviÃ§os)  | âœ… Sim    |
| Autoscaling necessÃ¡rio       | âœ… Sim    |
| Alta disponibilidade crÃ­tica | âœ… Sim    |
| Multi-cloud                  | âœ… Sim    |
| AplicaÃ§Ã£o monolÃ­tica simples | âŒ NÃ£o    |
| Poucos usuÃ¡rios              | âŒ NÃ£o    |

---

## ğŸ”— Recursos

- [Kubernetes Documentation](https://kubernetes.io/docs/)
- [Spring Boot on Kubernetes](https://spring.io/guides/gs/spring-boot-kubernetes/)
- [Kubectl Cheat Sheet](https://kubernetes.io/docs/reference/kubectl/cheatsheet/)

---

## ğŸ“ Resumo

**Kubernetes** garante:

- âœ… **Self-healing**: Reinicia pods com falha
- âœ… **Autoscaling**: Escala automaticamente
- âœ… **Rolling updates**: Zero downtime
- âœ… **Service discovery**: ComunicaÃ§Ã£o entre serviÃ§os
- âœ… **Load balancing**: Distribui trÃ¡fego

**Regra de ouro:** Defina **resource limits**, **health checks**, e use **rolling updates** para zero downtime.
