# 04.17 Builder Pattern [M√âDIO] üèóÔ∏è

## üéØ Objetivo

Construir objetos **complexos** passo a passo com interface fluente, evitando construtores telesc√≥picos e permitindo criar **test fixtures** leg√≠veis e reutiliz√°veis.

---

## üìö O Que √â?

**Builder** √© um padr√£o criacional GoF que separa a constru√ß√£o de um objeto complexo de sua representa√ß√£o, permitindo criar diferentes configura√ß√µes usando o mesmo processo de constru√ß√£o. Essencial para **Test Data Builders** em testes.

### Analogia

Como **montar um hamb√∫rguer personalizado**:

- **Sem Builder**: "Quero hamb√∫rguer com p√£o, carne, queijo, alface, tomate, cebola, picles, mostarda, ketchup"
- **Com Builder**: `Hamburguer.builder().pao(INTEGRAL).carne(DUPLA).queijo().molhos(MOSTARDA, KETCHUP).build()`
- **Vantagem**: Ordem flex√≠vel, par√¢metros opcionais claros

---

## ‚ùå Problema que Resolve

### Antes (Construtor Telesc√≥pico)

```java
// ‚ùå PROBLEMA: Construtor com muitos par√¢metros
public class Usuario {
    public Usuario(String nome, String email) { /*...*/ }
    public Usuario(String nome, String email, String telefone) { /*...*/ }
    public Usuario(String nome, String email, String telefone, LocalDate dataNascimento) { /*...*/ }
    public Usuario(String nome, String email, String telefone, LocalDate dataNascimento,
                   String endereco, String cidade, String estado, String cep) { /*...*/ }
}

// Uso confuso
Usuario user = new Usuario(
    "Jo√£o",
    "joao@test.com",
    null, // telefone
    LocalDate.of(1990, 1, 1),
    null, // endereco
    "S√£o Paulo",
    "SP",
    null // cep - qual par√¢metro √© esse?
);

// Testes ileg√≠veis
@Test
void teste() {
    Usuario admin = new Usuario("Admin", "admin@test.com", "+5511",
        LocalDate.of(1985, 5, 10), "Rua A", "SP", "SP", "01000-000");
    Usuario guest = new Usuario("Guest", "guest@test.com", null, null, null, null, null, null);
}
```

**Problemas**:

- ü§Ø Dif√≠cil saber o que cada par√¢metro significa
- üêõ F√°cil passar argumentos na ordem errada
- üß™ Testes verbosos e dif√≠ceis de ler
- üîß Adicionar campo = quebrar todos os construtores

### Depois (Builder Pattern)

```java
// ‚úÖ SOLU√á√ÉO: Builder fluente e leg√≠vel
public class Usuario {
    private final String nome;
    private final String email;
    private final String telefone;
    private final LocalDate dataNascimento;
    private final String endereco;

    private Usuario(Builder builder) {
        this.nome = builder.nome;
        this.email = builder.email;
        this.telefone = builder.telefone;
        this.dataNascimento = builder.dataNascimento;
        this.endereco = builder.endereco;
    }

    public static Builder builder() {
        return new Builder();
    }

    public static class Builder {
        private String nome;
        private String email;
        private String telefone;
        private LocalDate dataNascimento;
        private String endereco;

        public Builder nome(String nome) {
            this.nome = nome;
            return this;
        }

        public Builder email(String email) {
            this.email = email;
            return this;
        }

        public Builder telefone(String telefone) {
            this.telefone = telefone;
            return this;
        }

        public Builder dataNascimento(LocalDate data) {
            this.dataNascimento = data;
            return this;
        }

        public Builder endereco(String endereco) {
            this.endereco = endereco;
            return this;
        }

        public Usuario build() {
            if (nome == null || email == null) {
                throw new IllegalStateException("Nome e email s√£o obrigat√≥rios");
            }
            return new Usuario(this);
        }
    }
}

// Uso leg√≠vel
Usuario user = Usuario.builder()
    .nome("Jo√£o")
    .email("joao@test.com")
    .dataNascimento(LocalDate.of(1990, 1, 1))
    .build();

// Testes muito mais leg√≠veis
@Test
void teste() {
    Usuario admin = Usuario.builder()
        .nome("Admin")
        .email("admin@test.com")
        .telefone("+5511")
        .build();

    Usuario guest = Usuario.builder()
        .nome("Guest")
        .email("guest@test.com")
        .build();
}
```

---

## üîß Implementa√ß√£o Completa

### 1. Builder B√°sico

```java
record Usuario(
    String nome,
    String email,
    String telefone,
    LocalDate dataNascimento,
    Endereco endereco,
    Role role,
    boolean ativo
) {
    // Valida√ß√µes no construtor can√¥nico
    public Usuario {
        if (nome == null || nome.isBlank()) {
            throw new IllegalArgumentException("Nome obrigat√≥rio");
        }
        if (email == null || !email.contains("@")) {
            throw new IllegalArgumentException("Email inv√°lido");
        }
    }

    public static Builder builder() {
        return new Builder();
    }

    public static class Builder {
        private String nome;
        private String email;
        private String telefone;
        private LocalDate dataNascimento;
        private Endereco endereco;
        private Role role = Role.USER; // Valor padr√£o
        private boolean ativo = true;

        public Builder nome(String nome) {
            this.nome = nome;
            return this;
        }

        public Builder email(String email) {
            this.email = email;
            return this;
        }

        public Builder telefone(String telefone) {
            this.telefone = telefone;
            return this;
        }

        public Builder dataNascimento(LocalDate data) {
            this.dataNascimento = data;
            return this;
        }

        public Builder endereco(Endereco endereco) {
            this.endereco = endereco;
            return this;
        }

        public Builder role(Role role) {
            this.role = role;
            return this;
        }

        public Builder ativo(boolean ativo) {
            this.ativo = ativo;
            return this;
        }

        // M√©todos de conveni√™ncia
        public Builder admin() {
            this.role = Role.ADMIN;
            return this;
        }

        public Builder inativo() {
            this.ativo = false;
            return this;
        }

        public Usuario build() {
            return new Usuario(
                nome,
                email,
                telefone,
                dataNascimento,
                endereco,
                role,
                ativo
            );
        }
    }
}

enum Role { USER, ADMIN, GUEST }

record Endereco(String rua, String cidade, String estado, String cep) {}
```

### 2. Test Data Builder (Object Mother)

```java
final class UsuarioTestBuilder {
    private String nome = "User Default";
    private String email = "user@test.com";
    private String telefone = "+5511999999999";
    private LocalDate dataNascimento = LocalDate.of(1990, 1, 1);
    private Endereco endereco = new Endereco("Rua A", "S√£o Paulo", "SP", "01000-000");
    private Role role = Role.USER;
    private boolean ativo = true;

    public static UsuarioTestBuilder umUsuario() {
        return new UsuarioTestBuilder();
    }

    public static UsuarioTestBuilder umAdmin() {
        return new UsuarioTestBuilder()
            .comRole(Role.ADMIN)
            .comNome("Admin User")
            .comEmail("admin@test.com");
    }

    public static UsuarioTestBuilder umGuest() {
        return new UsuarioTestBuilder()
            .comRole(Role.GUEST)
            .comNome("Guest User")
            .comEmail("guest@test.com")
            .semTelefone();
    }

    public UsuarioTestBuilder comNome(String nome) {
        this.nome = nome;
        return this;
    }

    public UsuarioTestBuilder comEmail(String email) {
        this.email = email;
        return this;
    }

    public UsuarioTestBuilder comTelefone(String telefone) {
        this.telefone = telefone;
        return this;
    }

    public UsuarioTestBuilder semTelefone() {
        this.telefone = null;
        return this;
    }

    public UsuarioTestBuilder comDataNascimento(LocalDate data) {
        this.dataNascimento = data;
        return this;
    }

    public UsuarioTestBuilder comEndereco(Endereco endereco) {
        this.endereco = endereco;
        return this;
    }

    public UsuarioTestBuilder semEndereco() {
        this.endereco = null;
        return this;
    }

    public UsuarioTestBuilder comRole(Role role) {
        this.role = role;
        return this;
    }

    public UsuarioTestBuilder inativo() {
        this.ativo = false;
        return this;
    }

    public Usuario build() {
        return new Usuario(
            nome,
            email,
            telefone,
            dataNascimento,
            endereco,
            role,
            ativo
        );
    }
}
```

### 3. Builder com Valida√ß√£o Progressiva

```java
// Builder com tipos para garantir ordem
final class PedidoBuilder {

    public static ICliente builder() {
        return new Steps();
    }

    public interface ICliente {
        IProdutos comCliente(String clienteId);
    }

    public interface IProdutos {
        IProdutos adicionarProduto(String produtoId, int quantidade);
        IFinalizacao finalizar();
    }

    public interface IFinalizacao {
        IFinalizacao comDesconto(BigDecimal desconto);
        IFinalizacao comFrete(BigDecimal frete);
        Pedido build();
    }

    private static class Steps implements ICliente, IProdutos, IFinalizacao {
        private String clienteId;
        private List<ItemPedido> itens = new ArrayList<>();
        private BigDecimal desconto = BigDecimal.ZERO;
        private BigDecimal frete = BigDecimal.ZERO;

        @Override
        public IProdutos comCliente(String clienteId) {
            this.clienteId = clienteId;
            return this;
        }

        @Override
        public IProdutos adicionarProduto(String produtoId, int quantidade) {
            itens.add(new ItemPedido(produtoId, quantidade));
            return this;
        }

        @Override
        public IFinalizacao finalizar() {
            if (itens.isEmpty()) {
                throw new IllegalStateException("Pedido sem itens");
            }
            return this;
        }

        @Override
        public IFinalizacao comDesconto(BigDecimal desconto) {
            this.desconto = desconto;
            return this;
        }

        @Override
        public IFinalizacao comFrete(BigDecimal frete) {
            this.frete = frete;
            return this;
        }

        @Override
        public Pedido build() {
            return new Pedido(clienteId, List.copyOf(itens), desconto, frete);
        }
    }
}

record Pedido(
    String clienteId,
    List<ItemPedido> itens,
    BigDecimal desconto,
    BigDecimal frete
) {
    public BigDecimal getTotal() {
        BigDecimal subtotal = itens.stream()
            .map(i -> i.preco().multiply(BigDecimal.valueOf(i.quantidade())))
            .reduce(BigDecimal.ZERO, BigDecimal::add);

        return subtotal.subtract(desconto).add(frete);
    }
}

record ItemPedido(String produtoId, int quantidade, BigDecimal preco) {
    ItemPedido(String produtoId, int quantidade) {
        this(produtoId, quantidade, new BigDecimal("10.00")); // Pre√ßo mock
    }
}
```

---

## üß™ Como Testar

### 1. Testar Builder Cria Objeto V√°lido

```java
@Test
void builderDeveCriarUsuarioCompleto() {
    // Arrange & Act
    Usuario usuario = Usuario.builder()
        .nome("Jo√£o Silva")
        .email("joao@test.com")
        .telefone("+5511999999999")
        .dataNascimento(LocalDate.of(1990, 5, 15))
        .endereco(new Endereco("Rua A", "S√£o Paulo", "SP", "01000-000"))
        .role(Role.ADMIN)
        .ativo(true)
        .build();

    // Assert
    assertEquals("Jo√£o Silva", usuario.nome());
    assertEquals("joao@test.com", usuario.email());
    assertEquals(Role.ADMIN, usuario.role());
    assertTrue(usuario.ativo());
}
```

### 2. Testar Builder com Campos Opcionais

```java
@Test
void builderDevePermitirCamposOpcionais() {
    // Arrange & Act
    Usuario usuario = Usuario.builder()
        .nome("Maria")
        .email("maria@test.com")
        .build(); // Sem telefone, data, endere√ßo

    // Assert
    assertEquals("Maria", usuario.nome());
    assertNull(usuario.telefone());
    assertNull(usuario.dataNascimento());
    assertEquals(Role.USER, usuario.role()); // Valor padr√£o
    assertTrue(usuario.ativo()); // Valor padr√£o
}
```

### 3. Testar Builder Valida Campos Obrigat√≥rios

```java
@Test
void builderDeveFalharSemNome() {
    // Arrange
    Usuario.Builder builder = Usuario.builder()
        .email("test@test.com");

    // Act & Assert
    IllegalArgumentException ex = assertThrows(
        IllegalArgumentException.class,
        builder::build
    );

    assertTrue(ex.getMessage().contains("Nome obrigat√≥rio"));
}
```

### 4. Testar Test Data Builder

```java
@Test
void testBuilderDeveCriarAdminPreConfigurado() {
    // Arrange & Act
    Usuario admin = UsuarioTestBuilder.umAdmin().build();

    // Assert
    assertEquals("Admin User", admin.nome());
    assertEquals("admin@test.com", admin.email());
    assertEquals(Role.ADMIN, admin.role());
}
```

### 5. Testar Test Builder com Customiza√ß√£o

```java
@Test
void testBuilderDevePermitirCustomizacao() {
    // Arrange & Act
    Usuario usuario = UsuarioTestBuilder.umAdmin()
        .comNome("Super Admin")
        .inativo()
        .build();

    // Assert
    assertEquals("Super Admin", usuario.nome());
    assertEquals(Role.ADMIN, usuario.role());
    assertFalse(usuario.ativo());
}
```

### 6. Testar Builder Typesafe (Ordem Garantida)

```java
@Test
void builderTypesafeDeveGarantirOrdem() {
    // Arrange & Act
    Pedido pedido = PedidoBuilder.builder()
        .comCliente("C123")
        .adicionarProduto("P1", 2)
        .adicionarProduto("P2", 1)
        .finalizar()
        .comDesconto(new BigDecimal("10.00"))
        .comFrete(new BigDecimal("5.00"))
        .build();

    // Assert
    assertEquals("C123", pedido.clienteId());
    assertEquals(2, pedido.itens().size());
    assertEquals(new BigDecimal("25.00"), pedido.getTotal()); // (20 + 10) - 10 + 5
}
```

### 7. Testar Builder N√£o Permite Estado Inv√°lido

```java
@Test
void builderTypesafeDeveFalharSemProdutos() {
    // Arrange & Act & Assert
    assertThrows(IllegalStateException.class, () -> {
        PedidoBuilder.builder()
            .comCliente("C123")
            .finalizar(); // Sem produtos!
    });
}
```

---

## ‚ö†Ô∏è Cuidados Importantes

### ‚ùå Evitar

```java
// ‚ùå Builder mut√°vel (perigoso)
Usuario.Builder builder = Usuario.builder().nome("Jo√£o");
Usuario user1 = builder.build();
builder.nome("Maria"); // Modifica builder usado!
Usuario user2 = builder.build(); // Reaproveita builder ‚ùå

// ‚ùå Valida√ß√£o apenas no build()
builder.email("email-invalido"); // Aceita silenciosamente
Usuario user = builder.build(); // S√≥ aqui explode

// ‚ùå Builder com l√≥gica de neg√≥cio
builder.calcularDesconto().aplicarTaxas().build(); // ‚ùå
```

### ‚úÖ Fazer

```java
// ‚úÖ Builder novo para cada objeto
Usuario user1 = Usuario.builder().nome("Jo√£o").build();
Usuario user2 = Usuario.builder().nome("Maria").build();

// ‚úÖ Valida√ß√£o imediata (fail fast)
public Builder email(String email) {
    if (email == null || !email.contains("@")) {
        throw new IllegalArgumentException("Email inv√°lido");
    }
    this.email = email;
    return this;
}

// ‚úÖ Builder apenas constr√≥i
Usuario user = Usuario.builder()
    .nome("Jo√£o")
    .email("joao@test.com")
    .build();

// L√≥gica de neg√≥cio no service
descontoService.calcular(user);
```

---

## üìä Boas Pr√°ticas

- ‚úÖ **Valores padr√£o**: Inicializar campos com defaults razo√°veis
- ‚úÖ **Valida√ß√£o progressiva**: Fail fast em cada m√©todo setter
- ‚úÖ **Imutabilidade**: Builder retorna novo objeto, n√£o modifica existente
- ‚úÖ **Test Data Builders**: Criar builders espec√≠ficos para testes
- ‚úÖ **M√©todos de conveni√™ncia**: `admin()`, `inativo()`, `semTelefone()`
- ‚úÖ **Typesafe builders**: Usar interfaces para garantir ordem
- ‚úÖ **Documenta√ß√£o**: Javadoc para campos opcionais vs obrigat√≥rios

---

## üîó Integra√ß√£o com Frameworks

### Lombok Builder

```java
@Builder
@Data
public class Usuario {
    private String nome;
    private String email;
    private String telefone;
    private LocalDate dataNascimento;

    @Builder.Default
    private Role role = Role.USER;

    @Builder.Default
    private boolean ativo = true;
}

// Uso
Usuario user = Usuario.builder()
    .nome("Jo√£o")
    .email("joao@test.com")
    .build();
```

### Lombok com Test Builders

```java
@Test
void teste() {
    // Lombok @Builder facilita test builders
    Usuario admin = Usuario.builder()
        .nome("Admin")
        .email("admin@test.com")
        .role(Role.ADMIN)
        .build();

    Usuario guest = Usuario.builder()
        .nome("Guest")
        .email("guest@test.com")
        .role(Role.GUEST)
        .ativo(false)
        .build();
}
```

---

## ‚úÖ Vantagens vs ‚ö†Ô∏è Desvantagens

| ‚úÖ Vantagens            | ‚ö†Ô∏è Desvantagens                   |
| ----------------------- | --------------------------------- |
| Legibilidade alta       | Mais c√≥digo (boilerplate)         |
| Campos opcionais claros | Builder pode ficar complexo       |
| Testes muito leg√≠veis   | Lombok ajuda mas esconde detalhes |
| Ordem flex√≠vel          | Valida√ß√£o distribu√≠da (cuidado)   |
| Imutabilidade f√°cil     | Verboso sem Lombok                |

---

## üîç Compara√ß√£o

| Padr√£o             | Quando Usar                                 | Testabilidade                  |
| ------------------ | ------------------------------------------- | ------------------------------ |
| **Builder**        | Objetos complexos, muitos campos opcionais  | Excelente (Test Data Builders) |
| **Factory Method** | Criar tipos diferentes baseado em par√¢metro | Boa                            |
| **Prototype**      | Clonar objetos existentes                   | M√©dia                          |
| **Construtor**     | Objetos simples (2-3 campos)                | Boa                            |

---

## üß† Exerc√≠cios Pr√°ticos

1. **Implementar builder com Lombok** e comparar verbosidade
2. **Criar Object Mother** com builders pr√©-configurados (umAdminAtivo(), umUsuarioInativo())
3. **Builder hier√°rquico** (PessoaBuilder ‚Üí ClienteBuilder ‚Üí ClienteVIPBuilder)
4. **Builder com valida√ß√£o cross-field** (dataInicio < dataFim)
5. **Builder async** retornando `CompletableFuture<Usuario>`

---

## üìö Relacionado

- **Factory Method**: Criar objetos baseado em tipo
- **Prototype**: Clonar objetos existentes
- **Object Mother**: Pattern espec√≠fico para test fixtures
- **Fluent Interface**: API fluente para DSLs

---

**Builder Pattern torna testes leg√≠veis e objetos complexos f√°ceis de construir!** üèóÔ∏è‚ú®
