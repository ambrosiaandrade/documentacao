# 04.37 SOA - Service-Oriented Architecture [AVAN√áADO] üè¢

## üéØ Objetivo

Organizar aplica√ß√£o como **servi√ßos reutiliz√°veis** com contratos bem definidos, comunicando via **ESB (Enterprise Service Bus)** ou APIs, permitindo **testes de contratos** e interoperabilidade entre tecnologias.

---

## üìö O Que √â?

**SOA (Service-Oriented Architecture)** estrutura aplica√ß√£o como conjunto de servi√ßos independentes e reutiliz√°veis, cada um com contrato (interface) bem definido. Servi√ßos se comunicam via protocolos padronizados (SOAP, REST), frequentemente atrav√©s de um ESB.

### Analogia

Como **shopping center com lojas especializadas**:

- **Lojas (Servi√ßos)**: Cada uma tem especialidade (banco, correio, loja de roupas)
- **Corredores/Diret√≥rios (ESB)**: Facilitam encontrar e acessar servi√ßos
- **Placas/Cat√°logo (Contratos WSDL)**: Descrevem o que cada loja oferece
- **Vantagem**: Cliente n√£o precisa saber como loja funciona internamente, apenas usar o servi√ßo

---

## ‚ùå Problema que Resolve

### Antes (Sistema Monol√≠tico Acoplado)

```java
// ‚ùå PROBLEMA: L√≥gica de neg√≥cio espalhada, sem reutiliza√ß√£o

@RestController
class PedidoController {

    @Autowired
    private EntityManager em; // Acesso direto ao banco ‚ùå

    @PostMapping("/pedidos")
    void criarPedido(PedidoRequest req) {
        // Valida√ß√£o de cliente (duplicada em v√°rios lugares) ‚ùå
        Cliente cliente = em.find(Cliente.class, req.clienteId());
        if (cliente == null) {
            throw new RuntimeException("Cliente inv√°lido");
        }

        // C√°lculo de desconto (duplicado) ‚ùå
        BigDecimal desconto = BigDecimal.ZERO;
        if (cliente.getTipo() == TipoCliente.VIP) {
            desconto = req.valorTotal().multiply(new BigDecimal("0.1"));
        }

        // Valida√ß√£o de estoque (l√≥gica espalhada) ‚ùå
        for (ItemPedido item : req.itens()) {
            Produto p = em.find(Produto.class, item.produtoId());
            if (p.getEstoque() < item.quantidade()) {
                throw new RuntimeException("Estoque insuficiente");
            }
            p.setEstoque(p.getEstoque() - item.quantidade());
        }

        // Pagamento (duplicado) ‚ùå
        // ... 50+ linhas de l√≥gica de pagamento

        // Faturamento (duplicado) ‚ùå
        // ... 30+ linhas de emiss√£o de nota

        // Problemas:
        // - L√≥gica duplicada em m√∫ltiplos controllers ‚ùå
        // - Sem reuso entre aplica√ß√µes ‚ùå
        // - Dif√≠cil testar isoladamente ‚ùå
        // - Mudan√ßa em regra = alterar m√∫ltiplos lugares ‚ùå
        // - Sem contratos expl√≠citos ‚ùå
    }
}
```

**Problemas**:

- üîÅ L√≥gica duplicada
- üö´ Sem reutiliza√ß√£o entre aplica√ß√µes
- üß™ Dif√≠cil testar
- üìù Sem contratos formais
- üîß Manuten√ß√£o complexa

### Depois (SOA com Servi√ßos Reutiliz√°veis)

```java
// ‚úÖ SOLU√á√ÉO: Servi√ßos especializados com contratos

// ==== SERVI√áO DE CLIENTES (reutiliz√°vel) ====
@WebService(serviceName = "ClienteService")
@SOAPBinding(style = Style.DOCUMENT)
interface ClienteService {

    @WebMethod
    ClienteDTO buscarCliente(@WebParam(name = "clienteId") Long clienteId);

    @WebMethod
    BigDecimal calcularDesconto(@WebParam(name = "clienteId") Long clienteId,
                                @WebParam(name = "valorTotal") BigDecimal valorTotal);
}

@Service
@WebService(endpointInterface = "com.example.ClienteService")
class ClienteServiceImpl implements ClienteService {

    @Override
    public ClienteDTO buscarCliente(Long clienteId) {
        // L√≥gica centralizada ‚úÖ
        return repository.findById(clienteId)
            .map(ClienteDTO::from)
            .orElseThrow(() -> new ClienteNaoEncontradoException(clienteId));
    }

    @Override
    public BigDecimal calcularDesconto(Long clienteId, BigDecimal valorTotal) {
        Cliente cliente = repository.findById(clienteId).orElseThrow();

        // Regra de desconto centralizada ‚úÖ
        return switch (cliente.getTipo()) {
            case VIP -> valorTotal.multiply(new BigDecimal("0.15"));
            case PREMIUM -> valorTotal.multiply(new BigDecimal("0.10"));
            case REGULAR -> valorTotal.multiply(new BigDecimal("0.05"));
            default -> BigDecimal.ZERO;
        };
    }
}

// ==== SERVI√áO DE ESTOQUE (reutiliz√°vel) ====
@WebService(serviceName = "EstoqueService")
interface EstoqueService {

    @WebMethod
    boolean verificarDisponibilidade(@WebParam(name = "produtoId") Long produtoId,
                                     @WebParam(name = "quantidade") int quantidade);

    @WebMethod
    void reservarEstoque(@WebParam(name = "itens") List<ItemReserva> itens);
}

// ==== SERVI√áO DE PAGAMENTO (reutiliz√°vel) ====
@WebService(serviceName = "PagamentoService")
interface PagamentoService {

    @WebMethod
    PagamentoResultado processarPagamento(@WebParam(name = "request") PagamentoRequest request);
}

// ==== CONTROLLER (orquestra servi√ßos) ====
@RestController
class PedidoController {

    private final ClienteService clienteService; // Servi√ßo reutiliz√°vel ‚úÖ
    private final EstoqueService estoqueService; // Servi√ßo reutiliz√°vel ‚úÖ
    private final PagamentoService pagamentoService; // Servi√ßo reutiliz√°vel ‚úÖ

    @PostMapping("/pedidos")
    PedidoDTO criarPedido(PedidoRequest req) {
        // Usa servi√ßos reutiliz√°veis ‚úÖ
        ClienteDTO cliente = clienteService.buscarCliente(req.clienteId());

        BigDecimal desconto = clienteService.calcularDesconto(
            req.clienteId(),
            req.valorTotal()
        );

        estoqueService.reservarEstoque(req.itens());

        PagamentoResultado pagamento = pagamentoService.processarPagamento(
            new PagamentoRequest(req.valorTotal().subtract(desconto))
        );

        // L√≥gica m√≠nima, apenas orquestra√ß√£o ‚úÖ
        return salvarPedido(req, pagamento);
    }
}

// ‚úÖ Vantagens:
// - Servi√ßos reutiliz√°veis em m√∫ltiplas aplica√ß√µes ‚úÖ
// - Contratos expl√≠citos (WSDL) ‚úÖ
// - Test√°vel isoladamente ‚úÖ
// - Mudan√ßa em regra = alterar apenas um servi√ßo ‚úÖ
// - Interoperabilidade (.NET pode usar servi√ßo Java) ‚úÖ
```

---

## üîß Implementa√ß√£o Completa

### 1. Servi√ßo SOAP com Contrato WSDL

```java
// Contrato do servi√ßo (gerado automaticamente para WSDL)
@WebService(
    serviceName = "ClienteService",
    portName = "ClientePort",
    targetNamespace = "http://example.com/cliente"
)
@SOAPBinding(style = Style.DOCUMENT, use = Use.LITERAL)
public interface ClienteService {

    @WebMethod(operationName = "buscarCliente")
    @WebResult(name = "cliente")
    ClienteDTO buscarCliente(
        @WebParam(name = "clienteId") Long clienteId
    ) throws ClienteNaoEncontradoException;

    @WebMethod(operationName = "validarCliente")
    @WebResult(name = "valido")
    boolean validarCliente(
        @WebParam(name = "clienteId") Long clienteId
    );

    @WebMethod(operationName = "calcularDesconto")
    @WebResult(name = "desconto")
    BigDecimal calcularDesconto(
        @WebParam(name = "clienteId") Long clienteId,
        @WebParam(name = "valorTotal") BigDecimal valorTotal
    );

    @WebMethod(operationName = "listarClientesPorTipo")
    @WebResult(name = "clientes")
    List<ClienteDTO> listarClientesPorTipo(
        @WebParam(name = "tipo") TipoCliente tipo
    );
}

// Implementa√ß√£o do servi√ßo
@Service
@WebService(
    endpointInterface = "com.example.services.ClienteService",
    serviceName = "ClienteService",
    portName = "ClientePort",
    targetNamespace = "http://example.com/cliente"
)
public class ClienteServiceImpl implements ClienteService {

    private final ClienteRepository repository;

    @Autowired
    public ClienteServiceImpl(ClienteRepository repository) {
        this.repository = repository;
    }

    @Override
    public ClienteDTO buscarCliente(Long clienteId) throws ClienteNaoEncontradoException {
        System.out.println("üîç [ClienteService] Buscando cliente: " + clienteId);

        return repository.findById(clienteId)
            .map(this::toDTO)
            .orElseThrow(() -> new ClienteNaoEncontradoException(
                "Cliente n√£o encontrado: " + clienteId
            ));
    }

    @Override
    public boolean validarCliente(Long clienteId) {
        System.out.println("‚úì [ClienteService] Validando cliente: " + clienteId);
        return repository.existsById(clienteId);
    }

    @Override
    public BigDecimal calcularDesconto(Long clienteId, BigDecimal valorTotal) {
        System.out.println("üí∞ [ClienteService] Calculando desconto para: " + clienteId);

        Cliente cliente = repository.findById(clienteId)
            .orElseThrow(() -> new ClienteNaoEncontradoException(clienteId));

        // Regra de neg√≥cio centralizada
        BigDecimal percentualDesconto = switch (cliente.getTipo()) {
            case VIP -> new BigDecimal("0.15");
            case PREMIUM -> new BigDecimal("0.10");
            case REGULAR -> new BigDecimal("0.05");
            default -> BigDecimal.ZERO;
        };

        return valorTotal.multiply(percentualDesconto);
    }

    @Override
    public List<ClienteDTO> listarClientesPorTipo(TipoCliente tipo) {
        System.out.println("üìã [ClienteService] Listando clientes tipo: " + tipo);

        return repository.findByTipo(tipo).stream()
            .map(this::toDTO)
            .toList();
    }

    private ClienteDTO toDTO(Cliente cliente) {
        return new ClienteDTO(
            cliente.getId(),
            cliente.getNome(),
            cliente.getEmail(),
            cliente.getTipo()
        );
    }
}

// DTOs (transfer√™ncia de dados)
record ClienteDTO(
    Long id,
    String nome,
    String email,
    TipoCliente tipo
) {}

enum TipoCliente {
    VIP, PREMIUM, REGULAR, BASICO
}

// Exception (SOAP Fault)
@WebFault(name = "ClienteNaoEncontradoFault")
public class ClienteNaoEncontradoException extends Exception {

    public ClienteNaoEncontradoException(String message) {
        super(message);
    }

    public ClienteNaoEncontradoException(Long clienteId) {
        super("Cliente n√£o encontrado: " + clienteId);
    }
}
```

### 2. Publica√ß√£o do Servi√ßo (Endpoint)

```java
// Configura√ß√£o Spring Boot para expor servi√ßos SOAP
@Configuration
public class WebServiceConfig {

    @Bean
    public ServletRegistrationBean<CXFServlet> cxfServlet() {
        return new ServletRegistrationBean<>(new CXFServlet(), "/services/*");
    }

    @Bean
    public SpringBus springBus() {
        return new SpringBus();
    }

    @Bean
    public Endpoint clienteEndpoint(ClienteService clienteService) {
        EndpointImpl endpoint = new EndpointImpl(springBus(), clienteService);
        endpoint.publish("/cliente");
        return endpoint;
    }

    @Bean
    public Endpoint estoqueEndpoint(EstoqueService estoqueService) {
        EndpointImpl endpoint = new EndpointImpl(springBus(), estoqueService);
        endpoint.publish("/estoque");
        return endpoint;
    }

    @Bean
    public Endpoint pagamentoEndpoint(PagamentoService pagamentoService) {
        EndpointImpl endpoint = new EndpointImpl(springBus(), pagamentoService);
        endpoint.publish("/pagamento");
        return endpoint;
    }
}

// WSDL dispon√≠vel em: http://localhost:8080/services/cliente?wsdl
```

### 3. Cliente SOAP (Consumidor do Servi√ßo)

```java
// Cliente SOAP gerado a partir do WSDL
@Service
public class ClienteServiceClient {

    private final ClienteService clienteService;

    @Autowired
    public ClienteServiceClient() {
        // Gera proxy a partir do WSDL
        URL wsdlURL = new URL("http://localhost:8080/services/cliente?wsdl");

        QName qname = new QName(
            "http://example.com/cliente",
            "ClienteService"
        );

        Service service = Service.create(wsdlURL, qname);
        this.clienteService = service.getPort(ClienteService.class);
    }

    public ClienteDTO buscarCliente(Long clienteId) {
        try {
            System.out.println("üìû [Cliente SOAP] Chamando servi√ßo remoto...");
            return clienteService.buscarCliente(clienteId);

        } catch (ClienteNaoEncontradoException e) {
            System.err.println("‚ùå Cliente n√£o encontrado: " + e.getMessage());
            throw new RuntimeException(e);
        }
    }
}
```

### 4. Servi√ßo REST (SOA Moderno)

```java
// SOA n√£o √© apenas SOAP - REST tamb√©m √© SOA!

@RestController
@RequestMapping("/api/v1/estoque")
public class EstoqueServiceController {

    private final EstoqueRepository repository;

    @Autowired
    public EstoqueServiceController(EstoqueRepository repository) {
        this.repository = repository;
    }

    // Contrato REST (OpenAPI/Swagger)
    @Operation(summary = "Verificar disponibilidade de produto")
    @ApiResponses({
        @ApiResponse(responseCode = "200", description = "Disponibilidade verificada"),
        @ApiResponse(responseCode = "404", description = "Produto n√£o encontrado")
    })
    @GetMapping("/{produtoId}/disponibilidade")
    public DisponibilidadeResponse verificarDisponibilidade(
        @PathVariable Long produtoId,
        @RequestParam int quantidade
    ) {
        System.out.println("üì¶ [EstoqueService] Verificando: " + produtoId);

        Produto produto = repository.findById(produtoId)
            .orElseThrow(() -> new ProdutoNaoEncontradoException(produtoId));

        boolean disponivel = produto.getEstoque() >= quantidade;

        return new DisponibilidadeResponse(
            produtoId,
            produto.getEstoque(),
            quantidade,
            disponivel
        );
    }

    @Operation(summary = "Reservar estoque")
    @PostMapping("/reservar")
    @Transactional
    public ReservaResponse reservarEstoque(@RequestBody @Valid ReservaRequest request) {
        System.out.println("üîí [EstoqueService] Reservando itens: " + request.itens().size());

        List<ItemReserva> reservados = new ArrayList<>();

        for (ItemReservaRequest item : request.itens()) {
            Produto produto = repository.findById(item.produtoId())
                .orElseThrow(() -> new ProdutoNaoEncontradoException(item.produtoId()));

            if (produto.getEstoque() < item.quantidade()) {
                throw new EstoqueInsuficienteException(
                    produto.getId(),
                    produto.getEstoque(),
                    item.quantidade()
                );
            }

            produto.setEstoque(produto.getEstoque() - item.quantidade());
            repository.save(produto);

            reservados.add(new ItemReserva(
                produto.getId(),
                item.quantidade(),
                produto.getEstoque()
            ));
        }

        return new ReservaResponse(
            UUID.randomUUID().toString(),
            reservados,
            LocalDateTime.now()
        );
    }

    @Operation(summary = "Liberar reserva de estoque")
    @PostMapping("/liberar")
    @Transactional
    public void liberarEstoque(@RequestBody @Valid LiberarEstoqueRequest request) {
        System.out.println("üîì [EstoqueService] Liberando reserva: " + request.reservaId());

        for (ItemReservaRequest item : request.itens()) {
            Produto produto = repository.findById(item.produtoId())
                .orElseThrow(() -> new ProdutoNaoEncontradoException(item.produtoId()));

            produto.setEstoque(produto.getEstoque() + item.quantidade());
            repository.save(produto);
        }
    }
}

// DTOs REST
record DisponibilidadeResponse(
    Long produtoId,
    int estoqueAtual,
    int quantidadeSolicitada,
    boolean disponivel
) {}

record ReservaRequest(
    @NotEmpty List<ItemReservaRequest> itens
) {}

record ItemReservaRequest(
    @NotNull Long produtoId,
    @Min(1) int quantidade
) {}

record ReservaResponse(
    String reservaId,
    List<ItemReserva> itens,
    LocalDateTime timestamp
) {}
```

### 5. ESB (Enterprise Service Bus) Simplificado

```java
// ESB Pattern - Roteamento e Transforma√ß√£o de Mensagens

@Component
public class EnterpriseServiceBus {

    private final Map<String, ServiceEndpoint> serviceRegistry = new ConcurrentHashMap<>();
    private final ObjectMapper objectMapper = new ObjectMapper();

    // Registro de servi√ßos
    public void registerService(String serviceName, ServiceEndpoint endpoint) {
        System.out.println("üìù [ESB] Registrando servi√ßo: " + serviceName);
        serviceRegistry.put(serviceName, endpoint);
    }

    // Roteamento de mensagens
    public <T> T routeMessage(String serviceName, String operation, Object request, Class<T> responseType) {
        System.out.println("üîÄ [ESB] Roteando para: " + serviceName + "." + operation);

        ServiceEndpoint endpoint = serviceRegistry.get(serviceName);
        if (endpoint == null) {
            throw new ServiceNotFoundException("Servi√ßo n√£o encontrado: " + serviceName);
        }

        try {
            // Transforma√ß√£o de mensagem (se necess√°rio)
            String jsonRequest = objectMapper.writeValueAsString(request);

            // Chamada ao servi√ßo
            Object response = endpoint.invoke(operation, jsonRequest);

            // Transforma√ß√£o de resposta
            String jsonResponse = objectMapper.writeValueAsString(response);
            return objectMapper.readValue(jsonResponse, responseType);

        } catch (Exception e) {
            System.err.println("‚ùå [ESB] Erro ao rotear: " + e.getMessage());
            throw new ServiceInvocationException("Erro ao invocar servi√ßo", e);
        }
    }

    // Monitoramento de servi√ßos
    public Map<String, ServiceStatus> getServiceStatus() {
        return serviceRegistry.entrySet().stream()
            .collect(Collectors.toMap(
                Map.Entry::getKey,
                entry -> entry.getValue().checkHealth()
            ));
    }
}

interface ServiceEndpoint {
    Object invoke(String operation, String request) throws Exception;
    ServiceStatus checkHealth();
}

record ServiceStatus(String name, boolean healthy, long responseTime) {}
```

### 6. Orquestra√ß√£o de Servi√ßos (Saga Pattern com SOA)

```java
// Orquestrador que coordena m√∫ltiplos servi√ßos SOA

@Service
public class PedidoOrchestrator {

    private final ClienteService clienteService;
    private final EstoqueService estoqueService;
    private final PagamentoService pagamentoService;
    private final NotaFiscalService notaFiscalService;

    @Transactional
    public PedidoDTO criarPedidoCompleto(CriarPedidoRequest request) {
        System.out.println("üé≠ [Orchestrator] Iniciando cria√ß√£o de pedido");

        String reservaId = null;
        String pagamentoId = null;

        try {
            // 1. Validar cliente
            System.out.println("1Ô∏è‚É£ Validando cliente...");
            ClienteDTO cliente = clienteService.buscarCliente(request.clienteId());

            // 2. Calcular desconto
            System.out.println("2Ô∏è‚É£ Calculando desconto...");
            BigDecimal desconto = clienteService.calcularDesconto(
                request.clienteId(),
                request.valorTotal()
            );

            // 3. Reservar estoque
            System.out.println("3Ô∏è‚É£ Reservando estoque...");
            ReservaResponse reserva = estoqueService.reservarEstoque(
                new ReservaRequest(request.itens())
            );
            reservaId = reserva.reservaId();

            // 4. Processar pagamento
            System.out.println("4Ô∏è‚É£ Processando pagamento...");
            BigDecimal valorFinal = request.valorTotal().subtract(desconto);
            PagamentoResultado pagamento = pagamentoService.processarPagamento(
                new PagamentoRequest(valorFinal, request.cartao())
            );
            pagamentoId = pagamento.transacaoId();

            // 5. Emitir nota fiscal
            System.out.println("5Ô∏è‚É£ Emitindo nota fiscal...");
            NotaFiscalDTO notaFiscal = notaFiscalService.emitir(
                new EmitirNotaRequest(cliente.id(), request.itens(), valorFinal)
            );

            System.out.println("‚úÖ [Orchestrator] Pedido criado com sucesso!");

            return new PedidoDTO(
                UUID.randomUUID().toString(),
                cliente,
                request.itens(),
                valorFinal,
                StatusPedido.APROVADO
            );

        } catch (Exception e) {
            System.err.println("‚ùå [Orchestrator] Erro: " + e.getMessage());

            // Compensa√ß√£o (rollback distribu√≠do)
            compensar(reservaId, pagamentoId);

            throw new PedidoCriacaoException("Falha ao criar pedido", e);
        }
    }

    private void compensar(String reservaId, String pagamentoId) {
        System.out.println("üîÑ [Orchestrator] Iniciando compensa√ß√£o...");

        if (pagamentoId != null) {
            try {
                pagamentoService.estornar(pagamentoId);
                System.out.println("‚Ü©Ô∏è Pagamento estornado");
            } catch (Exception e) {
                System.err.println("‚ö†Ô∏è Falha ao estornar pagamento: " + e.getMessage());
            }
        }

        if (reservaId != null) {
            try {
                estoqueService.liberarReserva(reservaId);
                System.out.println("‚Ü©Ô∏è Estoque liberado");
            } catch (Exception e) {
                System.err.println("‚ö†Ô∏è Falha ao liberar estoque: " + e.getMessage());
            }
        }
    }
}
```

---

## üß™ Como Testar

### 1. Teste de Contrato (Contract Testing)

```java
@SpringBootTest
class ClienteServiceContractTest {

    @Autowired
    private ClienteService clienteService;

    @Test
    void contratoDeveRetornarClienteDTO() throws Exception {
        // Arrange
        Long clienteId = 1L;

        // Act
        ClienteDTO resultado = clienteService.buscarCliente(clienteId);

        // Assert - verifica contrato
        assertNotNull(resultado);
        assertNotNull(resultado.id());
        assertNotNull(resultado.nome());
        assertNotNull(resultado.email());
        assertNotNull(resultado.tipo());
    }

    @Test
    void contratoDeveLancarExcecaoParaClienteInexistente() {
        // Assert
        assertThrows(ClienteNaoEncontradoException.class, () -> {
            clienteService.buscarCliente(999L);
        });
    }
}
```

### 2. Teste de Integra√ß√£o SOAP

```java
@SpringBootTest(webEnvironment = WebEnvironment.DEFINED_PORT)
class ClienteServiceSoapIntegrationTest {

    private ClienteService clienteProxy;

    @BeforeEach
    void setUp() throws Exception {
        URL wsdlURL = new URL("http://localhost:8080/services/cliente?wsdl");
        QName qname = new QName("http://example.com/cliente", "ClienteService");

        Service service = Service.create(wsdlURL, qname);
        clienteProxy = service.getPort(ClienteService.class);
    }

    @Test
    void deveConsumirServicoSoapComSucesso() throws Exception {
        // Act
        ClienteDTO cliente = clienteProxy.buscarCliente(1L);

        // Assert
        assertNotNull(cliente);
        assertEquals(1L, cliente.id());
    }
}
```

### 3. Teste de Orquestra√ß√£o

```java
@SpringBootTest
class PedidoOrchestratorTest {

    @MockBean
    private ClienteService clienteService;

    @MockBean
    private EstoqueService estoqueService;

    @MockBean
    private PagamentoService pagamentoService;

    @Autowired
    private PedidoOrchestrator orchestrator;

    @Test
    void deveCriarPedidoOrquestrandoServicos() {
        // Arrange
        when(clienteService.buscarCliente(1L))
            .thenReturn(new ClienteDTO(1L, "Jo√£o", "joao@test.com", TipoCliente.VIP));

        when(clienteService.calcularDesconto(any(), any()))
            .thenReturn(new BigDecimal("10.00"));

        when(estoqueService.reservarEstoque(any()))
            .thenReturn(new ReservaResponse("R123", List.of(), LocalDateTime.now()));

        when(pagamentoService.processarPagamento(any()))
            .thenReturn(new PagamentoResultado("P123", true));

        // Act
        PedidoDTO pedido = orchestrator.criarPedidoCompleto(criarRequest());

        // Assert
        assertNotNull(pedido);
        assertEquals(StatusPedido.APROVADO, pedido.status());

        // Verifica orquestra√ß√£o
        verify(clienteService).buscarCliente(1L);
        verify(estoqueService).reservarEstoque(any());
        verify(pagamentoService).processarPagamento(any());
    }
}
```

---

## üìä Boas Pr√°ticas

- ‚úÖ **Contratos expl√≠citos**: WSDL ou OpenAPI
- ‚úÖ **Versionamento**: /api/v1, /api/v2
- ‚úÖ **Servi√ßos coesos**: Uma responsabilidade clara
- ‚úÖ **Idempot√™ncia**: Opera√ß√µes seguras para retry
- ‚úÖ **Timeout**: Evitar bloqueios longos
- ‚úÖ **Circuit Breaker**: Prote√ß√£o contra falhas
- ‚úÖ **Service Registry**: Descoberta din√¢mica de servi√ßos

---

## üîó Compara√ß√£o com Outras Arquiteturas

| Caracter√≠stica    | SOA             | Microservices     | Monolith   |
| ----------------- | --------------- | ----------------- | ---------- |
| **Granularidade** | Servi√ßos m√©dios | Servi√ßos pequenos | √önico      |
| **Comunica√ß√£o**   | ESB/SOAP/REST   | REST/gRPC/Msg     | In-process |
| **Reutiliza√ß√£o**  | Alta            | M√©dia             | Baixa      |
| **Complexidade**  | Alta            | Muito Alta        | Baixa      |
| **Governan√ßa**    | Centralizada    | Descentralizada   | N/A        |
| **Deploy**        | Independente    | Independente      | √önico      |

---

## ‚úÖ Vantagens vs ‚ö†Ô∏è Desvantagens

| ‚úÖ Vantagens                   | ‚ö†Ô∏è Desvantagens                 |
| ------------------------------ | ------------------------------- |
| Reutiliza√ß√£o de servi√ßos       | ESB pode ser gargalo            |
| Contratos expl√≠citos (WSDL)    | Complexidade operacional        |
| Interoperabilidade (.NET/Java) | Performance (overhead XML/SOAP) |
| Governan√ßa centralizada        | Acoplamento via ESB             |
| Testabilidade de contratos     | Curva de aprendizado            |

---

## üîç Quando Usar vs N√£o Usar

### ‚úÖ Use SOA quando:

- Empresa com m√∫ltiplas aplica√ß√µes
- Necessidade de reutilizar servi√ßos
- Integra√ß√£o entre tecnologias (.NET + Java)
- Governan√ßa centralizada obrigat√≥ria

### ‚ùå Evite SOA quando:

- Aplica√ß√£o √∫nica/simples
- Performance cr√≠tica (lat√™ncia)
- Time pequeno sem experi√™ncia
- Infraestrutura limitada

---

**SOA organiza aplica√ß√£o como servi√ßos reutiliz√°veis com contratos, permitindo interoperabilidade e testes de contrato!** üè¢‚ú®
