# üìà M√≥dulo 13.3: Thresholds Din√¢micos

> **Objetivo:** Implementar detec√ß√£o de anomalias, baselines adaptativos e sazonalidade.

---

## üìë √çndice

1. [Baselines Adaptativos](#1-baselines-adaptativos)
2. [Anomaly Detection](#2-anomaly-detection)
3. [Percentiles e Outliers](#3-percentiles-e-outliers)
4. [Seasonality](#4-seasonality)
5. [Machine Learning](#5-machine-learning)

---

## 1. Baselines Adaptativos

### 1.1 Problema com Thresholds Fixos

```java
/**
 * THRESHOLD FIXO: Problema
 *
 * alert: HighLatency
 * expr: p99_latency > 500ms
 *
 * Problemas:
 * - Hora de pico: Normal ter 500ms, alerta falso positivo
 * - Madrugada: 200ms j√° √© anormal, mas n√£o alerta
 * - Black Friday: Threshold inadequado
 *
 * SOLU√á√ÉO: Threshold din√¢mico baseado em baseline hist√≥rico
 */

/**
 * BASELINE: Comportamento normal (m√©dia hist√≥rica)
 */
@Service
public class BaselineService {

    @Autowired
    private PrometheusClient prometheus;

    /**
     * Calcular baseline (m√©dia dos √∫ltimos 7 dias, mesma hora)
     */
    public double calculateBaseline(String metric, int daysBack) {
        var query = String.format(
            "avg_over_time(%s[%dd:1h])",  // M√©dia de 7 dias, hora a hora
            metric,
            daysBack
        );

        return prometheus.query(query).asDouble();
    }

    /**
     * Threshold din√¢mico: baseline + N * stddev
     */
    public double calculateDynamicThreshold(String metric, int daysBack, double multiplier) {
        var baseline = calculateBaseline(metric, daysBack);
        var stddev = calculateStdDev(metric, daysBack);

        return baseline + (multiplier * stddev);
    }

    private double calculateStdDev(String metric, int daysBack) {
        var query = String.format(
            "stddev_over_time(%s[%dd:1h])",
            metric,
            daysBack
        );

        return prometheus.query(query).asDouble();
    }
}
```

---

### 1.2 PromQL com Baseline

```yaml
# alert-rules-dynamic.yml

groups:
  - name: dynamic_thresholds
    interval: 1m
    rules:
      # Baseline: Lat√™ncia p99 m√©dia dos √∫ltimos 7 dias
      - record: baseline:latency_p99:7d
        expr: |
          avg_over_time(
            histogram_quantile(0.99, 
              rate(http_server_requests_seconds_bucket[5m])
            )[7d:1h]
          )

      # Stddev: Desvio padr√£o dos √∫ltimos 7 dias
      - record: baseline:latency_p99:stddev
        expr: |
          stddev_over_time(
            histogram_quantile(0.99, 
              rate(http_server_requests_seconds_bucket[5m])
            )[7d:1h]
          )

      # Threshold din√¢mico: baseline + 3 * stddev (99.7% confian√ßa)
      - record: threshold:latency_p99:dynamic
        expr: |
          baseline:latency_p99:7d + (3 * baseline:latency_p99:stddev)

      # Alert: Lat√™ncia atual > threshold din√¢mico
      - alert: HighLatencyDynamic
        expr: |
          histogram_quantile(0.99, 
            rate(http_server_requests_seconds_bucket[5m])
          ) > threshold:latency_p99:dynamic
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Latency p99 above dynamic threshold"
          description: |
            Current: {{ $value }}s
            Baseline: {{ $labels.baseline }}s
            Threshold: {{ $labels.threshold }}s
            (Baseline + 3œÉ)
```

---

## 2. Anomaly Detection

### 2.1 Z-Score (Desvio da M√©dia)

```yaml
# alert-rules-zscore.yml

groups:
  - name: anomaly_detection
    interval: 1m
    rules:
      # M√©dia m√≥vel (√∫ltimas 24h)
      - record: moving_avg:http_requests:24h
        expr: |
          avg_over_time(
            rate(http_requests_total[5m])[24h:5m]
          )

      # Desvio padr√£o (√∫ltimas 24h)
      - record: moving_stddev:http_requests:24h
        expr: |
          stddev_over_time(
            rate(http_requests_total[5m])[24h:5m]
          )

      # Z-Score: (current - mean) / stddev
      - record: zscore:http_requests
        expr: |
          (
            rate(http_requests_total[5m])
            -
            moving_avg:http_requests:24h
          )
          /
          moving_stddev:http_requests:24h

      # Alert: Z-Score > 3 (anomalia forte, 99.7% confian√ßa)
      - alert: TrafficAnomaly
        expr: |
          abs(zscore:http_requests) > 3
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Traffic anomaly detected (Z-Score > 3)"
          description: |
            Z-Score: {{ $value }}
            Current RPS: {{ $labels.current }}
            Expected RPS: {{ $labels.baseline }}
            (Anomaly: {{ if gt $value 0 }}spike{{ else }}drop{{ end }})
```

---

### 2.2 Rate of Change (ROC)

```yaml
# alert-rules-roc.yml

groups:
  - name: rate_of_change
    interval: 1m
    rules:
      # Taxa de mudan√ßa: % change nos √∫ltimos 5min
      - record: roc:http_requests:5m
        expr: |
          (
            rate(http_requests_total[5m])
            -
            rate(http_requests_total[5m] offset 5m)
          )
          /
          rate(http_requests_total[5m] offset 5m)
          * 100

      # Alert: Mudan√ßa > 50% em 5min (spike ou drop s√∫bito)
      - alert: SuddenTrafficChange
        expr: |
          abs(roc:http_requests:5m) > 50
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Sudden traffic change (>50% in 5min)"
          description: |
            Rate of change: {{ $value }}%
            Direction: {{ if gt $value 0 }}‚¨ÜÔ∏è spike{{ else }}‚¨áÔ∏è drop{{ end }}
```

---

## 3. Percentiles e Outliers

### 3.1 Detec√ß√£o de Outliers

```yaml
# alert-rules-outliers.yml

groups:
  - name: outlier_detection
    interval: 1m
    rules:
      # Percentil 95 (√∫ltimos 7 dias)
      - record: p95:latency:7d
        expr: |
          quantile_over_time(0.95,
            histogram_quantile(0.99, 
              rate(http_server_requests_seconds_bucket[5m])
            )[7d:1h]
          )

      # Percentil 5 (√∫ltimos 7 dias)
      - record: p5:latency:7d
        expr: |
          quantile_over_time(0.05,
            histogram_quantile(0.99, 
              rate(http_server_requests_seconds_bucket[5m])
            )[7d:1h]
          )

      # IQR (Interquartile Range): p95 - p5
      - record: iqr:latency:7d
        expr: |
          p95:latency:7d - p5:latency:7d

      # Upper fence: p95 + 1.5 * IQR
      - record: upper_fence:latency
        expr: |
          p95:latency:7d + (1.5 * iqr:latency:7d)

      # Alert: Lat√™ncia atual > upper fence (outlier)
      - alert: LatencyOutlier
        expr: |
          histogram_quantile(0.99, 
            rate(http_server_requests_seconds_bucket[5m])
          ) > upper_fence:latency
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Latency outlier detected"
          description: |
            Current: {{ $value }}s
            Upper fence: {{ $labels.upper_fence }}s
            (P95 + 1.5 * IQR)
```

---

## 4. Seasonality

### 4.1 Weekly Patterns

```java
/**
 * SAZONALIDADE: Padr√µes que se repetem
 *
 * Exemplos:
 * - Dia da semana: Segunda-feira tem mais tr√°fego
 * - Hora do dia: 10h-12h pico, 3h-5h low
 * - Mensal: Fim do m√™s (folha de pagamento)
 * - Anual: Black Friday, Natal
 */

@Service
public class SeasonalityService {

    @Autowired
    private PrometheusClient prometheus;

    /**
     * Baseline sazonal: M√©dia do mesmo dia/hora das √∫ltimas semanas
     */
    public double calculateSeasonalBaseline(String metric, DayOfWeek dayOfWeek, int hour) {
        // Query: M√©dia das segundas-feiras √†s 10h (√∫ltimas 4 semanas)
        var query = String.format(
            "avg_over_time(%s[4w:1h] @ dayofweek() == %d and hour() == %d)",
            metric,
            dayOfWeek.getValue(),
            hour
        );

        return prometheus.query(query).asDouble();
    }
}
```

```yaml
# alert-rules-seasonal.yml

groups:
  - name: seasonal_thresholds
    interval: 1m
    rules:
      # Baseline: M√©dia do mesmo dia/hora (√∫ltimas 4 semanas)
      - record: seasonal_baseline:http_requests
        expr: |
          avg_over_time(
            rate(http_requests_total[5m])[4w:1h]
            @ (day_of_week() == day_of_week(vector(time())) 
               and hour() == hour(vector(time())))
          )

      # Threshold sazonal: baseline * 1.5 (50% acima do normal)
      - record: seasonal_threshold:http_requests
        expr: |
          seasonal_baseline:http_requests * 1.5

      # Alert: Tr√°fego > threshold sazonal
      - alert: TrafficAboveSeasonalNormal
        expr: |
          rate(http_requests_total[5m]) > seasonal_threshold:http_requests
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Traffic 50% above seasonal baseline"
          description: |
            Current: {{ $value }} RPS
            Baseline (same day/hour): {{ $labels.baseline }} RPS
            Threshold: {{ $labels.threshold }} RPS
```

---

### 4.2 Holiday Calendar

```java
/**
 * Calendar-aware thresholds
 */
@Service
public class HolidayAwareThresholdService {

    private static final Set<LocalDate> HOLIDAYS = Set.of(
        LocalDate.of(2025, 1, 1),   // Ano Novo
        LocalDate.of(2025, 11, 28),  // Black Friday
        LocalDate.of(2025, 12, 25)   // Natal
    );

    /**
     * Ajustar threshold baseado em calend√°rio
     */
    public double getAdjustedThreshold(double baseThreshold, LocalDate date) {
        if (HOLIDAYS.contains(date)) {
            return baseThreshold * 3.0;  // 3x threshold em feriados
        }

        var dayOfWeek = date.getDayOfWeek();
        if (dayOfWeek == DayOfWeek.SATURDAY || dayOfWeek == DayOfWeek.SUNDAY) {
            return baseThreshold * 0.5;  // 50% threshold em finais de semana
        }

        return baseThreshold;
    }
}
```

---

## 5. Machine Learning

### 5.1 Prophet (Facebook)

```python
# anomaly_detection.py

from fbprophet import Prophet
import pandas as pd

def train_prophet_model(historical_data):
    """
    Train Prophet model para prever lat√™ncia

    historical_data: DataFrame com colunas 'ds' (timestamp) e 'y' (latency)
    """
    model = Prophet(
        changepoint_prior_scale=0.05,  # Sensibilidade a mudan√ßas
        interval_width=0.95             # Intervalo de confian√ßa 95%
    )

    model.fit(historical_data)
    return model

def detect_anomalies(model, current_data):
    """
    Detectar anomalias: Valores fora do intervalo de confian√ßa
    """
    forecast = model.predict(current_data)

    anomalies = current_data[
        (current_data['y'] < forecast['yhat_lower']) |
        (current_data['y'] > forecast['yhat_upper'])
    ]

    return anomalies

# Uso
historical = pd.read_csv('latency_7d.csv')
model = train_prophet_model(historical)

current = pd.read_csv('latency_current.csv')
anomalies = detect_anomalies(model, current)

if not anomalies.empty:
    print(f"‚ö†Ô∏è {len(anomalies)} anomalies detected!")
    # Trigger alert
```

---

### 5.2 ARIMA (Time Series)

```python
# arima_forecast.py

from statsmodels.tsa.arima.model import ARIMA
import pandas as pd

def forecast_with_arima(timeseries, periods=12):
    """
    Forecast pr√≥ximas horas com ARIMA

    timeseries: S√©rie temporal (lat√™ncia por hora)
    periods: Quantos per√≠odos prever (12 = 12h)
    """
    model = ARIMA(
        timeseries,
        order=(1, 1, 1)  # (p, d, q) - auto-tuning recomendado
    )

    fitted = model.fit()
    forecast = fitted.forecast(steps=periods)

    return forecast

# Uso
latency_hourly = pd.read_csv('latency_hourly.csv', index_col='timestamp')
forecast = forecast_with_arima(latency_hourly['p99'], periods=12)

print(f"Pr√≥ximas 12h forecast: {forecast}")

# Dynamic threshold: max(forecast) + 2œÉ
threshold = forecast.max() + (2 * forecast.std())
print(f"Dynamic threshold: {threshold}ms")
```

---

### 5.3 Isolation Forest (Scikit-learn)

```python
# isolation_forest.py

from sklearn.ensemble import IsolationForest
import pandas as pd

def detect_anomalies_ml(metrics_df):
    """
    Anomaly detection com Isolation Forest

    metrics_df: DataFrame com features (latency, rps, error_rate, cpu)
    """
    features = metrics_df[['latency_p99', 'rps', 'error_rate', 'cpu_usage']]

    model = IsolationForest(
        contamination=0.01,  # 1% dos dados s√£o anomalias
        random_state=42
    )

    model.fit(features)

    # Predict: -1 = anomalia, 1 = normal
    predictions = model.predict(features)

    anomalies = metrics_df[predictions == -1]

    return anomalies

# Uso
metrics = pd.read_csv('metrics_24h.csv')
anomalies = detect_anomalies_ml(metrics)

if not anomalies.empty:
    print(f"‚ö†Ô∏è {len(anomalies)} anomalies detected!")
    print(anomalies[['timestamp', 'latency_p99', 'rps']])
```

---

### 5.4 Integration com Prometheus

```java
/**
 * Exportar m√©tricas do Prometheus para ML pipeline
 */
@Service
public class MetricsExportService {

    @Autowired
    private PrometheusClient prometheus;

    @Scheduled(cron = "0 0 * * * *")  // A cada hora
    public void exportMetricsForML() {
        var query = """
            {
              latency_p99: histogram_quantile(0.99, rate(http_requests_seconds_bucket[1h])),
              rps: rate(http_requests_total[1h]),
              error_rate: rate(http_requests_total{status=~"5.."}[1h]) / rate(http_requests_total[1h]),
              cpu_usage: system_cpu_usage
            }
            """;

        var metrics = prometheus.queryRange(query, Duration.ofDays(7));

        // Salvar em CSV para pipeline ML
        saveToCsv(metrics, "metrics_7d.csv");
    }
}

/**
 * Importar thresholds do ML pipeline
 */
@Service
public class MLThresholdService {

    /**
     * Ler threshold calculado pelo modelo ML
     */
    public double getDynamicThreshold(String metric) {
        var file = new File("ml_thresholds/" + metric + ".json");
        var json = readJson(file);

        return json.getDouble("threshold");
    }
}
```

---

## üìä Checklist de Qualidade

- [ ] Baselines calculados com m√©dia hist√≥rica (7d ou 30d)
- [ ] Thresholds din√¢micos (baseline + N \* stddev)
- [ ] Z-Score para detec√ß√£o de anomalias (> 3œÉ)
- [ ] Rate of change para detectar mudan√ßas s√∫bitas (> 50%)
- [ ] Outliers detectados com IQR (P95 + 1.5 \* IQR)
- [ ] Sazonalidade considerada (dia/hora da semana)
- [ ] Calendar-aware (feriados, Black Friday)
- [ ] ML pipeline opcional (Prophet/ARIMA/Isolation Forest)
- [ ] Alertas comparando valor atual vs baseline din√¢mico
- [ ] Dashboard mostrando baseline + threshold + valor atual

---

## üéØ Exerc√≠cios Pr√°ticos

1. **B√°sico**: Calcular baseline adaptativo (m√©dia 7d + 2œÉ)
2. **Intermedi√°rio**: Implementar Z-Score anomaly detection
3. **Avan√ßado**: Integrar Prophet para forecasting e alertas

---

## üìö Refer√™ncias

- [Prometheus Query Examples](https://prometheus.io/docs/prometheus/latest/querying/examples/)
- [Facebook Prophet](https://facebook.github.io/prophet/)
- [ARIMA Time Series](https://www.statsmodels.org/stable/generated/statsmodels.tsa.arima.model.ARIMA.html)
- [Isolation Forest](https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.IsolationForest.html)

---

**Anterior:** [13.2 - Prometheus Alerting](13.2-prometheus-alerting.md)  
**Pr√≥ximo:** [13.4 - Alert Fatigue](13.4-alert-fatigue.md)
