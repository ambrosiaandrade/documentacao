# 03.4 Testes de LDAP [AVAN√áADO] üîê

## üéØ Objetivo

Testar **autentica√ß√£o LDAP**, **autoriza√ß√£o baseada em grupos**, **sincroniza√ß√£o de usu√°rios** e **integra√ß√£o Spring Security LDAP** usando **Embedded LDAP Server** e **Testcontainers**.

---

## üìö O Que √© LDAP?

**LDAP (Lightweight Directory Access Protocol)** √© um protocolo para acessar **diret√≥rios centralizados** de usu√°rios, grupos e permiss√µes, comum em ambientes corporativos.

### Por Que Testar LDAP?

```java
// ‚ùå SEM testes LDAP
// - Autentica√ß√£o pode falhar em produ√ß√£o
// - Grupos/permiss√µes incorretos
// - Integra√ß√£o quebrada sem perceber

// ‚úÖ COM testes LDAP
// - Valida autentica√ß√£o de usu√°rios
// - Valida mapeamento de grupos ‚Üí roles
// - Testa queries LDAP (busca, filtros)
```

---

## üèóÔ∏è Configura√ß√£o

### pom.xml

```xml
<dependencies>
    <!-- Spring Security LDAP -->
    <dependency>
        <groupId>org.springframework.security</groupId>
        <artifactId>spring-security-ldap</artifactId>
    </dependency>

    <!-- Unboundid LDAP SDK (Embedded LDAP) -->
    <dependency>
        <groupId>com.unboundid</groupId>
        <artifactId>unboundid-ldapsdk</artifactId>
        <scope>test</scope>
    </dependency>

    <!-- Spring LDAP Core -->
    <dependency>
        <groupId>org.springframework.ldap</groupId>
        <artifactId>spring-ldap-core</artifactId>
    </dependency>

    <!-- Spring LDAP Test -->
    <dependency>
        <groupId>org.springframework.ldap</groupId>
        <artifactId>spring-ldap-test</artifactId>
        <scope>test</scope>
    </dependency>

    <!-- Testcontainers OpenLDAP -->
    <dependency>
        <groupId>org.testcontainers</groupId>
        <artifactId>testcontainers</artifactId>
        <version>1.19.3</version>
        <scope>test</scope>
    </dependency>
</dependencies>
```

---

## üîß Spring Security LDAP Config

### Configura√ß√£o Produ√ß√£o

```java
@Configuration
@EnableWebSecurity
public class LdapSecurityConfig {

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/api/public/**").permitAll()
                .requestMatchers("/api/admin/**").hasRole("ADMIN")
                .requestMatchers("/api/manager/**").hasAnyRole("ADMIN", "MANAGER")
                .anyRequest().authenticated()
            )
            .formLogin(Customizer.withDefaults())
            .httpBasic(Customizer.withDefaults());

        return http.build();
    }

    @Bean
    public LdapAuthoritiesPopulator ldapAuthoritiesPopulator(BaseLdapPathContextSource contextSource) {
        DefaultLdapAuthoritiesPopulator populator = new DefaultLdapAuthoritiesPopulator(
            contextSource,
            "ou=groups"
        );
        populator.setGroupRoleAttribute("cn");
        populator.setGroupSearchFilter("(member={0})");
        return populator;
    }
}
```

### application.properties

```properties
# LDAP Configuration
spring.ldap.urls=ldap://localhost:10389
spring.ldap.base=dc=empresa,dc=com
spring.ldap.username=cn=admin,dc=empresa,dc=com
spring.ldap.password=admin

# LDAP Authentication
spring.security.ldap.user-dn-pattern=uid={0},ou=users
spring.security.ldap.group-search-base=ou=groups
spring.security.ldap.group-search-filter=(member={0})
```

---

## üß™ Embedded LDAP Server

### Configura√ß√£o Base de Teste

```java
@SpringBootTest
@DirtiesContext(classMode = DirtiesContext.ClassMode.AFTER_CLASS)
public abstract class AbstractLdapTest {

    private static InMemoryDirectoryServer ldapServer;

    @BeforeAll
    static void startLdapServer() throws Exception {
        // Configura√ß√£o do servidor LDAP em mem√≥ria
        InMemoryDirectoryServerConfig config = new InMemoryDirectoryServerConfig("dc=empresa,dc=com");
        config.addAdditionalBindCredentials("cn=admin,dc=empresa,dc=com", "admin");

        ldapServer = new InMemoryDirectoryServer(config);

        // Carrega dados iniciais (LDIF)
        ldapServer.importFromLDIF(true, "src/test/resources/test-data.ldif");

        ldapServer.startListening();

        System.setProperty("spring.ldap.urls", "ldap://localhost:" + ldapServer.getListenPort());
    }

    @AfterAll
    static void stopLdapServer() {
        if (ldapServer != null) {
            ldapServer.shutDown(true);
        }
    }
}
```

### test-data.ldif

```ldif
# Base DN
dn: dc=empresa,dc=com
objectClass: top
objectClass: domain
dc: empresa

# Organizational Unit: Users
dn: ou=users,dc=empresa,dc=com
objectClass: organizationalUnit
ou: users

# Organizational Unit: Groups
dn: ou=groups,dc=empresa,dc=com
objectClass: organizationalUnit
ou: groups

# User: Jo√£o (Admin)
dn: uid=joao,ou=users,dc=empresa,dc=com
objectClass: inetOrgPerson
objectClass: person
objectClass: top
cn: Jo√£o Silva
sn: Silva
uid: joao
userPassword: senha123
mail: joao@empresa.com

# User: Maria (Manager)
dn: uid=maria,ou=users,dc=empresa,dc=com
objectClass: inetOrgPerson
objectClass: person
objectClass: top
cn: Maria Santos
sn: Santos
uid: maria
userPassword: senha456
mail: maria@empresa.com

# User: Pedro (User)
dn: uid=pedro,ou=users,dc=empresa,dc=com
objectClass: inetOrgPerson
objectClass: person
objectClass: top
cn: Pedro Costa
sn: Costa
uid: pedro
userPassword: senha789
mail: pedro@empresa.com

# Group: Admins
dn: cn=admins,ou=groups,dc=empresa,dc=com
objectClass: groupOfNames
cn: admins
member: uid=joao,ou=users,dc=empresa,dc=com

# Group: Managers
dn: cn=managers,ou=groups,dc=empresa,dc=com
objectClass: groupOfNames
cn: managers
member: uid=maria,ou=users,dc=empresa,dc=com

# Group: Users
dn: cn=users,ou=groups,dc=empresa,dc=com
objectClass: groupOfNames
cn: users
member: uid=pedro,ou=users,dc=empresa,dc=com
member: uid=maria,ou=users,dc=empresa,dc=com
```

---

## üîê Testando Autentica√ß√£o LDAP

### Teste de Login B√°sico

```java
@SpringBootTest
@AutoConfigureMockMvc
class LdapAuthenticationTest extends AbstractLdapTest {

    @Autowired
    private MockMvc mockMvc;

    @Test
    @DisplayName("Deve autenticar usu√°rio com credenciais LDAP v√°lidas")
    void deveAutenticarComCredenciaisValidas() throws Exception {
        mockMvc.perform(get("/api/perfil")
                .with(httpBasic("joao", "senha123")))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.username").value("joao"))
                .andExpect(jsonPath("$.authorities[*].authority",
                    hasItem("ROLE_ADMINS")));
    }

    @Test
    @DisplayName("Deve rejeitar credenciais LDAP inv√°lidas")
    void deveRejeitarCredenciaisInvalidas() throws Exception {
        mockMvc.perform(get("/api/perfil")
                .with(httpBasic("joao", "senha_errada")))
                .andExpect(status().isUnauthorized());
    }

    @Test
    @DisplayName("Deve rejeitar usu√°rio inexistente")
    void deveRejeitarUsuarioInexistente() throws Exception {
        mockMvc.perform(get("/api/perfil")
                .with(httpBasic("usuario_inexistente", "senha123")))
                .andExpect(status().isUnauthorized());
    }
}
```

---

## üë• Testando Grupos e Roles

### Autoriza√ß√£o Baseada em Grupos

```java
@SpringBootTest
@AutoConfigureMockMvc
class LdapAuthorizationTest extends AbstractLdapTest {

    @Autowired
    private MockMvc mockMvc;

    @Test
    @DisplayName("Admin deve acessar endpoints administrativos")
    void adminDeveAcessarEndpointsAdministrativos() throws Exception {
        mockMvc.perform(get("/api/admin/usuarios")
                .with(httpBasic("joao", "senha123")))
                .andExpect(status().isOk());
    }

    @Test
    @DisplayName("Manager deve acessar endpoints de ger√™ncia")
    void managerDeveAcessarEndpointsGerencia() throws Exception {
        mockMvc.perform(get("/api/manager/relatorios")
                .with(httpBasic("maria", "senha456")))
                .andExpect(status().isOk());
    }

    @Test
    @DisplayName("User comum n√£o deve acessar endpoints admin")
    void userComumNaoDeveAcessarEndpointsAdmin() throws Exception {
        mockMvc.perform(get("/api/admin/usuarios")
                .with(httpBasic("pedro", "senha789")))
                .andExpect(status().isForbidden());
    }

    @Test
    @DisplayName("Deve mapear grupos LDAP para roles Spring Security")
    void deveMapearGruposParaRoles() throws Exception {
        MvcResult result = mockMvc.perform(get("/api/perfil")
                .with(httpBasic("joao", "senha123")))
                .andExpect(status().isOk())
                .andReturn();

        String json = result.getResponse().getContentAsString();

        // Valida que grupo "admins" foi mapeado para "ROLE_ADMINS"
        assertTrue(json.contains("ROLE_ADMINS"));
    }

    @Test
    @DisplayName("Usu√°rio com m√∫ltiplos grupos deve ter m√∫ltiplas roles")
    void usuarioComMultiplosGruposDeveTerMultiplasRoles() throws Exception {
        // Maria est√° em "managers" e "users"
        MvcResult result = mockMvc.perform(get("/api/perfil")
                .with(httpBasic("maria", "senha456")))
                .andExpect(status().isOk())
                .andReturn();

        String json = result.getResponse().getContentAsString();

        assertTrue(json.contains("ROLE_MANAGERS"));
        assertTrue(json.contains("ROLE_USERS"));
    }
}
```

---

## üîç Testando Queries LDAP

### LdapTemplate Service

```java
@Service
@RequiredArgsConstructor
public class UsuarioLdapService {

    private final LdapTemplate ldapTemplate;

    public List<UsuarioDTO> buscarTodos() {
        return ldapTemplate.search(
            "ou=users",
            "(objectClass=inetOrgPerson)",
            new UsuarioAttributesMapper()
        );
    }

    public Optional<UsuarioDTO> buscarPorUid(String uid) {
        try {
            UsuarioDTO usuario = ldapTemplate.searchForObject(
                "ou=users",
                String.format("(uid=%s)", uid),
                new UsuarioAttributesMapper()
            );
            return Optional.of(usuario);
        } catch (EmptyResultDataAccessException e) {
            return Optional.empty();
        }
    }

    public List<UsuarioDTO> buscarPorEmail(String email) {
        return ldapTemplate.search(
            "ou=users",
            String.format("(mail=%s)", email),
            new UsuarioAttributesMapper()
        );
    }

    public List<String> buscarGruposDoUsuario(String uid) {
        String userDn = String.format("uid=%s,ou=users,dc=empresa,dc=com", uid);

        return ldapTemplate.search(
            "ou=groups",
            String.format("(member=%s)", userDn),
            (Attributes attrs) -> (String) attrs.get("cn").get()
        );
    }

    private static class UsuarioAttributesMapper implements AttributesMapper<UsuarioDTO> {
        @Override
        public UsuarioDTO mapFromAttributes(Attributes attrs) throws NamingException {
            return new UsuarioDTO(
                (String) attrs.get("uid").get(),
                (String) attrs.get("cn").get(),
                (String) attrs.get("mail").get()
            );
        }
    }
}
```

### Testando Queries

```java
@SpringBootTest
class UsuarioLdapServiceTest extends AbstractLdapTest {

    @Autowired
    private UsuarioLdapService usuarioLdapService;

    @Test
    @DisplayName("Deve buscar todos os usu√°rios do LDAP")
    void deveBuscarTodosUsuarios() {
        // When
        List<UsuarioDTO> usuarios = usuarioLdapService.buscarTodos();

        // Then
        assertEquals(3, usuarios.size());

        List<String> uids = usuarios.stream()
            .map(UsuarioDTO::getUid)
            .collect(Collectors.toList());

        assertTrue(uids.containsAll(List.of("joao", "maria", "pedro")));
    }

    @Test
    @DisplayName("Deve buscar usu√°rio por UID")
    void deveBuscarUsuarioPorUid() {
        // When
        Optional<UsuarioDTO> usuario = usuarioLdapService.buscarPorUid("joao");

        // Then
        assertTrue(usuario.isPresent());
        assertEquals("joao", usuario.get().getUid());
        assertEquals("Jo√£o Silva", usuario.get().getNome());
        assertEquals("joao@empresa.com", usuario.get().getEmail());
    }

    @Test
    @DisplayName("Deve retornar empty quando usu√°rio n√£o existe")
    void deveRetornarEmptyQuandoUsuarioNaoExiste() {
        // When
        Optional<UsuarioDTO> usuario = usuarioLdapService.buscarPorUid("inexistente");

        // Then
        assertFalse(usuario.isPresent());
    }

    @Test
    @DisplayName("Deve buscar usu√°rio por email")
    void deveBuscarUsuarioPorEmail() {
        // When
        List<UsuarioDTO> usuarios = usuarioLdapService.buscarPorEmail("maria@empresa.com");

        // Then
        assertEquals(1, usuarios.size());
        assertEquals("maria", usuarios.get(0).getUid());
    }

    @Test
    @DisplayName("Deve buscar grupos do usu√°rio")
    void deveBuscarGruposDoUsuario() {
        // When
        List<String> grupos = usuarioLdapService.buscarGruposDoUsuario("joao");

        // Then
        assertEquals(1, grupos.size());
        assertTrue(grupos.contains("admins"));
    }

    @Test
    @DisplayName("Deve buscar m√∫ltiplos grupos do usu√°rio")
    void deveBuscarMultiplosGruposDoUsuario() {
        // When - Maria est√° em "managers" e "users"
        List<String> grupos = usuarioLdapService.buscarGruposDoUsuario("maria");

        // Then
        assertEquals(2, grupos.size());
        assertTrue(grupos.containsAll(List.of("managers", "users")));
    }
}
```

---

## üê≥ Testcontainers OpenLDAP

### Configura√ß√£o com Container Real

```java
@Testcontainers
@SpringBootTest
public abstract class AbstractOpenLdapTest {

    @Container
    static GenericContainer<?> openldap = new GenericContainer<>("osixia/openldap:1.5.0")
            .withEnv("LDAP_ORGANISATION", "Empresa")
            .withEnv("LDAP_DOMAIN", "empresa.com")
            .withEnv("LDAP_ADMIN_PASSWORD", "admin")
            .withExposedPorts(389, 636)
            .withCopyFileToContainer(
                MountableFile.forClasspathResource("test-data.ldif"),
                "/container/service/slapd/assets/config/bootstrap/ldif/custom/test-data.ldif"
            );

    @DynamicPropertySource
    static void configureProperties(DynamicPropertyRegistry registry) {
        registry.add("spring.ldap.urls",
            () -> "ldap://" + openldap.getHost() + ":" + openldap.getMappedPort(389));
        registry.add("spring.ldap.base", () -> "dc=empresa,dc=com");
        registry.add("spring.ldap.username", () -> "cn=admin,dc=empresa,dc=com");
        registry.add("spring.ldap.password", () -> "admin");
    }
}
```

### Teste com OpenLDAP Real

```java
@Testcontainers
@SpringBootTest
@AutoConfigureMockMvc
class OpenLdapAuthenticationTest extends AbstractOpenLdapTest {

    @Autowired
    private MockMvc mockMvc;

    @Test
    @DisplayName("Deve autenticar com OpenLDAP real (Testcontainers)")
    void deveAutenticarComOpenLdapReal() throws Exception {
        mockMvc.perform(get("/api/perfil")
                .with(httpBasic("joao", "senha123")))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.username").value("joao"));
    }
}
```

---

## üîÑ Sincroniza√ß√£o de Usu√°rios

### Service de Sincroniza√ß√£o

```java
@Service
@RequiredArgsConstructor
@Slf4j
public class UsuarioSyncService {

    private final UsuarioLdapService usuarioLdapService;
    private final UsuarioRepository usuarioRepository;

    @Scheduled(cron = "0 0 2 * * *")  // 2h da manh√£
    public void sincronizarUsuarios() {
        log.info("Iniciando sincroniza√ß√£o de usu√°rios LDAP");

        List<UsuarioDTO> usuariosLdap = usuarioLdapService.buscarTodos();

        int sincronizados = 0;
        int criados = 0;
        int atualizados = 0;

        for (UsuarioDTO usuarioLdap : usuariosLdap) {
            Optional<Usuario> usuarioExistente = usuarioRepository.findByUsername(usuarioLdap.getUid());

            if (usuarioExistente.isPresent()) {
                // Atualiza
                Usuario usuario = usuarioExistente.get();
                usuario.setNome(usuarioLdap.getNome());
                usuario.setEmail(usuarioLdap.getEmail());
                usuarioRepository.save(usuario);
                atualizados++;
            } else {
                // Cria novo
                Usuario usuario = new Usuario();
                usuario.setUsername(usuarioLdap.getUid());
                usuario.setNome(usuarioLdap.getNome());
                usuario.setEmail(usuarioLdap.getEmail());
                usuarioRepository.save(usuario);
                criados++;
            }

            sincronizados++;
        }

        log.info("Sincroniza√ß√£o conclu√≠da: {} usu√°rios (criados={}, atualizados={})",
            sincronizados, criados, atualizados);
    }
}
```

### Testando Sincroniza√ß√£o

```java
@SpringBootTest
class UsuarioSyncServiceTest extends AbstractLdapTest {

    @Autowired
    private UsuarioSyncService usuarioSyncService;

    @Autowired
    private UsuarioRepository usuarioRepository;

    @BeforeEach
    void setUp() {
        usuarioRepository.deleteAll();
    }

    @Test
    @DisplayName("Deve sincronizar usu√°rios do LDAP para o banco")
    void deveSincronizarUsuariosDoLdapParaBanco() {
        // Given - Banco vazio
        assertEquals(0, usuarioRepository.count());

        // When
        usuarioSyncService.sincronizarUsuarios();

        // Then
        assertEquals(3, usuarioRepository.count());

        Optional<Usuario> joao = usuarioRepository.findByUsername("joao");
        assertTrue(joao.isPresent());
        assertEquals("Jo√£o Silva", joao.get().getNome());
        assertEquals("joao@empresa.com", joao.get().getEmail());
    }

    @Test
    @DisplayName("Deve atualizar usu√°rios existentes na sincroniza√ß√£o")
    void deveAtualizarUsuariosExistentes() {
        // Given - Usu√°rio com dados antigos
        Usuario joao = new Usuario();
        joao.setUsername("joao");
        joao.setNome("Jo√£o Antigo");
        joao.setEmail("joao.antigo@empresa.com");
        usuarioRepository.save(joao);

        // When - Sincroniza (dados do LDAP s√£o mais recentes)
        usuarioSyncService.sincronizarUsuarios();

        // Then - Dados atualizados
        Usuario joaoAtualizado = usuarioRepository.findByUsername("joao").get();
        assertEquals("Jo√£o Silva", joaoAtualizado.getNome());
        assertEquals("joao@empresa.com", joaoAtualizado.getEmail());
    }

    @Test
    @DisplayName("Deve criar apenas usu√°rios novos sem duplicar existentes")
    void deveCriarApenasUsuariosNovos() {
        // Given - J√° existe 1 usu√°rio
        Usuario maria = new Usuario();
        maria.setUsername("maria");
        maria.setNome("Maria Santos");
        maria.setEmail("maria@empresa.com");
        usuarioRepository.save(maria);

        assertEquals(1, usuarioRepository.count());

        // When
        usuarioSyncService.sincronizarUsuarios();

        // Then - Total de 3 (n√£o duplicou Maria)
        assertEquals(3, usuarioRepository.count());
    }
}
```

---

## üß™ Testando Filtros LDAP Complexos

```java
@Service
@RequiredArgsConstructor
public class UsuarioLdapAdvancedService {

    private final LdapTemplate ldapTemplate;

    public List<UsuarioDTO> buscarPorNome(String nome) {
        LdapQuery query = LdapQueryBuilder.query()
                .base("ou=users")
                .where("objectClass").is("inetOrgPerson")
                .and("cn").like("*" + nome + "*");

        return ldapTemplate.search(query, new UsuarioAttributesMapper());
    }

    public List<UsuarioDTO> buscarPorDepartamento(String departamento) {
        LdapQuery query = LdapQueryBuilder.query()
                .base("ou=users")
                .where("objectClass").is("inetOrgPerson")
                .and("departmentNumber").is(departamento);

        return ldapTemplate.search(query, new UsuarioAttributesMapper());
    }

    public List<UsuarioDTO> buscarAtivos() {
        // Busca usu√°rios sem atributo "accountDisabled"
        LdapQuery query = LdapQueryBuilder.query()
                .base("ou=users")
                .where("objectClass").is("inetOrgPerson")
                .and(new NotPresentFilter("accountDisabled"));

        return ldapTemplate.search(query, new UsuarioAttributesMapper());
    }
}
```

### Testando Filtros

```java
@SpringBootTest
class UsuarioLdapAdvancedServiceTest extends AbstractLdapTest {

    @Autowired
    private UsuarioLdapAdvancedService usuarioService;

    @Test
    @DisplayName("Deve buscar usu√°rios por nome com LIKE")
    void deveBuscarPorNomeComLike() {
        // When - Busca por "Silva"
        List<UsuarioDTO> usuarios = usuarioService.buscarPorNome("Silva");

        // Then - Encontra "Jo√£o Silva"
        assertEquals(1, usuarios.size());
        assertEquals("joao", usuarios.get(0).getUid());
    }

    @Test
    @DisplayName("Deve buscar usu√°rios ativos")
    void deveBuscarUsuariosAtivos() {
        // When
        List<UsuarioDTO> usuarios = usuarioService.buscarAtivos();

        // Then - Todos os 3 usu√°rios est√£o ativos (nenhum tem accountDisabled)
        assertEquals(3, usuarios.size());
    }
}
```

---

## üìã Boas Pr√°ticas

### ‚úÖ Recomenda√ß√µes

```java
// ‚úÖ Use Embedded LDAP para testes r√°pidos
InMemoryDirectoryServer ldapServer = new InMemoryDirectoryServer(config);

// ‚úÖ Use Testcontainers OpenLDAP para testes realistas
@Container
static GenericContainer<?> openldap = new GenericContainer<>("osixia/openldap:1.5.0");

// ‚úÖ Carregue dados de teste via LDIF
ldapServer.importFromLDIF(true, "test-data.ldif");

// ‚úÖ Use httpBasic() para autentica√ß√£o em testes
mockMvc.perform(get("/api/perfil")
    .with(httpBasic("joao", "senha123")))

// ‚úÖ Valide mapeamento de grupos ‚Üí roles
assertTrue(json.contains("ROLE_ADMINS"));

// ‚úÖ Teste autentica√ß√£o E autoriza√ß√£o
mockMvc.perform(get("/api/admin/usuarios")
    .with(httpBasic("user", "senha")))
    .andExpect(status().isForbidden());

// ‚úÖ Cleanup entre testes
@BeforeEach
void setUp() {
    usuarioRepository.deleteAll();
}

// ‚úÖ Teste sincroniza√ß√£o de usu√°rios
usuarioSyncService.sincronizarUsuarios();
assertEquals(3, usuarioRepository.count());
```

### ‚ùå Anti-Patterns

```java
// ‚ùå Hardcoded credentials
mockMvc.perform(get("/api/perfil")
    .with(httpBasic("admin", "admin123")))  // ‚ùå

// ‚úÖ Use vari√°veis ou constantes
private static final String ADMIN_USER = "admin";
private static final String ADMIN_PASSWORD = "admin123";

// ‚ùå N√£o testar autoriza√ß√£o (apenas autentica√ß√£o)
// Teste apenas se login funciona, n√£o se tem permiss√£o

// ‚úÖ Teste ambos
mockMvc.perform(get("/api/admin/usuarios")
    .with(httpBasic("user", "senha")))
    .andExpect(status().isForbidden());  // Autenticado mas sem permiss√£o

// ‚ùå LDIF mal formatado
dn: uid=joao,ou=users
cn: Jo√£o
// ‚ùå Falta objectClass, sn, etc

// ‚úÖ LDIF completo
dn: uid=joao,ou=users,dc=empresa,dc=com
objectClass: inetOrgPerson
cn: Jo√£o Silva
sn: Silva
uid: joao

// ‚ùå N√£o limpar estado entre testes
// Usu√°rios sincronizados em teste anterior interferem

// ‚úÖ Cleanup no @BeforeEach
usuarioRepository.deleteAll();
```

---

## üéØ Quando Usar Cada Abordagem?

| Cen√°rio                     | Embedded LDAP | Testcontainers OpenLDAP |
| --------------------------- | ------------- | ----------------------- |
| Teste unit√°rio r√°pido       | ‚úÖ Sim        | ‚ùå N√£o                  |
| Teste de integra√ß√£o real    | ‚ö†Ô∏è Limitado   | ‚úÖ Sim                  |
| CI/CD                       | ‚úÖ Sim        | ‚úÖ Sim                  |
| Paridade com produ√ß√£o       | ‚ö†Ô∏è Limitado   | ‚úÖ Sim                  |
| Performance                 | ‚úÖ R√°pido     | ‚ö†Ô∏è Mais lento           |
| Simular OpenLDAP espec√≠fico | ‚ùå N√£o        | ‚úÖ Sim                  |

---

## üìù Resumo

**Testes de LDAP** garantem:

- ‚úÖ **Embedded LDAP**: Testes r√°pidos em mem√≥ria
- ‚úÖ **Testcontainers OpenLDAP**: LDAP real para integra√ß√£o
- ‚úÖ **Autentica√ß√£o**: Validar login com credenciais LDAP
- ‚úÖ **Autoriza√ß√£o**: Validar grupos ‚Üí roles ‚Üí permiss√µes
- ‚úÖ **Queries LDAP**: Buscar usu√°rios, grupos, filtros
- ‚úÖ **Sincroniza√ß√£o**: Importar usu√°rios LDAP ‚Üí banco
- ‚úÖ **Spring Security**: Integra√ß√£o completa
- ‚úÖ **LDIF**: Dados de teste estruturados

**Regra de ouro:** Use **Embedded LDAP** para testes **unit√°rios r√°pidos** e **Testcontainers OpenLDAP** para testes de **integra√ß√£o realistas** com paridade de produ√ß√£o.
