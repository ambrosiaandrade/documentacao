# 03.6 Testes de Controllers (REST API) [AVAN√áADO] üåê

## üéØ Objetivo

Dominar **testes de controllers** com **@WebMvcTest**, **MockMvc**, **REST API testing**, **valida√ß√£o de JSON**, **c√≥digos HTTP**, **tratamento de exce√ß√µes** e **content negotiation**.

---

## üìö Tipos de Testes de Controller

### 1. Unit Tests (@WebMvcTest)

Testa **controller isoladamente** sem subir contexto completo.

### 2. Integration Tests (@SpringBootTest)

Testa **fluxo completo** (controller ‚Üí service ‚Üí repository).

### 3. API Contract Tests

Valida **contratos de API** (request/response schemas).

---

## üèóÔ∏è Configura√ß√£o

### pom.xml

```xml
<dependencies>
    <!-- Spring Boot Web -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>

    <!-- Spring Boot Test -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-test</artifactId>
        <scope>test</scope>
    </dependency>

    <!-- Validation -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-validation</artifactId>
    </dependency>

    <!-- JSON Path -->
    <dependency>
        <groupId>com.jayway.jsonpath</groupId>
        <artifactId>json-path</artifactId>
        <scope>test</scope>
    </dependency>
</dependencies>
```

---

## üß™ @WebMvcTest - Controller Unit√°rio

### Controller B√°sico

```java
@RestController
@RequestMapping("/api/clientes")
public class ClienteController {

    private final ClienteService clienteService;

    public ClienteController(ClienteService clienteService) {
        this.clienteService = clienteService;
    }

    @GetMapping
    public List<ClienteDTO> listar() {
        return clienteService.listarTodos();
    }

    @GetMapping("/{id}")
    public ResponseEntity<ClienteDTO> buscarPorId(@PathVariable Long id) {
        return clienteService.buscarPorId(id)
            .map(ResponseEntity::ok)
            .orElse(ResponseEntity.notFound().build());
    }

    @PostMapping
    @ResponseStatus(HttpStatus.CREATED)
    public ClienteDTO criar(@Valid @RequestBody ClienteDTO dto) {
        return clienteService.criar(dto);
    }

    @PutMapping("/{id}")
    public ResponseEntity<ClienteDTO> atualizar(
        @PathVariable Long id,
        @Valid @RequestBody ClienteDTO dto
    ) {
        return clienteService.atualizar(id, dto)
            .map(ResponseEntity::ok)
            .orElse(ResponseEntity.notFound().build());
    }

    @DeleteMapping("/{id}")
    @ResponseStatus(HttpStatus.NO_CONTENT)
    public void deletar(@PathVariable Long id) {
        clienteService.deletar(id);
    }
}
```

### Teste Unit√°rio com @WebMvcTest

```java
@WebMvcTest(ClienteController.class)
class ClienteControllerTest {

    @Autowired
    private MockMvc mockMvc;

    @MockBean
    private ClienteService clienteService;

    @Autowired
    private ObjectMapper objectMapper;

    @Test
    @DisplayName("GET /api/clientes - Deve retornar lista de clientes")
    void deveRetornarListaDeClientes() throws Exception {
        // Given
        List<ClienteDTO> clientes = List.of(
            new ClienteDTO(1L, "Jo√£o", "joao@mail.com"),
            new ClienteDTO(2L, "Maria", "maria@mail.com")
        );
        when(clienteService.listarTodos()).thenReturn(clientes);

        // When & Then
        mockMvc.perform(get("/api/clientes"))
            .andExpect(status().isOk())
            .andExpect(jsonPath("$", hasSize(2)))
            .andExpect(jsonPath("$[0].nome", is("Jo√£o")))
            .andExpect(jsonPath("$[1].nome", is("Maria")));

        verify(clienteService).listarTodos();
    }

    @Test
    @DisplayName("GET /api/clientes/{id} - Deve retornar cliente existente")
    void deveRetornarClienteExistente() throws Exception {
        // Given
        Long id = 1L;
        ClienteDTO cliente = new ClienteDTO(id, "Jo√£o", "joao@mail.com");
        when(clienteService.buscarPorId(id)).thenReturn(Optional.of(cliente));

        // When & Then
        mockMvc.perform(get("/api/clientes/{id}", id))
            .andExpect(status().isOk())
            .andExpect(jsonPath("$.id", is(1)))
            .andExpect(jsonPath("$.nome", is("Jo√£o")))
            .andExpect(jsonPath("$.email", is("joao@mail.com")));

        verify(clienteService).buscarPorId(id);
    }

    @Test
    @DisplayName("GET /api/clientes/{id} - Deve retornar 404 quando n√£o existe")
    void deveRetornar404QuandoNaoExiste() throws Exception {
        // Given
        Long id = 999L;
        when(clienteService.buscarPorId(id)).thenReturn(Optional.empty());

        // When & Then
        mockMvc.perform(get("/api/clientes/{id}", id))
            .andExpect(status().isNotFound());

        verify(clienteService).buscarPorId(id);
    }

    @Test
    @DisplayName("POST /api/clientes - Deve criar cliente com sucesso")
    void deveCriarClienteComSucesso() throws Exception {
        // Given
        ClienteDTO request = new ClienteDTO(null, "Jo√£o", "joao@mail.com");
        ClienteDTO response = new ClienteDTO(1L, "Jo√£o", "joao@mail.com");
        when(clienteService.criar(any())).thenReturn(response);

        // When & Then
        mockMvc.perform(post("/api/clientes")
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(request)))
            .andExpect(status().isCreated())
            .andExpect(jsonPath("$.id", is(1)))
            .andExpect(jsonPath("$.nome", is("Jo√£o")));

        verify(clienteService).criar(any());
    }

    @Test
    @DisplayName("PUT /api/clientes/{id} - Deve atualizar cliente existente")
    void deveAtualizarClienteExistente() throws Exception {
        // Given
        Long id = 1L;
        ClienteDTO request = new ClienteDTO(id, "Jo√£o Atualizado", "joao@mail.com");
        ClienteDTO response = new ClienteDTO(id, "Jo√£o Atualizado", "joao@mail.com");
        when(clienteService.atualizar(eq(id), any())).thenReturn(Optional.of(response));

        // When & Then
        mockMvc.perform(put("/api/clientes/{id}", id)
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(request)))
            .andExpect(status().isOk())
            .andExpect(jsonPath("$.nome", is("Jo√£o Atualizado")));

        verify(clienteService).atualizar(eq(id), any());
    }

    @Test
    @DisplayName("DELETE /api/clientes/{id} - Deve deletar cliente com sucesso")
    void deveDeletarClienteComSucesso() throws Exception {
        // Given
        Long id = 1L;
        doNothing().when(clienteService).deletar(id);

        // When & Then
        mockMvc.perform(delete("/api/clientes/{id}", id))
            .andExpect(status().isNoContent());

        verify(clienteService).deletar(id);
    }
}
```

---

## ‚úÖ Valida√ß√£o de Bean Validation

### DTO com Valida√ß√µes

```java
public class ClienteDTO {

    private Long id;

    @NotBlank(message = "Nome √© obrigat√≥rio")
    @Size(min = 3, max = 100, message = "Nome deve ter entre 3 e 100 caracteres")
    private String nome;

    @NotBlank(message = "Email √© obrigat√≥rio")
    @Email(message = "Email inv√°lido")
    private String email;

    @NotBlank(message = "CPF √© obrigat√≥rio")
    @Pattern(regexp = "\\d{11}", message = "CPF deve ter 11 d√≠gitos")
    private String cpf;

    @Min(value = 18, message = "Idade m√≠nima √© 18 anos")
    @Max(value = 120, message = "Idade m√°xima √© 120 anos")
    private Integer idade;
}
```

### Testando Valida√ß√µes

```java
@WebMvcTest(ClienteController.class)
class ClienteControllerValidationTest {

    @Autowired
    private MockMvc mockMvc;

    @MockBean
    private ClienteService clienteService;

    @Autowired
    private ObjectMapper objectMapper;

    @Test
    @DisplayName("POST - Deve retornar 400 quando nome est√° vazio")
    void deveRetornar400QuandoNomeVazio() throws Exception {
        // Given
        ClienteDTO request = new ClienteDTO(null, "", "joao@mail.com", "12345678901", 25);

        // When & Then
        mockMvc.perform(post("/api/clientes")
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(request)))
            .andExpect(status().isBadRequest())
            .andExpect(jsonPath("$.errors.nome", containsString("Nome √© obrigat√≥rio")));

        verify(clienteService, never()).criar(any());
    }

    @Test
    @DisplayName("POST - Deve retornar 400 quando email inv√°lido")
    void deveRetornar400QuandoEmailInvalido() throws Exception {
        // Given
        ClienteDTO request = new ClienteDTO(null, "Jo√£o", "email-invalido", "12345678901", 25);

        // When & Then
        mockMvc.perform(post("/api/clientes")
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(request)))
            .andExpect(status().isBadRequest())
            .andExpect(jsonPath("$.errors.email", containsString("Email inv√°lido")));
    }

    @Test
    @DisplayName("POST - Deve retornar 400 quando CPF n√£o tem 11 d√≠gitos")
    void deveRetornar400QuandoCpfInvalido() throws Exception {
        // Given
        ClienteDTO request = new ClienteDTO(null, "Jo√£o", "joao@mail.com", "123", 25);

        // When & Then
        mockMvc.perform(post("/api/clientes")
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(request)))
            .andExpect(status().isBadRequest())
            .andExpect(jsonPath("$.errors.cpf", containsString("CPF deve ter 11 d√≠gitos")));
    }

    @Test
    @DisplayName("POST - Deve retornar 400 quando idade menor que 18")
    void deveRetornar400QuandoIdadeMenorQue18() throws Exception {
        // Given
        ClienteDTO request = new ClienteDTO(null, "Jo√£o", "joao@mail.com", "12345678901", 17);

        // When & Then
        mockMvc.perform(post("/api/clientes")
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(request)))
            .andExpect(status().isBadRequest())
            .andExpect(jsonPath("$.errors.idade", containsString("Idade m√≠nima √© 18 anos")));
    }

    @Test
    @DisplayName("POST - Deve retornar m√∫ltiplos erros de valida√ß√£o")
    void deveRetornarMultiplosErrosDeValidacao() throws Exception {
        // Given - Request inv√°lido (todos os campos com erro)
        ClienteDTO request = new ClienteDTO(null, "", "email-invalido", "123", 17);

        // When & Then
        mockMvc.perform(post("/api/clientes")
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(request)))
            .andExpect(status().isBadRequest())
            .andExpect(jsonPath("$.errors.nome").exists())
            .andExpect(jsonPath("$.errors.email").exists())
            .andExpect(jsonPath("$.errors.cpf").exists())
            .andExpect(jsonPath("$.errors.idade").exists());
    }
}
```

---

## üö® Tratamento de Exce√ß√µes

### Exception Handler

```java
@RestControllerAdvice
public class GlobalExceptionHandler {

    @ExceptionHandler(MethodArgumentNotValidException.class)
    @ResponseStatus(HttpStatus.BAD_REQUEST)
    public ErrorResponse handleValidationException(MethodArgumentNotValidException ex) {
        Map<String, String> errors = new HashMap<>();

        ex.getBindingResult().getFieldErrors().forEach(error -> {
            errors.put(error.getField(), error.getDefaultMessage());
        });

        return new ErrorResponse("Erro de valida√ß√£o", errors);
    }

    @ExceptionHandler(ClienteNotFoundException.class)
    @ResponseStatus(HttpStatus.NOT_FOUND)
    public ErrorResponse handleClienteNotFoundException(ClienteNotFoundException ex) {
        return new ErrorResponse(ex.getMessage(), Map.of());
    }

    @ExceptionHandler(EmailJaCadastradoException.class)
    @ResponseStatus(HttpStatus.CONFLICT)
    public ErrorResponse handleEmailJaCadastradoException(EmailJaCadastradoException ex) {
        return new ErrorResponse(ex.getMessage(), Map.of());
    }

    @ExceptionHandler(Exception.class)
    @ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)
    public ErrorResponse handleGenericException(Exception ex) {
        return new ErrorResponse("Erro interno do servidor", Map.of());
    }
}
```

### Testando Exception Handler

```java
@WebMvcTest(ClienteController.class)
@Import(GlobalExceptionHandler.class)
class ClienteControllerExceptionTest {

    @Autowired
    private MockMvc mockMvc;

    @MockBean
    private ClienteService clienteService;

    @Test
    @DisplayName("Deve retornar 404 quando cliente n√£o existe")
    void deveRetornar404QuandoClienteNaoExiste() throws Exception {
        // Given
        Long id = 999L;
        when(clienteService.buscarPorId(id))
            .thenThrow(new ClienteNotFoundException("Cliente n√£o encontrado"));

        // When & Then
        mockMvc.perform(get("/api/clientes/{id}", id))
            .andExpect(status().isNotFound())
            .andExpect(jsonPath("$.message", is("Cliente n√£o encontrado")));
    }

    @Test
    @DisplayName("Deve retornar 409 quando email j√° cadastrado")
    void deveRetornar409QuandoEmailJaCadastrado() throws Exception {
        // Given
        ClienteDTO request = new ClienteDTO(null, "Jo√£o", "joao@mail.com", "12345678901", 25);
        when(clienteService.criar(any()))
            .thenThrow(new EmailJaCadastradoException("Email j√° cadastrado"));

        // When & Then
        mockMvc.perform(post("/api/clientes")
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(request)))
            .andExpect(status().isConflict())
            .andExpect(jsonPath("$.message", is("Email j√° cadastrado")));
    }

    @Test
    @DisplayName("Deve retornar 500 quando erro inesperado ocorre")
    void deveRetornar500QuandoErroInesperado() throws Exception {
        // Given
        when(clienteService.listarTodos())
            .thenThrow(new RuntimeException("Erro inesperado"));

        // When & Then
        mockMvc.perform(get("/api/clientes"))
            .andExpect(status().isInternalServerError())
            .andExpect(jsonPath("$.message", is("Erro interno do servidor")));
    }
}
```

---

## üîç JSONPath Avan√ßado

### Valida√ß√µes JSONPath Complexas

```java
@Test
@DisplayName("Deve validar JSON complexo com JSONPath")
void deveValidarJsonComplexoComJsonPath() throws Exception {
    // Given
    PedidoDTO pedido = new PedidoDTO(
        1L,
        new ClienteDTO(1L, "Jo√£o", "joao@mail.com"),
        List.of(
            new ItemDTO("PROD-001", "Notebook", 2, new BigDecimal("3000.00")),
            new ItemDTO("PROD-002", "Mouse", 3, new BigDecimal("50.00"))
        ),
        new BigDecimal("6150.00")
    );
    when(pedidoService.buscarPorId(1L)).thenReturn(Optional.of(pedido));

    // When & Then
    mockMvc.perform(get("/api/pedidos/1"))
        .andExpect(status().isOk())

        // Valida root
        .andExpect(jsonPath("$.id", is(1)))
        .andExpect(jsonPath("$.valorTotal", is(6150.00)))

        // Valida cliente nested
        .andExpect(jsonPath("$.cliente.id", is(1)))
        .andExpect(jsonPath("$.cliente.nome", is("Jo√£o")))
        .andExpect(jsonPath("$.cliente.email", is("joao@mail.com")))

        // Valida array de items
        .andExpect(jsonPath("$.items", hasSize(2)))

        // Valida primeiro item
        .andExpect(jsonPath("$.items[0].codigo", is("PROD-001")))
        .andExpect(jsonPath("$.items[0].nome", is("Notebook")))
        .andExpect(jsonPath("$.items[0].quantidade", is(2)))
        .andExpect(jsonPath("$.items[0].preco", is(3000.00)))

        // Valida segundo item
        .andExpect(jsonPath("$.items[1].codigo", is("PROD-002")))
        .andExpect(jsonPath("$.items[1].quantidade", is(3)))

        // Valida com filtros
        .andExpect(jsonPath("$.items[?(@.codigo == 'PROD-001')].nome", contains("Notebook")))
        .andExpect(jsonPath("$.items[?(@.preco > 100)].nome", contains("Notebook")));
}
```

### JSONPath com Arrays

```java
@Test
@DisplayName("Deve validar arrays com JSONPath")
void deveValidarArraysComJsonPath() throws Exception {
    // Given
    List<ClienteDTO> clientes = List.of(
        new ClienteDTO(1L, "Jo√£o", "joao@mail.com", "12345678901", 25),
        new ClienteDTO(2L, "Maria", "maria@mail.com", "98765432109", 30),
        new ClienteDTO(3L, "Pedro", "pedro@mail.com", "11111111111", 20)
    );
    when(clienteService.listarTodos()).thenReturn(clientes);

    // When & Then
    mockMvc.perform(get("/api/clientes"))
        .andExpect(status().isOk())

        // Tamanho do array
        .andExpect(jsonPath("$", hasSize(3)))
        .andExpect(jsonPath("$.length()", is(3)))

        // Validar elementos espec√≠ficos
        .andExpect(jsonPath("$[0].nome", is("Jo√£o")))
        .andExpect(jsonPath("$[1].nome", is("Maria")))
        .andExpect(jsonPath("$[2].nome", is("Pedro")))

        // Validar com filtros
        .andExpect(jsonPath("$[?(@.idade > 25)]", hasSize(1)))
        .andExpect(jsonPath("$[?(@.idade > 25)][0].nome", is("Maria")))

        // Validar todos os elementos
        .andExpect(jsonPath("$[*].email").exists())
        .andExpect(jsonPath("$[*].cpf").exists())

        // Validar range
        .andExpect(jsonPath("$[0:2]", hasSize(2)));  // Primeiros 2 elementos
}
```

---

## üìä Content Negotiation (JSON/XML)

### Controller com JSON e XML

```java
@RestController
@RequestMapping("/api/clientes")
public class ClienteController {

    @GetMapping(produces = {MediaType.APPLICATION_JSON_VALUE, MediaType.APPLICATION_XML_VALUE})
    public List<ClienteDTO> listar() {
        return clienteService.listarTodos();
    }

    @PostMapping(
        consumes = {MediaType.APPLICATION_JSON_VALUE, MediaType.APPLICATION_XML_VALUE},
        produces = {MediaType.APPLICATION_JSON_VALUE, MediaType.APPLICATION_XML_VALUE}
    )
    @ResponseStatus(HttpStatus.CREATED)
    public ClienteDTO criar(@Valid @RequestBody ClienteDTO dto) {
        return clienteService.criar(dto);
    }
}
```

### Testando Content Negotiation

```java
@WebMvcTest(ClienteController.class)
class ClienteControllerContentNegotiationTest {

    @Autowired
    private MockMvc mockMvc;

    @MockBean
    private ClienteService clienteService;

    @Test
    @DisplayName("Deve retornar JSON quando Accept √© application/json")
    void deveRetornarJsonQuandoAcceptJson() throws Exception {
        // Given
        List<ClienteDTO> clientes = List.of(new ClienteDTO(1L, "Jo√£o", "joao@mail.com"));
        when(clienteService.listarTodos()).thenReturn(clientes);

        // When & Then
        mockMvc.perform(get("/api/clientes")
                .accept(MediaType.APPLICATION_JSON))
            .andExpect(status().isOk())
            .andExpect(content().contentType(MediaType.APPLICATION_JSON))
            .andExpect(jsonPath("$[0].nome", is("Jo√£o")));
    }

    @Test
    @DisplayName("Deve retornar XML quando Accept √© application/xml")
    void deveRetornarXmlQuandoAcceptXml() throws Exception {
        // Given
        List<ClienteDTO> clientes = List.of(new ClienteDTO(1L, "Jo√£o", "joao@mail.com"));
        when(clienteService.listarTodos()).thenReturn(clientes);

        // When & Then
        mockMvc.perform(get("/api/clientes")
                .accept(MediaType.APPLICATION_XML))
            .andExpect(status().isOk())
            .andExpect(content().contentType(MediaType.APPLICATION_XML))
            .andExpect(xpath("/List/item/nome").string("Jo√£o"));
    }

    @Test
    @DisplayName("Deve aceitar JSON no POST")
    void deveAceitarJsonNoPost() throws Exception {
        // Given
        ClienteDTO request = new ClienteDTO(null, "Jo√£o", "joao@mail.com");
        ClienteDTO response = new ClienteDTO(1L, "Jo√£o", "joao@mail.com");
        when(clienteService.criar(any())).thenReturn(response);

        // When & Then
        mockMvc.perform(post("/api/clientes")
                .contentType(MediaType.APPLICATION_JSON)
                .content("{\"nome\":\"Jo√£o\",\"email\":\"joao@mail.com\"}"))
            .andExpect(status().isCreated());
    }

    @Test
    @DisplayName("Deve retornar 415 quando Content-Type n√£o suportado")
    void deveRetornar415QuandoContentTypeNaoSuportado() throws Exception {
        // When & Then
        mockMvc.perform(post("/api/clientes")
                .contentType(MediaType.TEXT_PLAIN)
                .content("texto simples"))
            .andExpect(status().isUnsupportedMediaType());
    }
}
```

---

## üîê Testando Headers e Query Params

### Controller com Headers e Query Params

```java
@RestController
@RequestMapping("/api/clientes")
public class ClienteController {

    @GetMapping("/buscar")
    public List<ClienteDTO> buscar(
        @RequestParam(required = false) String nome,
        @RequestParam(required = false) String email,
        @RequestParam(defaultValue = "0") int page,
        @RequestParam(defaultValue = "10") int size,
        @RequestParam(defaultValue = "nome") String sortBy
    ) {
        return clienteService.buscar(nome, email, page, size, sortBy);
    }

    @PostMapping
    public ResponseEntity<ClienteDTO> criar(
        @RequestBody ClienteDTO dto,
        @RequestHeader("X-Request-ID") String requestId,
        @RequestHeader(value = "X-User-Agent", defaultValue = "unknown") String userAgent
    ) {
        ClienteDTO criado = clienteService.criar(dto);

        return ResponseEntity
            .status(HttpStatus.CREATED)
            .header("X-Request-ID", requestId)
            .header("Location", "/api/clientes/" + criado.getId())
            .body(criado);
    }
}
```

### Testando Query Params

```java
@Test
@DisplayName("Deve buscar clientes com query params")
void deveBuscarClientesComQueryParams() throws Exception {
    // Given
    List<ClienteDTO> clientes = List.of(new ClienteDTO(1L, "Jo√£o Silva", "joao@mail.com"));
    when(clienteService.buscar("Jo√£o", null, 0, 10, "nome")).thenReturn(clientes);

    // When & Then
    mockMvc.perform(get("/api/clientes/buscar")
            .param("nome", "Jo√£o")
            .param("page", "0")
            .param("size", "10")
            .param("sortBy", "nome"))
        .andExpect(status().isOk())
        .andExpect(jsonPath("$[0].nome", is("Jo√£o Silva")));

    verify(clienteService).buscar("Jo√£o", null, 0, 10, "nome");
}

@Test
@DisplayName("Deve usar valores padr√£o quando query params n√£o fornecidos")
void deveUsarValoresPadraoQuandoQueryParamsNaoFornecidos() throws Exception {
    // Given
    when(clienteService.buscar(null, null, 0, 10, "nome")).thenReturn(List.of());

    // When & Then
    mockMvc.perform(get("/api/clientes/buscar"))
        .andExpect(status().isOk());

    verify(clienteService).buscar(null, null, 0, 10, "nome");
}
```

### Testando Headers

```java
@Test
@DisplayName("Deve processar headers customizados")
void deveProcessarHeadersCustomizados() throws Exception {
    // Given
    ClienteDTO request = new ClienteDTO(null, "Jo√£o", "joao@mail.com");
    ClienteDTO response = new ClienteDTO(1L, "Jo√£o", "joao@mail.com");
    when(clienteService.criar(any())).thenReturn(response);

    // When & Then
    mockMvc.perform(post("/api/clientes")
            .contentType(MediaType.APPLICATION_JSON)
            .content(objectMapper.writeValueAsString(request))
            .header("X-Request-ID", "abc-123")
            .header("X-User-Agent", "MyApp/1.0"))
        .andExpect(status().isCreated())
        .andExpect(header().string("X-Request-ID", "abc-123"))
        .andExpect(header().string("Location", "/api/clientes/1"));
}

@Test
@DisplayName("Deve retornar 400 quando header obrigat√≥rio n√£o fornecido")
void deveRetornar400QuandoHeaderObrigatorioNaoFornecido() throws Exception {
    // Given
    ClienteDTO request = new ClienteDTO(null, "Jo√£o", "joao@mail.com");

    // When & Then
    mockMvc.perform(post("/api/clientes")
            .contentType(MediaType.APPLICATION_JSON)
            .content(objectMapper.writeValueAsString(request)))
        // Sem X-Request-ID
        .andExpect(status().isBadRequest());
}
```

---

## üß™ Testes de Integra√ß√£o com @SpringBootTest

### Teste de Integra√ß√£o Completo

```java
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@Testcontainers
class ClienteControllerIntegrationTest {

    @Container
    static PostgreSQLContainer<?> postgres = new PostgreSQLContainer<>("postgres:15");

    @DynamicPropertySource
    static void configureProperties(DynamicPropertyRegistry registry) {
        registry.add("spring.datasource.url", postgres::getJdbcUrl);
        registry.add("spring.datasource.username", postgres::getUsername);
        registry.add("spring.datasource.password", postgres::getPassword);
    }

    @Autowired
    private TestRestTemplate restTemplate;

    @Autowired
    private ClienteRepository clienteRepository;

    @BeforeEach
    void setUp() {
        clienteRepository.deleteAll();
    }

    @Test
    @DisplayName("Deve criar e buscar cliente (fluxo completo)")
    void deveCriarEBuscarClienteFluxoCompleto() {
        // Given - Cria cliente
        ClienteDTO request = new ClienteDTO(null, "Jo√£o", "joao@mail.com", "12345678901", 25);

        // When - POST /api/clientes
        ResponseEntity<ClienteDTO> createResponse = restTemplate.postForEntity(
            "/api/clientes",
            request,
            ClienteDTO.class
        );

        // Then - Valida cria√ß√£o
        assertEquals(HttpStatus.CREATED, createResponse.getStatusCode());
        assertNotNull(createResponse.getBody());
        Long clienteId = createResponse.getBody().getId();

        // When - GET /api/clientes/{id}
        ResponseEntity<ClienteDTO> getResponse = restTemplate.getForEntity(
            "/api/clientes/" + clienteId,
            ClienteDTO.class
        );

        // Then - Valida busca
        assertEquals(HttpStatus.OK, getResponse.getStatusCode());
        assertEquals("Jo√£o", getResponse.getBody().getNome());

        // Valida que foi salvo no banco
        assertTrue(clienteRepository.existsById(clienteId));
    }

    @Test
    @DisplayName("Deve atualizar cliente existente")
    void deveAtualizarClienteExistente() {
        // Given - Cliente existente
        Cliente cliente = clienteRepository.save(
            new Cliente("Jo√£o", "joao@mail.com", "12345678901", 25)
        );

        // When - PUT /api/clientes/{id}
        ClienteDTO update = new ClienteDTO(null, "Jo√£o Atualizado", "joao@mail.com", "12345678901", 30);
        restTemplate.put("/api/clientes/" + cliente.getId(), update);

        // Then - Valida atualiza√ß√£o no banco
        Cliente atualizado = clienteRepository.findById(cliente.getId()).get();
        assertEquals("Jo√£o Atualizado", atualizado.getNome());
        assertEquals(30, atualizado.getIdade());
    }

    @Test
    @DisplayName("Deve deletar cliente existente")
    void deveDeletarClienteExistente() {
        // Given - Cliente existente
        Cliente cliente = clienteRepository.save(
            new Cliente("Jo√£o", "joao@mail.com", "12345678901", 25)
        );

        // When - DELETE /api/clientes/{id}
        restTemplate.delete("/api/clientes/" + cliente.getId());

        // Then - Valida que foi deletado
        assertFalse(clienteRepository.existsById(cliente.getId()));
    }
}
```

---

## üìã Boas Pr√°ticas

### ‚úÖ Recomenda√ß√µes

```java
// ‚úÖ Use @WebMvcTest para testes unit√°rios
@WebMvcTest(ClienteController.class)

// ‚úÖ Mock apenas o service
@MockBean
private ClienteService clienteService;

// ‚úÖ Valide status HTTP
.andExpect(status().isOk())
.andExpect(status().isCreated())
.andExpect(status().isNotFound())

// ‚úÖ Valide JSON com JSONPath
.andExpect(jsonPath("$.nome", is("Jo√£o")))
.andExpect(jsonPath("$.items", hasSize(2)))

// ‚úÖ Teste valida√ß√µes de Bean Validation
@Test
void deveRetornar400QuandoNomeVazio() { ... }

// ‚úÖ Teste exception handlers
@Test
void deveRetornar404QuandoClienteNaoExiste() { ... }

// ‚úÖ Teste content negotiation (JSON/XML)
.accept(MediaType.APPLICATION_JSON)
.accept(MediaType.APPLICATION_XML)

// ‚úÖ Teste headers e query params
.header("X-Request-ID", "abc-123")
.param("page", "0")

// ‚úÖ Use testes de integra√ß√£o para fluxo completo
@SpringBootTest(webEnvironment = RANDOM_PORT)
```

### ‚ùå Anti-Patterns

```java
// ‚ùå N√£o usar @SpringBootTest para testes unit√°rios
@SpringBootTest  // ‚ùå Muito pesado para teste unit√°rio

// ‚úÖ Use @WebMvcTest
@WebMvcTest(ClienteController.class)

// ‚ùå N√£o mockar m√∫ltiplas camadas
@MockBean
private ClienteRepository repository;  // ‚ùå Mock apenas service

// ‚úÖ Mock apenas service
@MockBean
private ClienteService clienteService;

// ‚ùå N√£o validar apenas status
.andExpect(status().isOk());  // ‚ùå Muito gen√©rico

// ‚úÖ Valide tamb√©m o body
.andExpect(jsonPath("$.nome", is("Jo√£o")))

// ‚ùå Ignorar valida√ß√µes
// Sem testes para @Valid

// ‚úÖ Teste todas as valida√ß√µes
@Test
void deveRetornar400QuandoNomeVazio() { ... }

// ‚ùå Hard-coded JSON strings
.content("{\"nome\":\"Jo√£o\"}")  // ‚ùå Dif√≠cil manter

// ‚úÖ Use ObjectMapper
.content(objectMapper.writeValueAsString(request))
```

---

## üéØ Quando Usar Cada Abordagem?

| Cen√°rio                   | @WebMvcTest | @SpringBootTest |
| ------------------------- | ----------- | --------------- |
| Teste unit√°rio controller | ‚úÖ Sim      | ‚ùå N√£o          |
| Teste de integra√ß√£o       | ‚ùå N√£o      | ‚úÖ Sim          |
| Performance               | ‚úÖ R√°pido   | ‚ö†Ô∏è Lento        |
| Contexto completo         | ‚ùå N√£o      | ‚úÖ Sim          |
| Mock de service           | ‚úÖ Sim      | ‚ö†Ô∏è Opcional     |

---

## üìù Resumo

**Testes de Controllers** garantem:

- ‚úÖ **@WebMvcTest**: Testes unit√°rios r√°pidos de controllers
- ‚úÖ **MockMvc**: Simula requisi√ß√µes HTTP (GET/POST/PUT/DELETE)
- ‚úÖ **JSONPath**: Valida JSON response complexo
- ‚úÖ **Bean Validation**: Testa @Valid, @NotBlank, @Email, @Min/@Max
- ‚úÖ **Exception Handlers**: Testa @RestControllerAdvice
- ‚úÖ **Status Codes**: Valida 200, 201, 400, 404, 409, 500
- ‚úÖ **Content Negotiation**: Testa JSON/XML
- ‚úÖ **Headers/Query Params**: Testa @RequestHeader, @RequestParam
- ‚úÖ **Integration Tests**: Fluxo completo com @SpringBootTest

**Regra de ouro:** Use **@WebMvcTest** para testes unit√°rios r√°pidos e **@SpringBootTest** para testes de integra√ß√£o end-to-end.
